<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Random Forest — Train on a CSV</title>

  <!-- CSV parsing + charts + zip export -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg0:#070b16;
      --bg1:#0b1226;
      --panel:#0f1833;
      --panel2:#0c1430;
      --text:#eaf0ff;
      --muted:rgba(234,240,255,0.75);
      --muted2:rgba(234,240,255,0.55);
      --border:rgba(234,240,255,0.12);
      --border2:rgba(234,240,255,0.08);
      --primary:#6d28d9;
      --primary2:#8b5cf6;
      --good:#32d583;
      --warn:#fdb022;
      --bad:#f97066;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background-image:
        radial-gradient(1000px 550px at 20% 0%, rgba(109,40,217,0.22), transparent 60%),
        radial-gradient(900px 520px at 95% 10%, rgba(139,92,246,0.16), transparent 62%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 50%, var(--bg0) 100%);
      background-repeat: no-repeat, no-repeat, repeat-y;
      background-size: 100% 100%, 100% 100%, 100% 200vh;
      background-attachment: fixed, fixed, scroll;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px 60px}
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(7,11,22,0.92), rgba(7,11,22,0.72));
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--border2);
      padding:14px 16px;
      margin: -18px -16px 18px;
    }

    .topline{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      max-width:1200px;margin:0 auto;
    }

    h1{margin:0;font-size:24px;font-weight:750;letter-spacing:0.2px;line-height:1.15}
    .heroKicker{
      font-size:12px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(234,240,255,0.60);
      margin-bottom:8px;
    }
    .sub{
      margin-top:10px;
      color:rgba(234,240,255,0.78);
      font-size:14px;
      line-height:1.4;
      max-width:840px;
    }
    .heroPoints{
      margin-top:10px;
      color:rgba(234,240,255,0.62);
      font-size:12px;
      line-height:1.35;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .heroPoints span{
      padding:6px 10px;
      border:1px solid rgba(234,240,255,0.10);
      border-radius:999px;
      background:rgba(255,255,255,0.02);
    }
    .heroNote{
      margin-top:10px;
      color:rgba(234,240,255,0.55);
      font-size:12px;
      line-height:1.35;
      max-width:840px;
    }
    .textLinkBtn{
      border:0;
      background:transparent;
      padding:0;
      color:rgba(139,92,246,0.95);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .textLinkBtn:hover{ text-decoration: underline; }
    .textLinkBtn:focus{ outline: 2px solid rgba(139,92,246,0.55); outline-offset: 3px; border-radius: 6px; }

    .stepbar{
      max-width:1200px;
      margin:14px auto 0;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .stepper{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      flex:1;
      min-width:0;
    }
    .step{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border2);
      background:rgba(255,255,255,0.02);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      transition:120ms ease;
    }
    .step:hover{transform:translateY(-1px);border-color:rgba(234,240,255,0.16)}
    .step.locked{
      opacity:0.45;
      cursor:not-allowed;
    }
    .step.locked:hover{
      transform:none;
      border-color:rgba(234,240,255,0.12);
    }
    .step .dot{
      width:20px;height:20px;border-radius:50%;
      border:1px solid var(--border);
      display:grid;place-items:center;
      font-size:11px;color:var(--muted);
      background:rgba(255,255,255,0.02);
    }
    .step.active{
      border-color:rgba(139,92,246,0.55);
      background:rgba(139,92,246,0.12);
      color:rgba(234,240,255,0.92);
    }
    .step.active .dot{
      border-color:rgba(139,92,246,0.70);
      color:rgba(234,240,255,0.95);
      background:rgba(139,92,246,0.18);
    }
    .step.done{
      border-color:rgba(50,213,131,0.40);
      background:rgba(50,213,131,0.08);
      color:rgba(50,213,131,0.95);
    }
    .step.done .dot{
      border-color:rgba(50,213,131,0.55);
      color:rgba(50,213,131,0.95);
      background:rgba(50,213,131,0.10);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .grid > * { min-width: 0; }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      box-shadow: var(--shadow);
      border-radius:var(--radius);
      padding:14px;
    }

    .card h2{margin:0 0 10px;font-size:14px;color:rgba(234,240,255,0.92);letter-spacing:0.15px}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .muted2{color:var(--muted2);font-size:12px;line-height:1.35}
    .mono{font-family:var(--mono);font-size:12px;color:rgba(234,240,255,0.86)}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between}

    .btn{
      appearance:none;border:1px solid var(--border);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      padding:9px 12px;border-radius:12px;
      cursor:pointer;font-size:13px;
      transition:120ms ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,0.07)}
    .btn:disabled{opacity:0.45;cursor:not-allowed;transform:none}
    .btn.primary{
      border-color:rgba(139,92,246,0.65);
      background:rgba(139,92,246,0.18);
    }
    .btn.primary:hover{background:rgba(139,92,246,0.24)}
    .btn.ghost{
      background:transparent;
      border-color:rgba(234,240,255,0.16);
    }
    .btn.danger{
      border-color:rgba(249,112,102,0.60);
      background:rgba(249,112,102,0.12);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:5px 9px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill.tiny{
      padding:4px 8px;
      font-size:12px;
    }
    .pill.good{border-color:rgba(50,213,131,0.35);background:rgba(50,213,131,0.08);color:rgba(50,213,131,0.95)}
    .pill.warn{border-color:rgba(253,176,34,0.35);background:rgba(253,176,34,0.08);color:rgba(253,176,34,0.95)}
    .pill.bad {border-color:rgba(249,112,102,0.35);background:rgba(249,112,102,0.08);color:rgba(249,112,102,0.95)}
    .hr{height:1px;background:var(--border2);margin:12px 0}

    .drop{
      border:1px dashed rgba(234,240,255,0.22);
      background:rgba(255,255,255,0.03);
      border-radius:14px;
      padding:18px;
      min-height:112px;
      display:grid;place-items:center;
      text-align:center;
      transition:120ms ease;
    }
    .drop.dragover{
      border-color:rgba(139,92,246,0.75);
      background:rgba(139,92,246,0.10);
      transform:translateY(-1px);
    }
    input[type="file"]{display:none}

    /* Scroll containers: vertical + horizontal */
    .scroll{
      overflow: auto;
      border:1px solid var(--border2);
      background:rgba(0,0,0,0.10);
      border-radius:12px;
      max-height:420px;
      -webkit-overflow-scrolling: touch;
    }
    .scroll table{
      width: max-content;
      min-width: 100%;
    }
    .scroll th, .scroll td{
      white-space: nowrap;
    }

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid rgba(234,240,255,0.09);padding:7px 8px;text-align:left;vertical-align:top}
    th{
      position:sticky;top:0;z-index:1;
      background:rgba(15,24,51,0.94);
      backdrop-filter: blur(10px);
      color:rgba(234,240,255,0.92);
      font-weight:600;
    }
    tbody tr:nth-child(2n){background:rgba(255,255,255,0.015)}
    tr.groupRow td{
      background: rgba(139,92,246,0.10);
      color: rgba(234,240,255,0.92);
      font-weight: 650;
      border-bottom: 1px solid rgba(139,92,246,0.25);
    }

    #secondaryMatrix{
      position: absolute;
      inset: 0;
      overflow: auto;
      border-radius: 12px;
    }
    table.cm{
      border-collapse: collapse;
      font-size: 12px;
      width: max-content;
      min-width: 100%;
    }
    table.cm th, table.cm td{
      border-bottom: 1px solid rgba(234,240,255,0.09);
      border-right: 1px solid rgba(234,240,255,0.09);
      padding: 6px 8px;
      text-align: right;
      vertical-align: middle;
      white-space: nowrap;
    }
    table.cm th{
      text-align: center;
      background: rgba(15,24,51,0.94);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    table.cm th.stickyCol{
      left: 0;
      z-index: 3;
    }
    table.cm td.stickyCol{
      position: sticky;
      left: 0;
      z-index: 1;
      background: rgba(10,16,34,0.92);
      text-align: left;
      font-weight: 600;
    }
    td.cmCell{
      font-variant-numeric: tabular-nums;
      min-width: 48px;
    }
    td.cmDiag{
      outline: 2px solid rgba(50,213,131,0.55);
      outline-offset: -2px;
    }

    .two{display:grid;grid-template-columns: 1fr 1fr;gap:12px;align-items:start}
    .three{display:grid;grid-template-columns: 1.2fr 0.8fr;gap:12px;align-items:start}
    .span2{grid-column:1 / -1}
    @media(max-width:980px){.two,.three{grid-template-columns:1fr}}

    .field{display:grid;gap:6px}
    label{color:var(--muted);font-size:12px}
    select,input[type="number"],input[type="text"]{
      width:100%;
      border:1px solid var(--border2);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      padding:9px 10px;border-radius:12px;
      font-size:13px;
      outline:none;
    }

    .kpiGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(max-width:980px){.kpiGrid{grid-template-columns:1fr}}
    .resultsTopGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:stretch}
    @media(max-width:980px){.resultsTopGrid{grid-template-columns:1fr}}
    .kpi{
      border:1px solid var(--border2);
      background:rgba(255,255,255,0.03);
      border-radius:14px;padding:12px;
    }
    .kpi .big{font-size:22px;font-weight:650;letter-spacing:0.2px;margin-top:6px}
    .kpi .lbl{color:var(--muted);font-size:12px}
    .kpi .small{color:var(--muted);font-size:12px;margin-top:8px}

    .groupBox{
      border:1px solid var(--border2);
      background:rgba(255,255,255,0.02);
      border-radius:14px;
      padding:12px;
    }
    .groupTitle{
      font-weight:650;
      letter-spacing:0.2px;
      margin-bottom:10px;
      color:rgba(234,240,255,0.92);
      font-size:13px;
    }

    .callout{
      border:1px solid rgba(234,240,255,0.14);
      background:rgba(255,255,255,0.03);
      border-radius:14px;padding:10px 12px;
      color:rgba(234,240,255,0.86);
      font-size:12px;line-height:1.35;
    }
    .callout.good{border-color:rgba(50,213,131,0.35);background:rgba(50,213,131,0.08);color:rgba(50,213,131,0.95)}
    .callout.warn{border-color:rgba(253,176,34,0.35);background:rgba(253,176,34,0.08);color:rgba(253,176,34,0.95)}
    .callout.bad{border-color:rgba(249,112,102,0.35);background:rgba(249,112,102,0.08);color:rgba(249,112,102,0.95)}

    .toast{
      display:grid;
      gap:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(12,18,38,0.78);
      color:var(--text);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      max-width:360px;
      font-size:13px;
      line-height:1.3;
      opacity:0;
      transform: translateY(6px);
      transition: 160ms ease;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }
    .toast.good{border-color:rgba(50,213,131,0.45);background:rgba(50,213,131,0.12);color:rgba(50,213,131,0.95)}
    .toast.warn{border-color:rgba(253,176,34,0.45);background:rgba(253,176,34,0.12);color:rgba(253,176,34,0.95)}
    .toast.bad{border-color:rgba(249,112,102,0.45);background:rgba(249,112,102,0.12);color:rgba(249,112,102,0.95)}

    details{
      border:1px solid var(--border2);
      border-radius:14px;
      background:rgba(255,255,255,0.02);
      padding:10px 12px;
    }
    details > summary{
      cursor:pointer;
      color:rgba(234,240,255,0.92);
      font-size:13px;
      user-select:none;
      list-style:none;
    }
    details > summary::-webkit-details-marker{display:none}
    details .muted{margin-top:8px}

    #shiftDetails > summary{
      padding:0;
    }
    #shiftDetails > summary .muted{margin-top:0}
    #shiftDetails[open] > summary{margin-bottom:10px}

    .spinner{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(234,240,255,0.18);
      border-top-color: rgba(139,92,246,0.95);
      display:inline-block;
      animation:spin 0.75s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    pre.code{
      margin:0;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border2);
      background:rgba(0,0,0,0.25);
      overflow:auto;
      max-height:420px;
      line-height:1.35;
      white-space:pre;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(234,240,255,0.86);
    }

    .segmented{
      display:inline-flex;
      border:1px solid var(--border2);
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,0.03);
    }
    .segmented button{
      border:0;
      background:transparent;
      color:var(--muted2);
      padding:6px 10px;
      font-size:12px;
      line-height:1;
      cursor:pointer;
    }
    .segmented button.active{
      background:rgba(139,92,246,0.18);
      color:rgba(234,240,255,0.92);
    }

    .resultsTabs{
      margin:12px 0 14px;
    }

    .presetRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .presetBtn{
      flex:1;
      min-width:160px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:700;
      letter-spacing:0.15px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .presetBtn.active{
      border-color:rgba(139,92,246,0.65);
      background:rgba(139,92,246,0.18);
    }
    .presetTag{
      font-weight:650;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(234,240,255,0.16);
      color:rgba(234,240,255,0.82);
      background:rgba(255,255,255,0.03);
      white-space:nowrap;
    }

    .hidden{display:none!important}

    /* Chart sizing: prevent runaway growth */
    .two > div, .three > div, .kpiGrid > div { min-width: 0; }
    .chartBox {
      position: relative;
      width: 100%;
      height: 320px;
    }
    .chartPlaceholder{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding:12px;
      border:1px dashed rgba(234,240,255,0.14);
      border-radius:14px;
      background:rgba(255,255,255,0.02);
      color:var(--muted2);
      font-size:12px;
      pointer-events:none;
      text-align:center;
    }
    .chartBox canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
      max-width: 100% !important;
    }

    /* Sortable header styling */
    th.sortable{
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover{
      background: rgba(255,255,255,0.03);
    }
    .sort-indicator{
      display: inline-block;
      width: 10px;
      margin-left: 6px;
      color: rgba(234,240,255,0.65);
      font-size: 11px;
    }
    .pickTarget{
      cursor: pointer;
    }
    .pickTarget:hover{
      text-decoration: underline;
    }
    .pickTarget.active{
      font-weight: 750;
      text-decoration: underline;
    }
    #previewTable th.previewPick,
    #previewTable td.previewPick{
      transition: background 120ms ease;
    }
    #previewTable th.previewPick.hoverCol,
    #previewTable td.previewPick.hoverCol{
      background: rgba(139,92,246,0.14);
    }
    #previewTable th.previewPick.selectedCol,
    #previewTable td.previewPick.selectedCol{
      background: rgba(139,92,246,0.22);
    }
    #previewTable th.previewPick{
      cursor: pointer;
    }

    .globalDropOverlay{
      position: fixed;
      inset: 0;
      z-index: 999;
      display: grid;
      place-items: center;
      background: rgba(7,11,22,0.60);
      backdrop-filter: blur(6px);
      pointer-events: none;
    }
    .globalDropOverlay .inner{
      border: 2px dashed rgba(139,92,246,0.70);
      background: rgba(15,24,51,0.65);
      border-radius: 16px;
      padding: 18px 16px;
      width: min(720px, calc(100vw - 36px));
      box-shadow: var(--shadow);
      text-align: center;
    }
    .globalDropOverlay .title{
      font-weight: 700;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }
    .globalDropOverlay .hint{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div id="globalDropOverlay" class="globalDropOverlay hidden" aria-hidden="true">
    <div class="inner">
      <div class="title">Drop a CSV to start over</div>
      <div class="hint">You can drop a file anywhere on this page.</div>
    </div>
  </div>
	  <div class="topbar">
	    <div class="topline">
	      <div>
	        <div class="heroKicker">CSV to ML Model in a Single Click</div>
	        <h1>Random Forest Generator</h1>
	        <div class="sub">
	          No uploads, no sign-up, results in realtime, export your model and go.
	        </div>
	        <div class="heroNote">
	          Everything runs in this browser tab--no data leaves your computer.
	        </div>
	      </div>
	    </div>

		    <div class="stepbar">
		      <div class="stepper" id="stepper"></div>
		      <div class="row" style="gap:10px;flex-wrap:nowrap;">
		        <button class="btn" id="globalBackBtn" type="button">Back</button>
		        <button class="btn danger hidden" id="globalStopBtn" type="button" disabled>Stop</button>
		        <button class="btn primary" id="globalContinueBtn" type="button" disabled>Continue</button>
		      </div>
		    </div>
		  </div>

  <div class="wrap">
    <div class="row" id="stateChips" style="margin:12px 0 16px;"></div>
    <div class="grid">

      <!-- STEP 1: UPLOAD -->
      <section class="card" id="panelUpload">
        <h2>Upload</h2>

	        <div class="drop" id="dropZone">
	          <div>
	            <div style="font-weight:650;margin-bottom:6px;">Drop a CSV here to start</div>
	            <div class="muted2" style="margin-top:10px;">First row must be column headers.</div>
	            <div class="muted2" style="margin-top:10px;"></div>
	            <div class="muted"><button class="btn" id="browseBtn">Browse…</button> <button class="btn ghost" id="sampleBtn">Use Titanic sample</button></div>
	            <input id="fileInput" type="file" accept=".csv,text/csv" />
	          </div>
	        </div>

	        <div id="uploadSummary" class="hidden" style="margin-top:12px;">
	          <div class="hr"></div>
	          <div class="row space" style="margin-top:10px;align-items:center;">
	            <div class="muted">Preview (first 12 rows)</div>
	            <input id="targetSearch" type="text" placeholder="Filter columns…" aria-label="Filter preview columns" style="width:260px;max-width:45vw;" />
	          </div>
	          <div class="muted2">Click a column to set the target.</div>
	          <div class="scroll" style="margin-top:8px;max-height:320px;">
	            <table id="previewTable"></table>
	          </div>
	        </div>
      </section>

	      <!-- STEP 2: SETUP -->
	      <section class="card hidden" id="panelSetup">
	        <div class="row" style="align-items:baseline;gap:10px;">
	          <h2 style="margin:0;">Settings</h2>
	          <button class="textLinkBtn" id="toggleAdvancedSettingsBtn" type="button">[Show Advanced]</button>
	        </div>

	        <div class="three">
	          <div>
	            <div class="groupBox">
	              <div class="groupTitle">Target</div>
	              <div class="two">
	                <div class="field span2" id="targetSelectField">
	                  <label for="targetSelect" title="Choose the column you want the model to predict (the output/label).">What do you want to predict?</label>
	                  <select id="targetSelect"></select>
	                </div>
	                <div class="field hidden" id="taskModeField">
	                  <label for="taskMode" title="Regression predicts a number (e.g., price). Classification predicts a category (e.g., yes/no). The app usually chooses this automatically.">Task type</label>
	                  <select id="taskMode">
	                    <option value="regression" selected>Regression</option>
	                    <option value="classification">Classification</option>
	                  </select>
	                </div>
	              </div>

	              <div class="field hidden" id="targetTransformField" style="margin-top:10px;">
	                <label for="targetTransform" title="Optional: transform the target before training. Useful when the target is skewed (e.g., incomes). Predictions are converted back to the original scale.">Target transformation</label>
	                <select id="targetTransform">
	                  <option value="none" selected>None</option>
	                  <option value="log1p">log1p (for non-negative targets)</option>
	                </select>
	                <div class="muted2">If enabled, we train on transformed targets and invert predictions back.</div>
	              </div>

                <div class="field hidden" id="targetPreviewField" style="margin-top:12px;">
                  <div class="row space" style="margin-bottom:8px;">
                    <div class="muted">Target distribution</div>
                    <span class="pill" id="targetPreviewPill">—</span>
                  </div>
                  <div class="chartBox" style="height:240px;">
                    <canvas id="targetPreviewChart"></canvas>
                    <div id="targetPreviewPlaceholder" class="chartPlaceholder hidden"><span class="spinner"></span> Waiting…</div>
                  </div>
                  <div class="row hidden" id="targetPreviewHintRow" style="margin-top:10px;">
                    <div class="muted2" id="targetPreviewHintText">—</div>
                    <button class="btn ghost hidden" id="targetPreviewLog1pBtn" type="button">Apply log1p</button>
                  </div>
                </div>

	              <div id="advancedTargetDetails" class="hidden" style="margin-top:12px;">
	                <div class="hr"></div>
	                <div class="muted" style="margin-bottom:8px;">Advanced (classification)</div>

	                <div class="callout" id="multiClassSummaryCallout"></div>

	                <div class="hr"></div>

	                <div class="callout">
	                  <div style="font-weight:650;margin-bottom:6px;">Keep top N classes (map the rest → <span class="mono">RARE</span>)</div>
	                  <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;">
	                    <label class="row" style="gap:8px;align-items:center;margin:0;" title="For classification with many labels: keep only the most common classes and group the rest as RARE. This can make training and charts easier to interpret.">
	                      <input type="checkbox" id="topNEnable" />
	                      <span>Enable</span>
	                    </label>
	                    <div class="row" style="gap:8px;align-items:center;">
	                      <label class="muted2" for="topNKeep" title="How many of the most frequent classes to keep. All other classes are mapped to RARE.">Keep</label>
	                      <input id="topNKeep" type="number" min="1" step="1" value="5" style="width:110px;" />
	                      <span class="muted2">most frequent classes</span>
	                    </div>
	                  </div>
	                  <div class="muted2" id="topNSummary" style="margin-top:8px;">—</div>
	                </div>

	                <div class="hr"></div>

	                <div class="callout">
	                  <div style="font-weight:650;margin-bottom:6px;">Derived boolean target (binary) from a pythonic expression</div>
	                  <div class="muted2">
	                    Use <span class="mono" id="derivedTargetValueIdent">target</span> for the target-cell value. Examples:
	                    <span class="mono" id="derivedTargetExprExample1">target in (6,7,8)</span>,
	                    <span class="mono" id="derivedTargetExprExample2">len(target) &gt; 5</span>.
	                  </div>
	                  <div class="muted2" style="margin-top:6px;">
	                    Assumptions: the value is converted to a trimmed string; comparisons (<span class="mono">&lt;</span>, <span class="mono">&gt;=</span>, etc.) use numeric compare only if both sides parse as numbers, otherwise string compare; <span class="mono">in (...) </span> / <span class="mono">not in (...) </span> accept only literal lists (numbers/strings/true/false/none). No regex, arithmetic, or access to other columns.
	                  </div>

	                  <div class="two" style="margin-top:10px;">
	                    <div class="field" style="margin:0;">
	                      <label for="derivedTargetColName" title="Name for the new true/false column that will be created from your expression and used as the target.">New column name</label>
	                      <input id="derivedTargetColName" type="text" placeholder="e.g. is_positive" />
	                    </div>
	                    <div class="field" style="margin:0;">
	                      <label for="derivedTargetExpr" title="A simple rule that returns true/false for each row, using the target value as 'target'. Example: target in ('A','B')">Expression</label>
	                      <input id="derivedTargetExpr" type="text" placeholder='e.g. target in (6,7,8) or len(target) > 5' />
	                    </div>
	                  </div>

	                  <div class="row" style="margin-top:10px;">
	                    <button class="btn primary" id="applyDerivedTargetBtn">Create column + use as target</button>
	                    <button class="btn ghost" id="undoDerivedTargetBtn">Undo</button>
	                  </div>

	                  <div class="muted2" id="derivedTargetStatus" style="margin-top:8px;">—</div>
	                </div>
	              </div>
	            </div>

	            <div class="groupBox" style="margin-top:12px;">
	              <div class="groupTitle">Data</div>
	              <div class="two">
	                <div class="field">
	                  <label for="maxRows" title="Limit how many rows to use from the CSV for faster experiments. Use 0 to use every row.">Max rows (0 = all)</label>
	                  <input id="maxRows" type="number" min="0" step="1000" value="1000" />
	                </div>

	                <div class="field hidden" id="testFracField">
	                  <label for="testFrac" title="Fraction of rows held out for testing (not used for training). Typical values: 0.1–0.3.">Test fraction</label>
	                  <input id="testFrac" type="number" value="0.1" />
	                  <div class="muted2">What fraction [0-1] of the data to use for testing.</div>
	                </div>
	              </div>

	              <div class="field hidden" id="splitStrategyField" style="margin-top:10px;">
	                <label for="splitStrategy" title="How to choose the test split. Random is the default. Stratified keeps class proportions similar. Time split tests on later dates to simulate 'future' data.">Split strategy</label>
	                <select id="splitStrategy">
	                  <option value="random" selected>Random</option>
	                </select>
	              </div>

	              <div id="timeSplitSettings" class="two hidden" style="margin-top:10px;">
	                <div class="field">
	                  <label for="splitDateCol" title="When using a time-based split, pick the column that represents time (date/time). The test set will be later than the training set.">Time column</label>
	                  <select id="splitDateCol"></select>
	                </div>

	                <div class="field">
	                  <label for="splitMethod" title="How to create the time-based test set: either everything after a cutoff date, or a fraction of the latest rows.">Validation rule</label>
	                  <select id="splitMethod">
	                    <option value="cutoff" selected>Cutoff date (recommended)</option>
	                    <option value="fraction">Test fraction</option>
	                  </select>
	                </div>
	              </div>

	              <div class="field hidden" id="cutoffField" style="margin-top:10px;">
	                <label for="cutoffDate" title="For time split with cutoff: rows before this date train the model; rows on/after this date are used for testing.">Cutoff date</label>
	                <input id="cutoffDate" type="text" placeholder="YYYY-MM-DD" inputmode="numeric" />
	              </div>

	              <div id="splitPreview" class="callout hidden" style="margin-top:10px;"></div>
	            </div>

	            <div class="groupBox" id="hyperparametersGroupBox" style="margin-top:12px;">
	              <div class="groupTitle">Hyperparameters</div>
                <div class="field" style="margin-bottom:10px;">
                  <div class="presetRow">
                    <button class="btn presetBtn" id="presetFastBtn" type="button" title="Fast training for quick iteration.">Fast</button>
                    <button class="btn presetBtn" id="presetBalancedBtn" type="button" title="A good default balance of speed and accuracy.">Balanced<br>(Recommended)</button>
                    <button class="btn presetBtn" id="presetThoroughBtn" type="button" title="Slowest, most thorough training for best quality.">Thorough</button>
                  </div>
                </div>

                <div id="hyperparametersAdvancedFields" class="hidden">
  	              <div class="two">
  	                <div class="field">
  	                  <label for="nEstimators" title="Number of trees in the forest. More trees usually improve stability/accuracy but take longer to train.">Trees</label>
  	                  <input id="nEstimators" type="number" min="10" step="10" value="100" />
  	                </div>
  	                <div class="field">
  	                  <label for="maxFeaturesMode" title="How many features (columns) each split is allowed to consider. Using fewer features can speed up training.">Features per split</label>
  	                  <select id="maxFeaturesMode">
  	                    <option value="all" selected>All features (1.0)</option>
  	                    <option value="sqrt">Square root (sqrt)</option>
  	                    <option value="log2">Log base 2 (log2)</option>
  	                    <option value="fraction">Fraction of features</option>
  	                    <option value="count">Fixed number of features</option>
  	                  </select>
  	                  <input id="maxFeaturesValue" class="hidden" type="number" placeholder="e.g. 0.33" />
  	                </div>
  	              </div>

  	              <div class="two" style="margin-top:10px;">
  	                <div class="field">
  	                  <label for="maxDepth" title="Maximum depth of each tree. Smaller depths make simpler, faster trees; deeper trees can overfit. Leave blank for no limit.">Maximum tree depth</label>
  	                  <input id="maxDepth" type="number" min="1" step="1" value="20" placeholder="blank = unlimited" />
  	                </div>
  	                <div class="field">
  	                  <label for="minNumSamples" title="Minimum number of training rows required to split a node. Higher values make trees simpler and can reduce overfitting. Leave blank to use the library default.">Minimum samples to split</label>
  	                  <input id="minNumSamples" type="number" min="1" step="1" value="10" placeholder="blank = 1" />
  	                </div>
  	              </div>

  	              <div class="two" style="margin-top:10px;">
  	                <div class="field">
  	                  <label for="seed" title="Controls randomness (splits, sampling). Using the same seed makes results repeatable.">Random seed</label>
  	                  <input id="seed" type="number" value="42" />
  	                </div>
  	                <div class="field">
  	                  <label for="replacement" title="Whether feature sampling is done with replacement (the same feature can be selected more than once). Usually leave this off.">Feature sampling with replacement</label>
  	                  <select id="replacement">
  	                    <option value="false" selected>false</option>
  	                    <option value="true">true</option>
  	                  </select>
  	                </div>
  	              </div>

                  <div class="muted2" style="margin-top:10px;">
                    Defaults follow common best practice for tabular baselines: enough trees, feature subsampling, row bagging, and mild tree limits for speed.
                  </div>
                </div>
	            </div>
              <div class="muted2" style="margin-top:10px;">
                Hover over a setting name to see what it does.
              </div>
	            <div id="setupCallout" class="callout hidden" style="margin-top:12px;"></div>

	          </div>

	          <div>
	            <div class="groupBox" id="reviewDetails">
	              <div class="groupTitle">Review columns</div>
	              <div style="margin-bottom:10px;" class="hidden" id="maxCardFieldWrap">
	                <div class="field">
	                  <label for="maxCard" title="If an integer column has at most this many unique values, treat it as categorical (one-hot/label encoding) instead of continuous.">Categorical threshold (max unique values)</label>
	                  <input id="maxCard" type="number" min="1" step="1" value="50" />
	                  <div class="muted2">If an integer column has ≤ this many unique values, treat it as categorical.</div>
	                </div>
	              </div>

	              <div class="row" style="margin-bottom:10px;gap:10px;flex-wrap:wrap;">
	                <div class="field hidden" id="colFilterField" style="margin:0;min-width:240px;">
	                  <label for="colFilter" title="Filter the column list below by name to quickly find a feature.">Search columns</label>
	                  <input id="colFilter" type="text" placeholder="Filter by column name" />
	                </div>
	              </div>

	              <div class="scroll" style="max-height:420px;">
	                <table id="reviewColumnsTable">
	                  <thead>
	                    <tr>
	                      <th class="sortable" data-sort="include">Use <span class="sort-indicator"></span></th>
	                      <th class="sortable" data-sort="name">
	                        Column <span class="sort-indicator"></span>
	                        <button class="btn ghost" id="toggleColFilterBtn" type="button" aria-label="Filter columns" style="padding:2px 8px;font-size:11px;margin-left:6px;">
	                          <svg aria-hidden="true" viewBox="0 0 24 24" width="12" height="12" style="display:block" fill="currentColor">
	                            <path d="M3 5h18l-7 8v5l-4 2v-7z"></path>
	                          </svg>
	                        </button>
	                      </th>
	                      <th class="sortable" data-sort="type">Type <span class="sort-indicator"></span></th>
	                      <th class="sortable" data-sort="flags">Flags <span class="sort-indicator"></span></th>
	                      <th class="sortable" data-sort="missing">Missing% <span class="sort-indicator"></span></th>
	                      <th class="sortable" data-sort="unique">Unique (sample) <span class="sort-indicator"></span></th>
	                      <th class="sortable" data-sort="examples">Examples <span class="sort-indicator"></span></th>
	                    </tr>
	                  </thead>
	                  <tbody id="colConfigBody"></tbody>
	                </table>
	              </div>
	            </div>
	          </div>
	        </div>
	      </section>

      <!-- STEP 3: RESULTS -->
      <section class="card hidden" id="panelResults">
        <h2>Results</h2>

        <div id="trainStatus" class="hidden"></div>

        <div class="segmented resultsTabs" role="tablist" aria-label="Results tabs">
          <button id="tabOverview" type="button" role="tab" aria-selected="true">Overview</button>
          <button id="tabDiagnostics" type="button" role="tab" aria-selected="false">Diagnostics</button>
          <button id="tabPredictions" type="button" role="tab" aria-selected="false">Predictions</button>
        </div>

        <div id="resultsOverview" class="resultsTabPanel">
          <div class="resultsTopGrid">
            <div class="kpi">
              <div class="lbl" id="primaryMetricLabel">—</div>
              <div class="big mono" id="primaryMetricValue">—</div>
              <div class="small" id="primaryMetricSub">—</div>
            </div>
            <div class="callout hidden" id="resultsSidePanel">
              <div style="font-weight:650;margin-bottom:6px;" id="resultsSideTitle">—</div>
              <div class="muted2" id="resultsSideBody">—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <div class="row space" style="margin-bottom:8px;">
                <div class="muted">What matters (feature importance)</div>
                <div class="row">
                  <select id="importanceMode" style="width:220px;">
                    <option value="base" selected>Aggregate by column</option>
                    <option value="derived">Show derived features</option>
                  </select>
                </div>
              </div>
              <div class="chartBox">
                <canvas id="fiChart"></canvas>
                <div id="fiChartPlaceholder" class="chartPlaceholder hidden"><span class="spinner"></span> Waiting for training…</div>
              </div>
              <div class="muted2" style="margin-top:8px;">
                Aggregation groups derived features (e.g. date parts + missing indicators) back to their original column.
              </div>
            </div>

            <div>
              <div class="row space" style="margin-bottom:8px;">
                <div class="muted" id="secondaryChartTitle">—</div>
                <div class="row">
                  <span class="pill" id="secondaryChartPill">—</span>
                </div>
              </div>
              <div class="row hidden" id="classFocusRow" style="margin-bottom:8px;">
                <select id="classFocus" style="width:260px;"></select>
                <div class="muted2" id="classMetrics">—</div>
              </div>
              <div class="chartBox">
                <canvas id="secondaryChart"></canvas>
                <div id="secondaryMatrix" class="hidden"></div>
                <div id="secondaryPlaceholder" class="chartPlaceholder hidden"><span class="spinner"></span> Waiting for training…</div>
              </div>
              <div class="muted2" style="margin-top:8px;" id="secondaryChartHint">—</div>
            </div>
          </div>
        </div>

        <div id="resultsDiagnostics" class="resultsTabPanel hidden">
          <div id="resultsCallouts" class="grid" style="gap:10px;"></div>

          <div class="hr"></div>

          <div class="muted" style="margin-bottom:8px;">Pruning tools</div>
          <div class="muted2" style="margin-bottom:10px;">Use importance or shift diagnostics to drop columns and retrain quickly.</div>
          <div class="row hidden" id="pruneImpRow" style="margin-top:10px;">
            <button class="btn" id="pruneImpBtn">Prune low-importance → retrain</button>
            <div class="field" style="margin:0;min-width:160px;">
              <label for="pruneMinImp" style="margin-bottom:4px;">Min importance</label>
              <input id="pruneMinImp" type="number" min="0" step="0.001" value="0.002" style="width:160px;" />
              <div class="muted2" style="margin-top:4px;">Drops columns below this fraction</div>
            </div>
            <button class="btn ghost" id="pruneUndoBtn" disabled>Undo prune</button>
            <span class="muted2" id="pruneMiniHint">—</span>
          </div>

          <div class="hr"></div>

          <details id="shiftDetails" open>
            <summary>
              <div class="row space">
                <div class="muted">Shift detector (is_valid model)</div>
                <span class="pill" id="shiftPill">—</span>
              </div>
            </summary>
            <div class="two" style="margin-top:10px;">
              <div class="callout">
                <div style="font-weight:650;margin-bottom:6px;">How to read this</div>
                <div class="muted2" id="shiftSummary">—</div>
              </div>
              <div>
                <div class="row space" style="margin-bottom:8px;margin-top:0;">
                  <div class="muted">Top shift drivers (feature importance)</div>
                  <button class="btn" id="pruneShiftTopBtn" disabled>Prune top shift driver → retrain</button>
                </div>
                <div class="chartBox">
                  <canvas id="shiftFiChart"></canvas>
                </div>
              </div>
            </div>
          </details>
        </div>

        <div id="resultsPredictions" class="resultsTabPanel hidden">
          <div class="row space" style="margin-bottom:8px;">
            <div class="muted">Predictions explorer</div>
            <div class="row">
              <span class="pill" id="uncertaintyPill">Uncertainty: —</span>
              <input id="predTopK" type="number" min="10" step="10" value="30" style="width:90px;" />
              <button class="btn" id="downloadPredCsvBtn">Download predictions CSV</button>
            </div>
          </div>

          <details id="predInsightsDetails">
            <summary>
              <div class="row space">
                <div class="muted2">Prediction diagnostics (errors + uncertainty)</div>
                <span class="pill">What am I looking at?</span>
              </div>
            </summary>

            <div class="callout" style="margin-top:10px;">
              <div style="font-weight:650;margin-bottom:6px;">What this section is</div>
              <div class="muted2">
                These views help you understand <span class="mono">which rows</span> the model struggles with, and <span class="mono">whether it knew it was struggling</span>.
                Everything here is computed on the <span class="mono">test split</span> only (rows the model did not train on).
              </div>
            </div>

            <div class="two" style="margin-top:10px;">
              <div>
                <div class="muted2" style="margin-bottom:6px;">Worst errors (top-k)</div>
                <div class="muted2" style="margin:0 0 8px;">
                  Rows where the prediction was most wrong. Use this to spot data quality issues (missing values, strange units, parsing mistakes),
                  or segments the model can’t learn from the available features.
                </div>
                <div class="scroll">
                  <table id="worstErrTable"></table>
                </div>
                <div class="muted2" style="margin-top:8px;">
                  Tip: open “Full predictions table” below to see more raw columns for any suspicious row.
                </div>
              </div>
              <div>
                <div class="muted2" style="margin-bottom:6px;">Highest uncertainty (top-k)</div>
                <div class="muted2" style="margin:0 0 8px;">
                  “Uncertainty” here means <span class="mono">tree disagreement</span> (fastai-style).
                  A Random Forest is many trees voting; if they don’t agree, the model is less confident for that row.
                </div>
                <div class="scroll">
                  <table id="highUncTable"></table>
                </div>
                <div class="muted2" style="margin-top:8px;">
                  Not all uncertainty is bad: a row can be uncertain but still correct. The scatter below helps separate “uncertain” from “wrong”.
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row space" style="margin-bottom:8px;">
              <div class="muted2">Abs(error) vs uncertainty</div>
              <div class="row">
                <span class="pill" id="errUncPill">—</span>
              </div>
            </div>
            <div class="chartBox">
              <canvas id="errUncChart"></canvas>
            </div>
            <div class="muted2" style="margin-top:8px;">
              How to read this: <span class="mono">right</span> = more wrong, <span class="mono">up</span> = less consensus across trees.
              Upper-right often indicates shift or rare edge-cases. Bottom-right can mean “confidently wrong” (often leakage, label noise, or a missing important feature).
            </div>
          </details>

          <div class="hr"></div>

          <details id="predFullDetails" open>
            <summary>
              <div class="row space">
                <div class="muted2">Full predictions table (paged)</div>
                <span class="pill">Filter + paging</span>
              </div>
            </summary>
            <div class="row" style="margin-top:10px;">
              <input id="predFilter" type="text" placeholder="Filter (true/pred contains…)" style="width:260px;" />
              <input id="pageSize" type="number" min="10" step="10" value="50" style="width:90px;" />
              <button class="btn" id="prevPage">Prev</button>
              <button class="btn" id="nextPage">Next</button>
            </div>
            <div class="scroll" style="margin-top:10px;">
              <table id="predTable"></table>
            </div>
            <div class="muted2" style="margin-top:10px;">
              This table shows raw input rows from your CSV (test split) alongside predictions, errors, and uncertainty (tree disagreement).
            </div>
          </details>

          <div class="muted2" style="margin-top:10px;">
            Tree-disagreement uncertainty is a fastai-style confidence signal: higher values mean the trees disagree more.
          </div>
        </div>
      </section>

      <!-- STEP 4: EXPORT -->
      <section class="card hidden" id="panelExport">
        <h2>Export</h2>

        <div class="row space" style="margin-bottom:8px;">
          <div class="muted2">Example loader code</div>
          <div class="segmented" role="tablist" aria-label="Example code language">
            <button id="exportLangJsBtn" type="button" role="tab" aria-selected="true">JS</button>
            <button id="exportLangPyBtn" type="button" role="tab" aria-selected="false">Python</button>
          </div>
        </div>
        <pre class="code" id="sampleCode"></pre>

        <div class="hr"></div>
        <div class="callout">
          <div style="font-weight:650;margin-bottom:6px;">Note on opening locally</div>
          <div class="muted2">
            Some browsers restrict ES module imports when opening HTML via <span class="mono">file://</span>.
            If you see import/CORS errors, run a tiny local server (e.g. <span class="mono">python -m http.server</span>) and open <span class="mono">http://localhost:8000</span>.
          </div>
        </div>
      </section>

    </div>
  </div>

  <div id="toastHost" style="position:fixed;right:14px;bottom:14px;z-index:1000;display:grid;gap:10px;"></div>

  <script type="module">
    import { RandomForestRegression, RandomForestClassifier } from "https://esm.sh/ml-random-forest@2.1.0";
    import { DecisionTreeClassifier, DecisionTreeRegression } from "https://esm.sh/ml-cart@^2.1.1?target=es2022";
    import { Matrix, MatrixColumnSelectionView, MatrixRowSelectionView } from "https://esm.sh/ml-matrix@^6.8.2?target=es2022";
    import { MersenneTwister19937, integer } from "https://esm.sh/random-js@^2.1.0?target=es2022";

    // ----------------------------
    // State
    // ----------------------------
    const STEPS = [
      { key: "upload",  title: "Upload" },
      { key: "setup",   title: "Settings" },
      { key: "results", title: "Results" },
      { key: "export",  title: "Export" },
    ];
    const AUTO_EXCLUDE_MISSING_PCT = 50;
    const AUTO_EXCLUDE_HIGH_CARD_MIN_UNIQUE = 50;
    const AUTO_EXCLUDE_HIGH_CARD_UNIQUE_RATIO = 0.60;

    let APP = {
      step: 0,
      raw: {
        fileName: null,
        rows: [],
        columns: [],
        colMeta: {}, // {col: {inferredType, missingFrac, uniqueSample, examples[], flags:{idLike,idByName,highCardinality}, include:true}}
        targetCol: null
      },
      setup: {
        splitDateCol: null,
        splitMethod: "cutoff",
        cutoffDate: "",
        splitStrategy: "stratified",
        testFrac: 0.1,
        taskMode: "regression",
        targetTransform: "none",
        maxRows: 1000,
        maxCard: 50,
        forceDate: "",
        forceCat: "",
        forceCont: "",
        excludeCols: "",
        excluded: new Set(),
        autoExcludedReasons: {},
        forcedTypes: {
          date: new Set(),
          categorical: new Set(),
          continuous: new Set(),
        },
        multiClass: {
          topN: {
            enabled: false,
            keep: 5,
            rareLabel: "RARE",
          },
          derivedTarget: {
            enabled: false,
            sourceCol: null,
            derivedCol: "",
            expr: "",
            lastStatus: "",
            lastError: "",
          },
        },
      },
      train: {
        rfOptions: null,
        model: null,
        pipeline: null,
        featureNames: [],
        baseForDerived: [],
        derivedTypeByFeature: null,
        split: { trainIdx: [], testIdx: [] },
        yTrain: [],
        yTest: [],
        yPred: [],
        yPredLabel: [],
        err: [],
        absErr: [],
        uncertainty: null,
        uncertaintyDetails: null,
        uncertaintyStatus: "none",
        uncertaintyError: "",
        runSummary: null,
        oobPred: null,
        testRowRefs: [],
        fiDerived: [],
        fiBase: [],
        shift: null,
        dropped: { unusableTargetRows: 0, unseenTestLabels: 0, sampledRows: 0, usableRows: 0 }
      },
      ui: {
        charts: {
          fi: null,
          secondary: null,
          shift: null,
          errUnc: null,
          targetPreview: null,
        },
	        chips: {
	          order: [
	            "file",
	            "data",
	            "maxRows",
	            "target",
	            "targetWarn",
	            "task",
	            "extrapolation",
	            "split",
	            "test",
	            "typing",
	            "maxCard",
            "topN",
            "derived",
            "excluded",
            "forced",
          ],
	          items: {
	            file: { label: "File", value: "", visible: false, kind: "", title: "", setByStep: null },
	            data: { label: "Data", value: "", visible: false, kind: "", title: "", setByStep: null },
	            maxRows: { label: "Max rows", value: "", visible: false, kind: "", title: "", setByStep: null },
	            target: { label: "Target", value: "", visible: false, kind: "", title: "", setByStep: null },
	            targetWarn: { label: "Target warn", value: "", visible: false, kind: "warn", title: "", setByStep: null },
	            task: { label: "Task", value: "", visible: false, kind: "", title: "", setByStep: null },
	            extrapolation: { label: "Extrapolation", value: "", visible: false, kind: "warn", title: "", setByStep: null },
	            split: { label: "Split", value: "", visible: false, kind: "", title: "", setByStep: null },
	            test: { label: "Test", value: "", visible: false, kind: "", title: "", setByStep: null },
	            typing: { label: "Typing", value: "", visible: false, kind: "", title: "", setByStep: null },
            maxCard: { label: "Categorical threshold", value: "", visible: false, kind: "", title: "", setByStep: null },
            topN: { label: "Top N", value: "", visible: false, kind: "", title: "", setByStep: null },
            derived: { label: "Derived", value: "", visible: false, kind: "", title: "", setByStep: null },
            excluded: { label: "Excluded", value: "", visible: false, kind: "", title: "", setByStep: null },
            forced: { label: "Forced", value: "", visible: false, kind: "", title: "", setByStep: null },
          },
        },
        training: {
          startMs: 0,
          totalUnits: 0,
          completedUnits: 0,
          isTraining: false,
          stopRequested: false,
          abortController: null,
          diagAbortController: null,
          runSeq: 0,
          autoStartOnResults: false,
          retrainOnResults: false,
        },
        resultsTab: "overview",
	        exportLang: "js",
	        showAdvancedSettings: false,
          trainingPreset: "",
          hasVisitedSetup: false,
          targetPreviewKey: "",
          setupDirty: false,
	        parseSeq: 0,
	        predPage: 0,
	        predFilter: "",
	        previewFilter: "",
        colSort: { key: "name", dir: "asc" },
        maxUnlockedStep: 0,
        shiftAutoExpandedRunSeq: 0,
        prevRunSummary: null,
        pruneUndoExcluded: null,
        pruneUndoReason: "",
        pruneJustApplied: false,
      }
    };

    // ----------------------------
    // DOM helpers
    // ----------------------------
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function disableChartAnimations() {
      if (!window.Chart) return;
      try {
        Chart.defaults.animation = false;
        if (Chart.defaults.transitions?.active?.animation) Chart.defaults.transitions.active.animation.duration = 0;
        if (Chart.defaults.transitions?.resize?.animation) Chart.defaults.transitions.resize.animation.duration = 0;
      } catch {}
    }

    function showToast(message, kind = "") {
      const host = $("toastHost");
      if (!host) return;
      const toast = document.createElement("div");
      toast.className = `toast ${kind}`.trim();
      toast.textContent = message;
      host.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add("show"));
      const dismiss = () => {
        toast.classList.remove("show");
        toast.addEventListener("transitionend", () => toast.remove(), { once: true });
        setTimeout(() => toast.remove(), 220);
      };
      setTimeout(dismiss, 3000);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function truncate(s, maxLen = 200) {
      const t = (s === null || s === undefined) ? "" : String(s);
      if (t.length <= maxLen) return t;
      return t.slice(0, Math.max(0, maxLen - 1)) + "…";
    }

    // ----------------------------
    // Core utils
    // ----------------------------
    function normStr(v) {
      if (v === null || v === undefined) return "";
      return String(v).trim();
    }

    function parseNum(v) {
      const s = normStr(v);
      if (!s) return NaN;
      const x = Number(s);
      return Number.isFinite(x) ? x : NaN;
    }

    function looksLikeDateString(s) {
      const t = s.trim();
      if (!t) return false;
      if (!(/[\/\-T:]/.test(t))) return false;
      const p1 = /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}(\b|T)/;
      const p2 = /^\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}(\b|T)/;
      const p3 = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/;
      return p1.test(t) || p2.test(t) || p3.test(t);
    }

    function parseDate(v) {
      const s = normStr(v);
      if (!s) return null;
      if (!looksLikeDateString(s)) return null;
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = t;
        x = Math.imul(x ^ (x >>> 15), x | 1);
        x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      };
    }

    function shuffleInPlace(arr, rng) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function median(values) {
      const a = values.filter(Number.isFinite);
      const n = a.length;
      if (!n) return 0;
      a.sort((x,y)=>x-y);
      const m = Math.floor(n/2);
      return (n%2) ? a[m] : (a[m-1] + a[m]) / 2;
    }

    function isoWeekNumber(d) {
      const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = dt.getUTCDay() || 7;
      dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(dt.getUTCFullYear(), 0, 1));
      return Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
    }

    function dateParts(d) {
      const year = d.getFullYear();
      const month = d.getMonth() + 1;
      const week = isoWeekNumber(d);
      const day = d.getDate();
      const dow = d.getDay();
      const start = new Date(d.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((d - start) / 86400000) + 1;

      const isMonthStart = day === 1;
      const isMonthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate() === day;

      const qStartMonths = new Set([1, 4, 7, 10]);
      const qEndMonths = new Set([3, 6, 9, 12]);
      const isQuarterStart = qStartMonths.has(month) && isMonthStart;
      const isQuarterEnd = qEndMonths.has(month) && isMonthEnd;

      const isYearStart = (month === 1 && day === 1);
      const isYearEnd = (month === 12 && day === 31);

      return {
        year, month, week, day,
        dayofweek: dow,
        dayofyear: dayOfYear,
        is_month_end: isMonthEnd ? 1 : 0,
        is_month_start: isMonthStart ? 1 : 0,
        is_quarter_end: isQuarterEnd ? 1 : 0,
        is_quarter_start: isQuarterStart ? 1 : 0,
        is_year_end: isYearEnd ? 1 : 0,
        is_year_start: isYearStart ? 1 : 0,
        elapsed: d.getTime()
      };
    }

    function rmse(yTrue, yPred) {
      let s = 0;
      const n = yTrue.length;
      for (let i = 0; i < n; i++) {
        const e = (yPred[i] - yTrue[i]);
        s += e * e;
      }
      return Math.sqrt(s / Math.max(1, n));
    }

    function mae(yTrue, yPred) {
      let s = 0;
      const n = yTrue.length;
      for (let i = 0; i < n; i++) s += Math.abs(yPred[i] - yTrue[i]);
      return s / Math.max(1, n);
    }

    function r2(yTrue, yPred) {
      const n = yTrue.length;
      if (!n) return NaN;
      let mean = 0;
      for (let i = 0; i < n; i++) mean += yTrue[i];
      mean /= n;

      let ssTot = 0;
      let ssRes = 0;
      for (let i = 0; i < n; i++) {
        const dt = yTrue[i] - mean;
        ssTot += dt * dt;
        const dr = yTrue[i] - yPred[i];
        ssRes += dr * dr;
      }
      return 1 - (ssRes / Math.max(1e-12, ssTot));
    }

    function rmsle(yTrue, yPred) {
      for (let i = 0; i < yTrue.length; i++) {
        if (yTrue[i] < 0 || yPred[i] < 0) return null;
      }
      let s = 0;
      const n = yTrue.length;
      for (let i = 0; i < n; i++) {
        const a = Math.log1p(yTrue[i]);
        const b = Math.log1p(yPred[i]);
        const e = a - b;
        s += e * e;
      }
      return Math.sqrt(s / Math.max(1, n));
    }

    function accuracy(yTrue, yPred) {
      let ok = 0;
      for (let i = 0; i < yTrue.length; i++) if (yTrue[i] === yPred[i]) ok++;
      return ok / Math.max(1, yTrue.length);
    }

    function balancedAccuracy(yTrue, yPred, numClasses) {
      const k = Math.max(2, Math.floor(numClasses || 2));
      const tp = new Array(k).fill(0);
      const fn = new Array(k).fill(0);
      for (let i = 0; i < yTrue.length; i++) {
        const t = yTrue[i];
        const p = yPred[i];
        if (t === p) tp[t]++;
        else fn[t]++;
      }
      let recallSum = 0;
      for (let c = 0; c < k; c++) {
        const denom = tp[c] + fn[c];
        const recall = denom ? (tp[c] / denom) : 0;
        recallSum += recall;
      }
      return recallSum / Math.max(1, k);
    }

    function filterPaired(yTrue, yPred) {
      const yt = [];
      const yp = [];
      for (let i = 0; i < Math.min(yTrue.length, yPred.length); i++) {
        const p = yPred[i];
        if (p === null || p === undefined || !Number.isFinite(Number(p))) continue;
        yt.push(yTrue[i]);
        yp.push(p);
      }
      return { yTrue: yt, yPred: yp };
    }

    function f1Macro(yTrue, yPred, numClasses) {
      const tp = new Array(numClasses).fill(0);
      const fp = new Array(numClasses).fill(0);
      const fn = new Array(numClasses).fill(0);

      for (let i = 0; i < yTrue.length; i++) {
        const t = yTrue[i];
        const p = yPred[i];
        if (t === p) tp[t]++;
        else { fp[p]++; fn[t]++; }
      }

      let f1Sum = 0;
      for (let c = 0; c < numClasses; c++) {
        const precision = tp[c] / Math.max(1, (tp[c] + fp[c]));
        const recall = tp[c] / Math.max(1, (tp[c] + fn[c]));
        const f1 = (precision + recall) ? (2 * precision * recall) / (precision + recall) : 0;
        f1Sum += f1;
      }
      return f1Sum / Math.max(1, numClasses);
    }

    function formatNum(x, digits = 6) {
      if (x === null || x === undefined) return "—";
      if (!Number.isFinite(x)) return String(x);
      return x.toFixed(digits);
    }

    function formatDuration(ms) {
      if (!Number.isFinite(ms) || ms < 0) return "—";
      if (ms < 10_000) return `${(ms / 1000).toFixed(1)}s`;
      if (ms < 60_000) return `${Math.round(ms / 1000)}s`;
      const s = Math.round(ms / 1000);
      const m = Math.floor(s / 60);
      const rs = s % 60;
      if (m < 60) return `${m}m ${rs}s`;
      const h = Math.floor(m / 60);
      const rm = m % 60;
      return `${h}h ${rm}m`;
    }

    function isAbortError(e) {
      if (!e) return false;
      if (e.name === "AbortError") return true;
      const msg = String(e?.message || "");
      return msg.toLowerCase().includes("abort");
    }

    function isModelReady() {
      return Boolean(APP.train.model && APP.train.pipeline && APP.train.runSummary);
    }

    function setTrainingUi(isTraining) {
      APP.ui.training.isTraining = Boolean(isTraining);
      syncGlobalContinueBtn();
      syncGlobalBackBtn();
      syncGlobalStopBtn();
      if (!APP.ui.training.isTraining && APP.step === 2) {
        const task = APP.train.pipeline?.task || "";
        renderResultsSidePanel(task);
      }
      if (!APP.ui.training.isTraining) {
        if ((APP.ui.maxUnlockedStep || 0) < 3 && buildArtifact()) {
          APP.ui.maxUnlockedStep = 3;
          renderStepper();
        }
      }
    }

    function markSetupDirty() {
      APP.ui.setupDirty = true;
    }

    function requestStopTraining() {
      if (!APP.ui.training.isTraining) return;
      if (APP.ui.training.stopRequested) return;
      APP.ui.training.stopRequested = true;
      try { APP.ui.training.abortController?.abort(); } catch {}
      syncGlobalStopBtn();
      $("trainStatus").innerHTML =
        `<span class="spinner"></span> Stopping… <span class="muted2">Will stop after the current tree finishes, then score a partial model.</span>`;
    }

    function releaseAllResources() {
      try { APP.ui.training.abortController?.abort(); } catch {}
      try { APP.ui.training.diagAbortController?.abort(); } catch {}
      APP.ui.training.abortController = null;
      APP.ui.training.diagAbortController = null;
      APP.ui.training.isTraining = false;
      APP.ui.training.stopRequested = false;

      APP.raw.rows = [];
      APP.train.model = null;
      APP.train.pipeline = null;
      APP.train.featureNames = [];
      APP.train.baseForDerived = [];
      APP.train.derivedTypeByFeature = null;
      APP.train.yTrain = [];
      APP.train.yTest = [];
      APP.train.yPred = [];
      APP.train.yPredLabel = [];
      APP.train.err = [];
      APP.train.absErr = [];
      APP.train.uncertainty = null;
      APP.train.uncertaintyDetails = null;
      APP.train.uncertaintyStatus = "none";
      APP.train.uncertaintyError = "";
      APP.train.runSummary = null;
      APP.train.oobPred = null;
      APP.train.testRowRefs = [];
      APP.train.fiDerived = [];
      APP.train.fiBase = [];
      APP.train.shift = null;

      APP.ui.charts.fi = destroyChart(APP.ui.charts.fi);
      APP.ui.charts.secondary = destroyChart(APP.ui.charts.secondary);
      APP.ui.charts.shift = destroyChart(APP.ui.charts.shift);
      APP.ui.charts.errUnc = destroyChart(APP.ui.charts.errUnc);
      APP.ui.charts.targetPreview = destroyChart(APP.ui.charts.targetPreview);
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    // Prevent CSV injection when opened in spreadsheet tools
    function sanitizeCsvValue(v) {
      const s = (v === null || v === undefined) ? "" : String(v);
      if (!s) return s;
      if (/^[=+\-@]/.test(s) || /^\t/.test(s)) return "'" + s;
      return s;
    }

    function csvCell(v) {
      const s = sanitizeCsvValue(v);
      return `"${String(s).replaceAll('"','""')}"`;
    }

    // ----------------------------
    // Stepper
    // ----------------------------
    function renderStepper() {
      const s = $("stepper");
      s.innerHTML = STEPS.map((st, i) => {
        const isLocked = i > (APP.ui.maxUnlockedStep || 0);
        const cls = [
          "step",
          i === APP.step ? "active" : "",
          i < APP.step ? "done" : "",
          isLocked ? "locked" : "",
        ].filter(Boolean).join(" ");
        const dot = (i < APP.step) ? "✓" : String(i + 1);
        return `<div class="${cls}" data-step="${i}">
          <div class="dot">${dot}</div>
          <div style="font-size:12px;">${escapeHtml(st.title)}</div>
        </div>`;
      }).join("");

      s.querySelectorAll("[data-step]").forEach(el => {
        el.addEventListener("click", () => {
          const i = Number(el.getAttribute("data-step"));
          if (!Number.isFinite(i)) return;
          if (i === 3 && APP.ui.training.isTraining) {
            showToast("Stop training before exporting.", "warn");
            return;
          }
          if (i > (APP.ui.maxUnlockedStep || 0)) {
            showToast("Complete the previous step first.", "warn");
            return;
          }
          if (i === 2 && !APP.ui.training.isTraining && !isModelReady()) {
            APP.ui.training.completedUnits = 0;
            APP.ui.training.totalUnits = 0;
            APP.ui.training.stopRequested = false;
            APP.ui.training.autoStartOnResults = true;
          }
          gotoStep(i);
        });
      });
    }

    function gotoStep(i) {
      const clamped = Math.max(0, Math.min(STEPS.length - 1, i));
      APP.step = clamped;
      renderStepper();
      window.scrollTo({ top: 0, behavior: "smooth" });

      const panels = {
        0: $("panelUpload"),
        1: $("panelSetup"),
        2: $("panelResults"),
        3: $("panelExport"),
      };

      Object.entries(panels).forEach(([k, el]) => {
        if (Number(k) === APP.step) show(el);
        else hide(el);
      });

      syncButtons();

      if (APP.step === 1) {
        if (!APP.ui.hasVisitedSetup) {
          APP.ui.hasVisitedSetup = true;
          applyTrainingPreset("balanced", { silent: true });
        } else {
          renderTrainingPresetButtons();
        }
      }

      if (APP.step === 2 && isModelReady() && !APP.ui.training.isTraining && !APP.ui.training.autoStartOnResults) {
        renderResults();
      }

      if (APP.step === 2 && APP.ui.training.autoStartOnResults && !APP.ui.training.isTraining) {
        const retrain = Boolean(APP.ui.training.retrainOnResults);
        APP.ui.training.autoStartOnResults = false;
        APP.ui.training.retrainOnResults = false;
        if (isModelReady() && !retrain) {
          renderResults();
          return;
        }
        renderResultsPlaceholders();
        setTimeout(() => {
          if (APP.step !== 2) return;
          if (APP.ui.training.isTraining) return;
          trainModel();
        }, 0);
      }
    }

    // ----------------------------
    // Inference + metadata
    // ----------------------------
    function inferColumnType(col, rows, { maxCard, forceType } = {}) {
      const maxN = Math.min(rows.length, 2000);
      let nonEmpty = 0, numeric = 0, integerish = 0, dateish = 0;
      const uniq = new Set();
      const examples = [];
      let sampleLenSum = 0;

      for (let i = 0; i < maxN; i++) {
        const s = normStr(rows[i][col]);
        if (!s) continue;
        nonEmpty++;
        sampleLenSum += s.length;

        if (examples.length < 4 && !examples.includes(s)) examples.push(s);
        uniq.add(s);

        const x = parseNum(s);
        if (Number.isFinite(x)) {
          numeric++;
          if (Number.isInteger(x)) integerish++;
        } else {
          const d = parseDate(s);
          if (d) dateish++;
        }
      }

      const missingFrac = maxN ? (1 - (nonEmpty / maxN)) : 0;
      const uniqueSample = uniq.size;

      const fracNum = nonEmpty ? (numeric / nonEmpty) : 0;
      const fracDate = nonEmpty ? (dateish / nonEmpty) : 0;
      const fracInt = numeric ? (integerish / numeric) : 0;

      let inferred;
      if (fracDate >= 0.85 && fracNum < 0.40) inferred = "date";
      else if (fracNum >= 0.92) {
        const maxCardValue = Math.max(1, Math.floor(Number(maxCard) || 50));
        const isIntish = (fracInt >= 0.98);
        inferred = (isIntish && uniqueSample <= maxCardValue) ? "categorical" : "continuous";
      } else {
        inferred = "categorical";
      }

      const name = col.toLowerCase();
      const idByName = (name === "id") || name.endsWith("id") || name.includes("_id") || name.includes(" id") || name.includes("identifier");
      const uniqueRatio = nonEmpty ? (uniqueSample / nonEmpty) : 0;

      const idLike = idByName || (inferred !== "date" && fracInt >= 0.95 && uniqueRatio >= 0.95 && uniqueSample >= 50);
      const avgLen = nonEmpty ? (sampleLenSum / nonEmpty) : 0;
      const highCardinality =
        inferred === "categorical" &&
        uniqueSample >= AUTO_EXCLUDE_HIGH_CARD_MIN_UNIQUE &&
        uniqueRatio >= AUTO_EXCLUDE_HIGH_CARD_UNIQUE_RATIO &&
        avgLen >= 4;

      const forced = forceType || null;
      if (forced === "date" || forced === "categorical" || forced === "continuous") inferred = forced;

      return {
        inferredType: inferred,
        missingFrac,
        uniqueSample,
        examples,
        flags: {
          idLike,
          idByName,
          highCardinality,
        },
        include: true
      };
    }

    function setTargetFromPicker(col, { advanceStep = true } = {}) {
      if (!col) return;
      APP.raw.targetCol = col;
      APP.setup.excluded.delete(col);
      renderTargetSelect();
      $("targetSelect").value = col;
      $("targetSelect").dispatchEvent(new Event("change"));

      if (advanceStep) {
        APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 2);
        renderStepper();
        gotoStep(1);
      }
    }

    // ----------------------------
    // Rendering: Upload preview
    // ----------------------------
    function renderPreviewTable(rows, columns) {
      const filter = normStr(APP.ui.previewFilter).toLowerCase();
      const cols = filter
        ? columns.filter(c => c.toLowerCase().includes(filter))
        : columns.slice();
      if (!cols.length) {
        $("previewTable").innerHTML =
          `<tbody><tr><td class="muted2">No columns match the search.</td></tr></tbody>`;
        return;
      }

      const head = "<thead><tr>" + cols.map((c, i) => (
        `<th class="previewPick" data-preview-col="${escapeHtml(c)}" data-preview-idx="${i}">${escapeHtml(c)}</th>`
      )).join("") + "</tr></thead>";
      const body = rows.slice(0, 12).map(r => {
        const tds = cols.map((c, i) => {
          const full = normStr(r[c]) || "";
          const clipped = truncate(full, 200);
          return `<td class="previewPick" data-preview-col="${escapeHtml(c)}" data-preview-idx="${i}" title="${escapeHtml(clipped)}">${escapeHtml(clipped)}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      $("previewTable").innerHTML = head + `<tbody>${body}</tbody>`;
      syncPreviewTargetHighlight();
    }

    function setPreviewColClass(idx, cls, enabled) {
      const root = $("previewTable");
      if (!root) return;
      root.querySelectorAll(`[data-preview-idx="${idx}"]`).forEach(el => {
        el.classList.toggle(cls, Boolean(enabled));
      });
    }

    function syncPreviewTargetHighlight() {
      const table = $("previewTable");
      if (!table) return;
      table.querySelectorAll(".selectedCol").forEach(el => el.classList.remove("selectedCol"));
      const target = APP.raw.targetCol;
      if (!target) return;
      const cells = table.querySelectorAll("[data-preview-col][data-preview-idx]");
      for (const cell of cells) {
        if (cell.getAttribute("data-preview-col") !== target) continue;
        const idx = Number(cell.getAttribute("data-preview-idx"));
        if (!Number.isFinite(idx)) return;
        setPreviewColClass(idx, "selectedCol", true);
        return;
      }
    }

    function bindPreviewTargetPicker() {
      const table = $("previewTable");
      if (!table) return;
      if (table.dataset.boundTargetPicker === "1") return;
      table.dataset.boundTargetPicker = "1";

      let hoverIdx = null;
      let selectedIdx = null;

      const clearHover = () => {
        if (hoverIdx === null) return;
        setPreviewColClass(hoverIdx, "hoverCol", false);
        hoverIdx = null;
      };

      const setHover = (idx) => {
        if (hoverIdx === idx) return;
        clearHover();
        hoverIdx = idx;
        setPreviewColClass(hoverIdx, "hoverCol", true);
      };

      const setSelected = (idx) => {
        if (selectedIdx !== null) setPreviewColClass(selectedIdx, "selectedCol", false);
        selectedIdx = idx;
        if (selectedIdx !== null) setPreviewColClass(selectedIdx, "selectedCol", true);
      };

      table.addEventListener("mousemove", (e) => {
        const cell = e.target.closest("[data-preview-idx]");
        if (!cell) return;
        const idx = Number(cell.getAttribute("data-preview-idx"));
        if (!Number.isFinite(idx)) return;
        setHover(idx);
      });

      table.addEventListener("mouseleave", clearHover);

      table.addEventListener("click", (e) => {
        const cell = e.target.closest("[data-preview-col][data-preview-idx]");
        if (!cell) return;
        const col = cell.getAttribute("data-preview-col");
        const idx = Number(cell.getAttribute("data-preview-idx"));
        if (!col) return;
        if (Number.isFinite(idx)) setSelected(idx);
        setTargetFromPicker(col, { advanceStep: true });
        showToast(`Target set to ${col}`, "good");
    });
    }

    function forceDetailsOpen(id) {
      const el = $(id);
      if (!el) return;
      el.open = true;
      if (el.dataset.forceOpen === "1") return;
      el.dataset.forceOpen = "1";
      el.addEventListener("toggle", () => {
        if (!el.open) el.open = true;
      });
    }

    // ----------------------------
    // Setup rendering
    // ----------------------------
    function serializeSet(set) {
      return Array.from(set).sort((a, b) => a.localeCompare(b)).join(",");
    }

    function syncHiddenTypingLists() {
      APP.setup.excludeCols = serializeSet(APP.setup.excluded);
      APP.setup.forceDate = serializeSet(APP.setup.forcedTypes.date);
      APP.setup.forceCat = serializeSet(APP.setup.forcedTypes.categorical);
      APP.setup.forceCont = serializeSet(APP.setup.forcedTypes.continuous);
    }

    function forcedTypeForColumn(col) {
      if (APP.setup.forcedTypes.date.has(col)) return "date";
      if (APP.setup.forcedTypes.categorical.has(col)) return "categorical";
      if (APP.setup.forcedTypes.continuous.has(col)) return "continuous";
      return null;
    }

    function recomputeColumnMeta() {
      APP.setup.maxCard = Math.max(1, Math.floor(parseNum($("maxCard")?.value) || 50));

      const meta = {};
      for (const c of APP.raw.columns) {
        const auto = inferColumnType(c, APP.raw.rows, { maxCard: APP.setup.maxCard, forceType: null });
        let forced = forcedTypeForColumn(c);
        if (forced && forced === auto.inferredType) {
          if (forced === "date") APP.setup.forcedTypes.date.delete(c);
          else if (forced === "categorical") APP.setup.forcedTypes.categorical.delete(c);
          else if (forced === "continuous") APP.setup.forcedTypes.continuous.delete(c);
          forced = null;
        }

        const cur = inferColumnType(c, APP.raw.rows, { maxCard: APP.setup.maxCard, forceType: forced });
        meta[c] = { ...cur, autoType: auto.inferredType };
        meta[c].include = !APP.setup.excluded.has(c);
      }
      APP.raw.colMeta = meta;

      const targetCol = APP.raw.targetCol;
      if (targetCol && APP.raw.colMeta[targetCol]) APP.raw.colMeta[targetCol].include = true;

      syncHiddenTypingLists();
    }

    function applyDefaultColumnExclusions() {
      const meta = APP.raw.colMeta || {};
      const target = APP.raw.targetCol;
      const reasons = {};

      for (const col of APP.raw.columns) {
        if (col === target) continue;
        const m = meta[col];
        if (!m) continue;
        const colReasons = [];

        if (m.flags?.idLike) colReasons.push("ID-like");
        if (m.flags?.highCardinality) colReasons.push("High-cardinality");
        if ((m.missingFrac ?? 0) * 100 > AUTO_EXCLUDE_MISSING_PCT) {
          colReasons.push(`>${AUTO_EXCLUDE_MISSING_PCT}% missing`);
        }

        if (colReasons.length) {
          APP.setup.excluded.add(col);
          reasons[col] = colReasons;
        }
      }

      APP.setup.autoExcludedReasons = reasons;
      if (target) APP.setup.excluded.delete(target);
      syncHiddenTypingLists();
    }

    function computeTypeCounts() {
      const meta = APP.raw.colMeta;
      const counts = { date: 0, categorical: 0, continuous: 0, excluded: 0 };
      for (const c of APP.raw.columns) {
        const m = meta[c];
        if (!m) continue;
        if (!m.include) { counts.excluded++; continue; }
        if (m.inferredType === "date") counts.date++;
        else if (m.inferredType === "continuous") counts.continuous++;
        else counts.categorical++;
      }
      return { counts, maxCard: APP.setup.maxCard };
    }

    function renderColumnTable() {
      const meta = APP.raw.colMeta;
      const target = APP.raw.targetCol;
      const q = normStr($("colFilter")?.value).toLowerCase();

      const groups = [
        { key: "continuous", title: "Continuous" },
        { key: "categorical", title: "Categorical" },
        { key: "date", title: "Date" },
        { key: "excluded", title: "Excluded" },
      ];

      const sortKey = APP.ui.colSort?.key || "name";
      const sortDir = APP.ui.colSort?.dir || "asc";
      const dirMul = (sortDir === "asc") ? 1 : -1;
      const labelOfType = (t) => (t === "continuous") ? "2_cont" : (t === "categorical") ? "1_cat" : (t === "date") ? "3_date" : "9_other";

      const sortVal = (col) => {
        const m = meta[col];
        if (!m) return "";
        switch (sortKey) {
          case "include": return m.include ? 1 : 0;
          case "name": return col.toLowerCase();
          case "type": return labelOfType(m.inferredType);
          case "missing": return m.missingFrac ?? 0;
          case "unique": return m.uniqueSample ?? 0;
          case "flags": return (m.flags?.idLike ? 2 : 0) + (m.flags?.highCardinality ? 1 : 0);
          case "examples": return (m.examples?.[0] ?? "").toLowerCase();
          default: return col.toLowerCase();
        }
      };

      document.querySelectorAll("#reviewColumnsTable th.sortable[data-sort]").forEach(th => {
        const k = th.getAttribute("data-sort");
        const ind = th.querySelector(".sort-indicator");
        if (!ind) return;
        ind.textContent = (k === sortKey) ? (sortDir === "asc" ? "▲" : "▼") : "";
      });

      const rows = [];

      for (const g of groups) {
        const colsInGroup = APP.raw.columns.filter(col => {
          const m = meta[col];
          if (!m) return false;
          if (q && !col.toLowerCase().includes(q)) return false;

          const groupKey = m.include ? m.inferredType : "excluded";
          if (groupKey !== g.key) return false;
          return true;
        });

        if (!colsInGroup.length) continue;

        colsInGroup.sort((a, b) => {
          const va = sortVal(a);
          const vb = sortVal(b);
          if (typeof va === "number" && typeof vb === "number") {
            if (va === vb) return a.toLowerCase().localeCompare(b.toLowerCase());
            return (va < vb ? -1 : 1) * dirMul;
          }
          const sa = String(va), sb = String(vb);
          if (sa === sb) return a.toLowerCase().localeCompare(b.toLowerCase());
          return (sa < sb ? -1 : 1) * dirMul;
        });

          rows.push(`<tr class="groupRow"><td colspan="7">${escapeHtml(g.title)} <span class="muted2">(${colsInGroup.length})</span></td></tr>`);

        for (const col of colsInGroup) {
          const m = meta[col];
          const missPct = (m.missingFrac * 100);
          const forced = forcedTypeForColumn(col);

          const lockedReason = lockedExcludedReason(col);
          const locked = Boolean(lockedReason);
          const includeDisabled = ((target && col === target) || locked) ? "disabled" : "";
          const includeChecked = ((target && col === target) || (!locked && m.include)) ? "checked" : "";
          const includeBox = `<input type="checkbox" data-include="${escapeHtml(col)}" ${includeChecked} ${includeDisabled} />`;

          const typeSelect = `
            <select data-coltype="${escapeHtml(col)}" style="width:170px;">
              <option value="categorical" ${m.inferredType==="categorical"?"selected":""}>categorical</option>
              <option value="continuous" ${m.inferredType==="continuous"?"selected":""}>continuous</option>
              <option value="date" ${m.inferredType==="date"?"selected":""}>date</option>
            </select>
            ${forced ? `<div class="muted2">auto=${escapeHtml(m.autoType || "—")}</div>` : ""}
          `;

          const flags = [];
          if (target && col === target) flags.push(`<span class="pill good">target</span>`);
          const autoReasons = (!m.include && APP.setup.autoExcludedReasons?.[col]) || [];
          const hasAutoIdLike = autoReasons.includes("ID-like");
          const hasAutoHighCard = autoReasons.includes("High-cardinality");
          if (m.flags?.idLike && !hasAutoIdLike) {
            flags.push(`<span class="pill warn" title="Often acts like an ID">ID-like</span>`);
          }
          if (m.flags?.highCardinality && !hasAutoHighCard) {
            flags.push(`<span class="pill warn" title="Many unique categories; raw label encoding is often brittle. Consider excluding or feature-engineering.">High-cardinality</span>`);
          }
          if (forced) flags.push(`<span class="pill" title="Manually overridden">Forced</span>`);
          if (locked) flags.push(`<span class="pill warn" title="${escapeHtml(lockedReason)}">Locked</span>`);
          for (const reason of autoReasons) {
            flags.push(`<span class="pill warn tiny" title="Excluded by default">${escapeHtml(reason)}</span>`);
          }
          const flagsHtml = flags.length ? flags.join(" ") : `<span class="muted2">—</span>`;

          const examplesFull = (m.examples || [])
            .slice(0, 3)
            .map(x => truncate(x, 80))
            .join(", ");
          const examples = truncate(examplesFull, 200);

          rows.push(`
            <tr>
              <td>${includeBox}</td>
              <td class="mono">
                <span class="pickTarget ${target && col === target ? "active" : ""}" data-picktarget="${escapeHtml(col)}">${escapeHtml(col)}</span>
              </td>
              <td>${typeSelect}</td>
              <td>${flagsHtml}</td>
              <td>${escapeHtml(missPct.toFixed(1) + "%")}</td>
              <td>${escapeHtml(String(m.uniqueSample))}</td>
              <td title="${escapeHtml(examples)}">${escapeHtml(examples)}</td>
            </tr>
          `);
        }
      }

      $("colConfigBody").innerHTML = rows.join("");

      $("colConfigBody").querySelectorAll("input[type=checkbox][data-include]").forEach(cb => {
        cb.addEventListener("change", () => {
          markSetupDirty();
          const col = cb.getAttribute("data-include");
          const targetCol = APP.raw.targetCol;
          if (targetCol && col === targetCol) return;
          if (cb.checked) APP.setup.excluded.delete(col);
          else APP.setup.excluded.add(col);
          syncHiddenTypingLists();
          recomputeColumnMeta();
          refreshSplitDateCol();
          syncSetupUI();
          renderColumnTable();
          syncButtons();
        });
      });

      $("colConfigBody").querySelectorAll("select[data-coltype]").forEach(sel => {
        sel.addEventListener("change", () => {
          markSetupDirty();
          const col = sel.getAttribute("data-coltype");
          const picked = sel.value;
          APP.setup.forcedTypes.date.delete(col);
          APP.setup.forcedTypes.categorical.delete(col);
          APP.setup.forcedTypes.continuous.delete(col);

          const autoType = meta[col]?.autoType;
          if (picked !== autoType) {
            if (picked === "date") APP.setup.forcedTypes.date.add(col);
            else if (picked === "categorical") APP.setup.forcedTypes.categorical.add(col);
            else if (picked === "continuous") APP.setup.forcedTypes.continuous.add(col);
          }

          syncHiddenTypingLists();
          recomputeColumnMeta();
          refreshSplitDateCol();
          syncSetupUI();
          renderColumnTable();
          syncButtons();
        });
      });

      $("colConfigBody").querySelectorAll("[data-picktarget]").forEach(el => {
        el.addEventListener("click", () => {
          const col = el.getAttribute("data-picktarget");
          if (!col) return;
          APP.setup.excluded.delete(col);
          $("targetSelect").value = col;
          $("targetSelect").dispatchEvent(new Event("change"));
        });
      });
    }

    function listDateColumns() {
      const meta = APP.raw.colMeta;
      return APP.raw.columns.filter(c => meta[c]?.include && meta[c]?.inferredType === "date");
    }

    function decideTaskFromTarget(rows, targetCol, taskMode, meta) {
      if (taskMode === "regression") return "regression";
      if (taskMode === "classification") return "classification";

      const t = meta[targetCol]?.inferredType;
      if (t === "continuous") return "regression";
      if (t === "categorical") return "classification";
      if (t === "date") return "regression";

      const maxN = Math.min(rows.length, 1500);
      let nonEmpty = 0, numeric = 0, uniq = new Set();
      for (let i = 0; i < maxN; i++) {
        const s = normStr(rows[i][targetCol]);
        if (!s) continue;
        nonEmpty++;
        uniq.add(s);
        const x = parseNum(s);
        if (Number.isFinite(x)) numeric++;
      }
      const fracNum = nonEmpty ? (numeric / nonEmpty) : 0;
      if (fracNum >= 0.90 && uniq.size > 20) return "regression";
      return "classification";
    }

    function defaultTaskModeForTarget(rows, targetCol, meta) {
      const t = meta[targetCol]?.inferredType;
      if (t === "continuous") return "regression";
      if (t === "categorical") return "classification";
      if (t === "date") return "regression";
      return decideTaskFromTarget(rows, targetCol, null, meta);
    }

	    function syncSetupUI() {
	      const hasTarget = !!APP.raw.targetCol;
	      const showAdv = Boolean(APP.ui.showAdvancedSettings);

	      const decidedTask = hasTarget ? decideTaskFromTarget(APP.raw.rows, APP.raw.targetCol, APP.setup.taskMode, APP.raw.colMeta) : null;

	      const dateCols = listDateColumns();
	      const splitMethod = $("splitMethod").value || "cutoff";
	      const cutoff = $("cutoffDate").value || "";
	      APP.setup.splitMethod = splitMethod;
	      APP.setup.cutoffDate = cutoff;
	      const hasDates = dateCols.length > 0;
	      const splitSel = $("splitStrategy");
	      if (splitSel) {
	        const cur = APP.setup.splitStrategy || splitSel.value || "random";
	        const userSet = splitSel.dataset.userSet === "true";
	        const options = [`<option value="random">Random</option>`];
	        if (decidedTask === "classification") {
	          options.push(`<option value="stratified">Stratified (classification)</option>`);
	        }
	        if (hasDates) {
	          options.push(`<option value="time">Time-based</option>`);
	        }
	        splitSel.innerHTML = options.join("");
        if (userSet && cur === "time" && hasDates) {
          splitSel.value = "time";
        } else if ((userSet && cur === "stratified") || (!userSet && decidedTask === "classification")) {
          splitSel.value = (decidedTask === "classification") ? "stratified" : "random";
        } else if (userSet && cur === "random") {
          splitSel.value = "random";
        } else {
          splitSel.value = "random";
        }
	        splitSel.disabled = !showAdv || options.length <= 1;
	      }
	      APP.setup.splitStrategy = $("splitStrategy")?.value || "random";
	      const splitMode = effectiveSplitMode();

      $("splitDateCol").innerHTML = dateCols.length
        ? dateCols.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")
        : `<option value="">(no date columns detected)</option>`;

      if (!APP.setup.splitDateCol && dateCols.length) APP.setup.splitDateCol = dateCols[0];
      if (APP.setup.splitDateCol && dateCols.includes(APP.setup.splitDateCol)) $("splitDateCol").value = APP.setup.splitDateCol;

	      $("timeSplitSettings").classList.toggle("hidden", !(showAdv && hasDates && splitMode === "time"));
	      $("cutoffField").classList.toggle("hidden", !(showAdv && splitMode === "time" && splitMethod === "cutoff"));
	      $("cutoffDate").disabled = !(showAdv && splitMode === "time" && splitMethod === "cutoff");
	      $("testFrac").disabled = !showAdv || !(splitMode === "random" || (splitMode === "time" && splitMethod === "fraction") || (splitMode === "time" && splitMethod === "cutoff" && !cutoff));

	      if ($("targetTransformField")) $("targetTransformField").classList.toggle("hidden", !showAdv);
	      if ($("targetPreviewField")) $("targetPreviewField").classList.toggle("hidden", !showAdv);
	      if ($("taskModeField")) $("taskModeField").classList.toggle("hidden", !showAdv);
	      if ($("targetSelectField")) $("targetSelectField").classList.toggle("span2", !showAdv);
	      if ($("maxCardFieldWrap")) $("maxCardFieldWrap").classList.toggle("hidden", !showAdv);
	      if ($("testFracField")) $("testFracField").classList.toggle("hidden", !showAdv);
	      if ($("splitStrategyField")) $("splitStrategyField").classList.toggle("hidden", !showAdv);
	      if ($("hyperparametersAdvancedFields")) $("hyperparametersAdvancedFields").classList.toggle("hidden", !showAdv);
	      const advBtn = $("toggleAdvancedSettingsBtn");
	      if (advBtn) {
	        advBtn.textContent = showAdv ? "[Hide Advanced]" : "[Show Advanced]";
	        advBtn.setAttribute("aria-label", showAdv ? "Hide advanced settings" : "Show advanced settings");
	      }

	      const c = $("setupCallout");
	      if (!hasTarget) {
	        c.className = "callout";
	        c.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">Click a column name to select the target</div>
	                       <div class="muted2">Or use the dropdown on the left.</div>`;
	        show(c);
	      } else {
	        c.innerHTML = "";
	        hide(c);
	      }

        renderTrainingPresetButtons();
	      syncAdvancedTargetUI();
	      updateSplitPreview();
        renderTargetPreview();
	    }

    // ----------------------------
    // Advanced target options (multi-class classification)
    // ----------------------------
    function isDerivedTargetActive() {
      const dt = APP.setup.multiClass?.derivedTarget || null;
      if (!dt || !dt.enabled) return false;
      if (!dt.derivedCol) return false;
      return APP.raw.targetCol === dt.derivedCol;
    }

    function lockedExcludedReason(col) {
      const dt = APP.setup.multiClass?.derivedTarget || null;
      if (!dt || !dt.enabled) return null;
      if (!dt.sourceCol || !dt.derivedCol) return null;
      if (APP.raw.targetCol !== dt.derivedCol) return null;
      if (col !== dt.sourceCol) return null;
      return "Excluded to prevent leakage from the original target.";
    }

    function sampleIndicesNoAlloc(n, k, seed) {
      const nn = Math.max(0, Math.floor(n || 0));
      const kk = Math.max(0, Math.min(nn, Math.floor(k || 0)));
      if (kk >= nn) return Array.from({ length: nn }, (_, i) => i);
      const rng = mulberry32(seed >>> 0);
      const out = new Set();
      for (let i = nn - kk; i < nn; i++) {
        const t = Math.floor(rng() * (i + 1));
        if (out.has(t)) out.add(i);
        else out.add(t);
      }
      return Array.from(out);
    }

    function computeCategoricalCounts(rows, col, { maxSample = 8000, seed = 1337 } = {}) {
      if (!col) return { counts: new Map(), nSampled: 0, nMissing: 0 };
      const idx = sampleIndicesNoAlloc(rows.length, maxSample, seed);
      const counts = new Map();
      let missing = 0;
      for (const i of idx) {
        const s = normStr(rows[i]?.[col]);
        if (!s) { missing++; continue; }
        counts.set(s, (counts.get(s) || 0) + 1);
      }
      return { counts, nSampled: idx.length, nMissing: missing };
    }

    function sortedCountEntries(counts) {
      return Array.from(counts.entries())
        .sort((a, b) => (b[1] - a[1]) || String(a[0]).localeCompare(String(b[0])));
    }

	    function defaultDerivedTargetColName(sourceCol) {
	      const base = normStr(sourceCol) || "target";
	      return `${base}_is`;
	    }

	    function isValidExprValueIdent(word) {
	      if (!word) return false;
	      if (!/^[A-Za-z_][A-Za-z0-9_]*$/.test(word)) return false;
	      const kw = word.toLowerCase();
	      return !(kw === "and" || kw === "or" || kw === "not" || kw === "in" || kw === "len" || kw === "true" || kw === "false" || kw === "none");
	    }

	    function exprValueIdentForColumnName(col) {
	      const raw = normStr(col);
	      if (!raw) return "o";
	      if (isValidExprValueIdent(raw)) return raw;
	      let out = raw.replace(/[^A-Za-z0-9_]/g, "_").replace(/_+/g, "_");
	      if (!out) out = "o";
	      if (!/^[A-Za-z_]/.test(out)) out = `_${out}`;
	      if (!isValidExprValueIdent(out)) out = `${out}_`;
	      return out;
	    }

	    function compilePythonicBoolExpr(exprRaw, { valueIdent = "o" } = {}) {
	      const expr = normStr(exprRaw);
	      if (!expr) throw new Error("Expression is required.");

	      const s = expr;
      const tokens = [];
      let i = 0;

      const isWs = (c) => /\s/.test(c);
      const isDigit = (c) => /[0-9]/.test(c);
      const isIdentStart = (c) => /[A-Za-z_]/.test(c);
      const isIdentChar = (c) => /[A-Za-z0-9_]/.test(c);

      const push = (type, value = null) => tokens.push({ type, value });

      while (i < s.length) {
        const c = s[i];
        if (isWs(c)) { i++; continue; }

        if (c === "(" || c === ")" || c === "[" || c === "]" || c === ",") {
          push(c);
          i++;
          continue;
        }

        if (c === "'" || c === "\"") {
          const quote = c;
          i++;
          let out = "";
          let closed = false;
          while (i < s.length) {
            const ch = s[i];
            if (ch === quote) { i++; closed = true; break; }
            if (ch === "\\") {
              const nxt = s[i + 1];
              if (nxt === undefined) throw new Error("Unterminated string escape.");
              if (nxt === "n") out += "\n";
              else if (nxt === "t") out += "\t";
              else out += nxt;
              i += 2;
              continue;
            }
            out += ch;
            i++;
          }
          if (!closed) throw new Error("Unterminated string literal.");
          push("string", out);
          continue;
        }

        if ((c === "-" && (isDigit(s[i + 1]) || (s[i + 1] === "." && isDigit(s[i + 2])))) || isDigit(c) || (c === "." && isDigit(s[i + 1]))) {
          const start = i;
          i++; // consume first char
          while (i < s.length) {
            const ch = s[i];
            if (isDigit(ch) || ch === "." || ch === "e" || ch === "E" || ch === "+" || ch === "-") i++;
            else break;
          }
          const raw = s.slice(start, i);
          const num = Number(raw);
          if (!Number.isFinite(num)) throw new Error(`Invalid number literal: ${raw}`);
          push("number", num);
          continue;
        }

	        if (isIdentStart(c)) {
	          const start = i;
	          i++;
	          while (i < s.length && isIdentChar(s[i])) i++;
	          const word = s.slice(start, i);
	          const kw = word.toLowerCase();
	          if (kw === "and" || kw === "or" || kw === "not" || kw === "in" || kw === "len") push("kw", kw);
	          else if (kw === "true") push("boolean", true);
	          else if (kw === "false") push("boolean", false);
	          else if (kw === "none") push("none", null);
	          else if (word === "o" || word === valueIdent) push("ident", "o");
	          else throw new Error(`Unknown identifier: ${word}`);
	          continue;
	        }

        const two = s.slice(i, i + 2);
        if (two === "==" || two === "!=" || two === "<=" || two === ">=") { push("op", two); i += 2; continue; }
        if (c === "<" || c === ">") { push("op", c); i++; continue; }

        throw new Error(`Unexpected character: ${c}`);
      }
      push("eof");

      let tok = 0;
      const cur = () => tokens[tok];
      const eat = (type, value = null) => {
        const t = cur();
        if (!t || t.type !== type) return false;
        if (value !== null && t.value !== value) return false;
        tok++;
        return true;
      };
      const expect = (type, value = null) => {
        const t = cur();
        if (!eat(type, value)) {
          const v = (t && t.type === "kw") ? t.value : (t && t.value !== null ? t.value : t?.type);
          throw new Error(`Expected ${value !== null ? `${type}(${value})` : type}, got ${v || "end"}.`);
        }
      };

      const parseExpr = () => parseOr();

      const parseOr = () => {
        let node = parseAnd();
        while (eat("kw", "or")) node = { t: "or", a: node, b: parseAnd() };
        return node;
      };

      const parseAnd = () => {
        let node = parseNot();
        while (eat("kw", "and")) node = { t: "and", a: node, b: parseNot() };
        return node;
      };

      const parseNot = () => {
        if (eat("kw", "not")) return { t: "not", a: parseNot() };
        return parseCmp();
      };

      const parseCollection = () => {
        const open = cur();
        if (!eat("(") && !eat("[")) throw new Error("Expected a list/tuple after 'in'.");
        const close = (open.type === "(") ? ")" : "]";
        const items = [];
        if (eat(close)) return items;
        while (true) {
          const t = cur();
          if (t.type === "number") { items.push({ t: "number", v: t.value }); tok++; }
          else if (t.type === "string") { items.push({ t: "string", v: t.value }); tok++; }
          else if (t.type === "boolean") { items.push({ t: "boolean", v: t.value }); tok++; }
          else if (t.type === "none") { items.push({ t: "none", v: null }); tok++; }
          else throw new Error("Only literals are allowed inside ( ... ) for 'in'.");

          if (eat(",")) {
            if (eat(close)) break;
            continue;
          }
          expect(close);
          break;
        }
        return items;
      };

      const parseCmp = () => {
        const left = parsePrimary();
        const t = cur();
        if (t.type === "op") {
          tok++;
          const right = parsePrimary();
          return { t: "cmp", op: t.value, a: left, b: right };
        }
        if (t.type === "kw" && t.value === "in") {
          tok++;
          const items = parseCollection();
          return { t: "in", not: false, a: left, items };
        }
        if (t.type === "kw" && t.value === "not") {
          if (tokens[tok + 1]?.type === "kw" && tokens[tok + 1]?.value === "in") {
            tok += 2;
            const items = parseCollection();
            return { t: "in", not: true, a: left, items };
          }
        }
        return left;
      };

      const parsePrimary = () => {
        const t = cur();
        if (t.type === "number") { tok++; return { t: "number", v: t.value }; }
        if (t.type === "string") { tok++; return { t: "string", v: t.value }; }
        if (t.type === "boolean") { tok++; return { t: "boolean", v: t.value }; }
        if (t.type === "none") { tok++; return { t: "none", v: null }; }
        if (t.type === "ident" && t.value === "o") { tok++; return { t: "o" }; }
        if (t.type === "kw" && t.value === "len") {
          tok++;
          expect("(");
          const arg = parseExpr();
          expect(")");
          return { t: "len", a: arg };
        }
	        if (eat("(")) {
	          const inner = parseExpr();
	          expect(")");
	          return inner;
	        }
	        throw new Error("Expected a value (number/string/identifier/len(...)/(...)).");
	      };

      const ast = parseExpr();
      expect("eof");

      const truthy = (v) => {
        if (v === null || v === undefined) return false;
        if (typeof v === "boolean") return v;
        if (typeof v === "number") return Number.isFinite(v) && v !== 0;
        if (typeof v === "string") return v.length > 0;
        if (Array.isArray(v)) return v.length > 0;
        return Boolean(v);
      };

      const toNum = (v) => {
        if (typeof v === "number") return v;
        if (typeof v === "boolean") return v ? 1 : 0;
        const s = normStr(v);
        if (!s) return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      };

      const eq = (a, b) => {
        if (a === null || b === null) return a === b;
        if (typeof a === typeof b) return a === b;
        if (typeof a === "number" || typeof b === "number") {
          const na = toNum(a), nb = toNum(b);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na === nb;
        }
        return String(a) === String(b);
      };

      const inList = (val, items) => {
        const hasNum = items.some(x => typeof x === "number");
        const hasStr = items.some(x => typeof x === "string");
        if (hasNum && !hasStr) {
          const n = toNum(val);
          if (!Number.isFinite(n)) return false;
          return items.includes(n);
        }
        if (hasStr && !hasNum) {
          const s0 = String(val);
          return items.includes(s0);
        }
        const s0 = String(val);
        const n0 = toNum(val);
        for (const it of items) {
          if (typeof it === "number") {
            if (Number.isFinite(n0) && it === n0) return true;
          } else if (typeof it === "string") {
            if (it === s0) return true;
          } else {
            if (it === val) return true;
          }
        }
        return false;
      };

      const evalNode = (node, oVal) => {
        switch (node.t) {
          case "number": return node.v;
          case "string": return node.v;
          case "boolean": return node.v;
          case "none": return null;
          case "o": return oVal;
          case "len": return String(evalNode(node.a, oVal) ?? "").length;
          case "not": return !truthy(evalNode(node.a, oVal));
          case "and": return truthy(evalNode(node.a, oVal)) && truthy(evalNode(node.b, oVal));
          case "or": return truthy(evalNode(node.a, oVal)) || truthy(evalNode(node.b, oVal));
          case "cmp": {
            const a = evalNode(node.a, oVal);
            const b = evalNode(node.b, oVal);
            switch (node.op) {
              case "==": return eq(a, b);
              case "!=": return !eq(a, b);
              case "<":
              case "<=":
              case ">":
              case ">=": {
                const na = toNum(a), nb = toNum(b);
                if (Number.isFinite(na) && Number.isFinite(nb)) {
                  if (node.op === "<") return na < nb;
                  if (node.op === "<=") return na <= nb;
                  if (node.op === ">") return na > nb;
                  return na >= nb;
                }
                const sa = String(a), sb = String(b);
                if (node.op === "<") return sa < sb;
                if (node.op === "<=") return sa <= sb;
                if (node.op === ">") return sa > sb;
                return sa >= sb;
              }
              default: throw new Error(`Unsupported operator: ${node.op}`);
            }
          }
          case "in": {
            const a = evalNode(node.a, oVal);
            const items = node.items.map(x => (x.t === "none") ? null : x.v);
            const hit = inList(a, items);
            return node.not ? !hit : hit;
          }
          default:
            throw new Error("Unsupported expression.");
        }
      };

      return (o) => Boolean(truthy(evalNode(ast, normStr(o))));
    }

	    function applyDerivedTargetFromExpr() {
	      const dt = APP.setup.multiClass?.derivedTarget || null;
	      if (!dt) return;

      const currentTarget = APP.raw.targetCol;
      const sourceCol = (dt.enabled && dt.derivedCol && dt.sourceCol && currentTarget === dt.derivedCol)
        ? dt.sourceCol
        : currentTarget;
      if (!sourceCol) throw new Error("Pick a target column first.");

      const expr = normStr($("derivedTargetExpr")?.value);
      const derivedCol = normStr($("derivedTargetColName")?.value) || defaultDerivedTargetColName(sourceCol);

      if (!expr) throw new Error("Provide an expression.");
      if (!derivedCol) throw new Error("Provide a new column name.");

      const existing = APP.raw.columns.includes(derivedCol);
      const allowedOverwrite = (dt.enabled && dt.derivedCol === derivedCol);
      if (existing && !allowedOverwrite) throw new Error(`Column already exists: ${derivedCol}`);

      if (dt.enabled && dt.derivedCol && dt.derivedCol !== derivedCol) {
        const prev = dt.derivedCol;
        for (const r of APP.raw.rows) delete r[prev];
        APP.raw.columns = APP.raw.columns.filter(c => c !== prev);
        APP.setup.excluded.delete(prev);
      }

	      const valueIdent = exprValueIdentForColumnName(sourceCol);
	      const pred = compilePythonicBoolExpr(expr, { valueIdent });

      let tCount = 0, fCount = 0;
      for (const r of APP.raw.rows) {
        const o = r ? r[sourceCol] : "";
        const v = pred(o);
        r[derivedCol] = v ? "true" : "false";
        if (v) tCount++;
        else fCount++;
      }

      if (!existing) APP.raw.columns.push(derivedCol);

      dt.enabled = true;
      dt.sourceCol = sourceCol;
      dt.derivedCol = derivedCol;
      dt.expr = expr;
      dt.lastError = "";
      dt.lastStatus = `Created ${derivedCol}: true=${tCount}, false=${fCount}.`;

      APP.setup.excluded.add(sourceCol);
      APP.setup.excluded.delete(derivedCol);

      renderTargetSelect();
      $("targetSelect").value = derivedCol;
      $("targetSelect").dispatchEvent(new Event("change"));

      const statusEl = $("derivedTargetStatus");
      if (statusEl) {
        statusEl.innerHTML = `<span class="pill good">Ready</span> <span class="mono">${escapeHtml(dt.lastStatus)}</span>`;
      }
    }

    function undoDerivedTarget() {
      const dt = APP.setup.multiClass?.derivedTarget || null;
      if (!dt || !dt.enabled) return;

      const sourceCol = dt.sourceCol;
      const derivedCol = dt.derivedCol;

      if (derivedCol) {
        for (const r of APP.raw.rows) delete r[derivedCol];
        APP.raw.columns = APP.raw.columns.filter(c => c !== derivedCol);
        APP.setup.excluded.delete(derivedCol);
      }

      if (sourceCol) APP.setup.excluded.delete(sourceCol);

      dt.enabled = false;
      dt.sourceCol = null;
      dt.derivedCol = "";
      dt.expr = "";
      dt.lastError = "";
      dt.lastStatus = "";

      if (sourceCol) APP.raw.targetCol = sourceCol;

      renderTargetSelect();
      if (sourceCol) $("targetSelect").value = sourceCol;
      $("targetSelect").dispatchEvent(new Event("change"));

      const statusEl = $("derivedTargetStatus");
      if (statusEl) statusEl.textContent = "—";
    }

		    function syncAdvancedTargetUI() {
		      const details = $("advancedTargetDetails");
		      if (!details) return;

	      const topNState = APP.setup.multiClass?.topN || { enabled: false, keep: 5, rareLabel: "RARE" };
	      const dt = APP.setup.multiClass?.derivedTarget || { enabled: false, sourceCol: null, derivedCol: "", expr: "", lastStatus: "", lastError: "" };

	      const targetCol = APP.raw.targetCol;
	      const hasTarget = Boolean(targetCol);
	      const task = hasTarget ? decideTaskFromTarget(APP.raw.rows, targetCol, APP.setup.taskMode, APP.raw.colMeta) : null;

	      const sourceCol = (dt.enabled && dt.sourceCol) ? dt.sourceCol : targetCol;
	      const canShow = Boolean(APP.ui.showAdvancedSettings && hasTarget && task === "classification" && sourceCol);

	      if (!canShow) {
	        details.classList.add("hidden");
	        return;
	      }

	      const info = computeCategoricalCounts(APP.raw.rows, sourceCol, { maxSample: 8000, seed: 1337 });
	      const numClasses = info.counts.size;
	      details.classList.remove("hidden");

	      const callout = $("multiClassSummaryCallout");
	      if (callout) {
	        const top = sortedCountEntries(info.counts).slice(0, 6);
	        const topText = top.length
          ? top.map(([k, v]) => `${escapeHtml(truncate(k, 30))} (${v})`).join(", ")
          : "—";
        const missTxt = info.nMissing ? ` · missing=${info.nMissing}` : "";
        callout.innerHTML =
          `<div style="font-weight:650;margin-bottom:6px;">Target summary (sample)</div>` +
          `<div class="muted2">Column <span class="mono">${escapeHtml(sourceCol)}</span> · classes=${numClasses} · sampled=${info.nSampled}${missTxt}</div>` +
          `<div class="muted2" style="margin-top:6px;">Top: ${topText}</div>`;
      }

      const topNEnableEl = $("topNEnable");
      const topNKeepEl = $("topNKeep");
      const derivedActive = isDerivedTargetActive();
      if (topNEnableEl) {
        topNEnableEl.checked = Boolean(topNState.enabled);
        topNEnableEl.disabled = derivedActive;
      }
      if (topNKeepEl) {
        topNKeepEl.value = String(Math.max(1, Math.floor(topNState.keep || 5)));
        topNKeepEl.disabled = derivedActive || !Boolean(topNState.enabled);
      }

      const topNSummaryEl = $("topNSummary");
      if (topNSummaryEl) {
        if (derivedActive) topNSummaryEl.textContent = "Disabled (derived target is active).";
        else if (!topNState.enabled) topNSummaryEl.textContent = "Disabled.";
        else {
          const keepN = Math.max(1, Math.floor(topNState.keep || 1));
          const entries = sortedCountEntries(info.counts);
          const kept = entries.slice(0, Math.min(keepN, entries.length));
          const hasRare = entries.length > kept.length;
          const outK = Math.min(keepN, entries.length) + (hasRare ? 1 : 0);
          const keptText = kept.length ? kept.map(([k, v]) => `${truncate(k, 30)} (${v})`).join(", ") : "—";
          topNSummaryEl.textContent = `Keeps: ${keptText}${hasRare ? ` · Others → ${topNState.rareLabel} · New classes≈${outK}` : " · No rare classes in sample."}`;
        }
      }

	      const applyBtn = $("applyDerivedTargetBtn");
	      const undoBtn = $("undoDerivedTargetBtn");
	      const nameEl = $("derivedTargetColName");
	      const exprEl = $("derivedTargetExpr");
	      const valueIdent = exprValueIdentForColumnName(sourceCol);

	      const valueIdentEl = $("derivedTargetValueIdent");
	      if (valueIdentEl) valueIdentEl.textContent = valueIdent;
	      const ex1El = $("derivedTargetExprExample1");
	      if (ex1El) ex1El.textContent = `${valueIdent} in (6,7,8)`;
	      const ex2El = $("derivedTargetExprExample2");
	      if (ex2El) ex2El.textContent = `len(${valueIdent}) > 5`;

	      if (nameEl && !normStr(nameEl.value)) {
	        nameEl.placeholder = defaultDerivedTargetColName(sourceCol);
	      }
	      if (exprEl) {
	        exprEl.placeholder = `e.g. ${valueIdent} in (6,7,8) or len(${valueIdent}) > 5`;
	      }
	      if (exprEl && dt.enabled && normStr(dt.expr) && !exprEl.dataset.userSet) {
	        exprEl.value = dt.expr;
	      }
      if (nameEl && dt.enabled && dt.derivedCol && !nameEl.dataset.userSet) {
        nameEl.value = dt.derivedCol;
      }

      if (applyBtn) {
        const expr = normStr(exprEl?.value);
        applyBtn.disabled = !expr;
      }
      if (undoBtn) undoBtn.disabled = !dt.enabled;

      const statusEl = $("derivedTargetStatus");
      if (statusEl) {
        if (dt.lastError) {
          statusEl.innerHTML = `<span class="pill bad">Error</span> <span class="mono">${escapeHtml(dt.lastError)}</span>`;
        } else if (dt.enabled && dt.derivedCol && dt.sourceCol) {
          const active = isDerivedTargetActive();
          const activeTxt = active ? " (active)" : "";
          statusEl.innerHTML =
            `<span class="pill good">Ready</span> ` +
            `<span class="muted2">Derived <span class="mono">${escapeHtml(dt.derivedCol)}</span> from <span class="mono">${escapeHtml(dt.sourceCol)}</span>${activeTxt}.</span>`;
        } else {
          statusEl.textContent = "—";
        }
      }
    }

    function renderTargetSelect() {
      const cols = APP.raw.columns;
      const options = cols.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      $("targetSelect").innerHTML = `<option value="" disabled ${APP.raw.targetCol ? "" : "selected"}>(select a column)</option>` + options;

      if (APP.raw.targetCol) $("targetSelect").value = APP.raw.targetCol;
    }

    function resetStateChips({ clearValues = false } = {}) {
      const items = APP.ui?.chips?.items;
      if (!items) return;
      Object.values(items).forEach(item => {
        item.visible = false;
        item.kind = "";
        item.title = "";
        if (clearValues) {
          item.value = "";
          item.setByStep = null;
        }
      });
    }

    function updateStateChip(key, { value, visible = true, kind = "", title = "", setByStep = null } = {}) {
      const item = APP.ui?.chips?.items?.[key];
      if (!item) return;
      if (value !== undefined) {
        const prev = (item.value === null || item.value === undefined) ? "" : String(item.value);
        const next = (value === null || value === undefined) ? "" : String(value);
        if (prev !== next) {
          item.value = value;
          item.setByStep = (setByStep === null || setByStep === undefined) ? (APP.step || 0) : setByStep;
        }
      }
      item.visible = Boolean(visible);
      item.kind = kind || "";
      item.title = title || "";
    }

    function syncStateChips() {
      resetStateChips();

      const hasData = APP.raw.rows.length && APP.raw.columns.length;
      if (!hasData) return;

      updateStateChip("file", { value: APP.raw.fileName || "—", visible: true, setByStep: 0 });
      updateStateChip("data", { value: `${APP.raw.rows.length} rows · ${APP.raw.columns.length} cols`, visible: true, setByStep: 0 });

      const step = APP.step || 0;
      const hasTarget = Boolean(APP.raw.targetCol);
      if (hasTarget) {
        const task = decideTaskFromTarget(APP.raw.rows, APP.raw.targetCol, APP.setup.taskMode, APP.raw.colMeta);
        updateStateChip("target", { value: APP.raw.targetCol, visible: true });
        updateStateChip("task", { value: task, visible: true });

        const tm = APP.raw.colMeta?.[APP.raw.targetCol] || null;
        const isIdLike = Boolean(tm?.flags?.idLike);
        const missingFrac = Number(tm?.missingFrac ?? 0);
        const presentFrac = Math.max(0, Math.min(1, 1 - missingFrac));
        const isSparse = presentFrac < 0.5;
        if (isIdLike || isSparse) {
          const parts = [];
          if (isIdLike) parts.push("ID-like");
          if (isSparse) parts.push("<50% present");
          const targetSetBy = APP.ui?.chips?.items?.target?.setByStep;
          const titleParts = [];
          if (isIdLike) {
            titleParts.push("This target looks like an identifier, which usually isn’t a meaningful outcome to predict. Fix: choose a real outcome column (e.g. price, churn, label), or derive a meaningful target from this ID (e.g. is_vip) and use that instead.");
          }
          if (isSparse) {
            titleParts.push(`This target is missing in many rows (present≈${Math.round(presentFrac * 100)}% in the sample). Fix: pick a better-populated target, filter to rows where the target is present, or derive a proxy/label you can reliably compute.`);
          }
          updateStateChip("targetWarn", {
            value: parts.join(" · "),
            visible: true,
            kind: "warn",
            title: titleParts.join(" "),
            setByStep: Number.isFinite(targetSetBy) ? targetSetBy : null,
          });
        }
      }

      if (step < 1 || !hasTarget) return;

      const splitMode = effectiveSplitMode();
      if (splitMode === "time") {
        updateStateChip("extrapolation", {
          value: "warning",
          visible: true,
          kind: "warn",
          title: "Time split evaluates on future rows. Tree ensembles are poor at extrapolating trends, so scores can look good while future errors grow. Fix: if you want a general-purpose estimate, switch to Random split; if you truly need forecasting, treat results as a baseline and consider time-aware features and/or a forecasting model.",
          setByStep: 1,
        });
        const method = $("splitMethod")?.value || "cutoff";
        const cutoff = $("cutoffDate")?.value || "";
        const details = (method === "cutoff" && cutoff) ? `cutoff ${cutoff}` : `test ${Math.round(APP.setup.testFrac * 100)}%`;
        updateStateChip("split", { value: `time (${APP.setup.splitDateCol || "—"}) · ${details}`, visible: true, setByStep: 1 });
      } else {
        const splitStrategy = $("splitStrategy")?.value || "random";
        updateStateChip("split", { value: splitStrategy === "stratified" ? "stratified" : "random", visible: true, setByStep: 1 });
      }
      if (splitMode === "random") updateStateChip("test", { value: `${Math.round(APP.setup.testFrac * 100)}%`, visible: true, setByStep: 1 });

      updateStateChip("maxRows", { value: String(APP.setup.maxRows || 0) === "0" ? "all" : APP.setup.maxRows, visible: true, setByStep: 1 });

      const { counts, maxCard } = computeTypeCounts();
      updateStateChip("typing", { value: `cont=${counts.continuous} · cat=${counts.categorical} · date=${counts.date}`, visible: true, setByStep: 1 });
      updateStateChip("maxCard", { value: maxCard, visible: true, setByStep: 1 });

      const topNState = APP.setup.multiClass?.topN || null;
      if (topNState?.enabled && !isDerivedTargetActive()) {
        updateStateChip("topN", { value: `${Math.max(1, Math.floor(topNState.keep || 1))} + ${topNState.rareLabel || "RARE"}`, visible: true, setByStep: 1 });
      }

      const dt = APP.setup.multiClass?.derivedTarget || null;
      if (dt?.enabled && dt.sourceCol && dt.derivedCol && APP.raw.targetCol === dt.derivedCol) {
        updateStateChip("derived", { value: `${dt.sourceCol} → ${dt.derivedCol}`, visible: true, setByStep: 1 });
      }

      const excludedCount = APP.setup.excluded?.size || 0;
      const forcedCount =
        (APP.setup.forcedTypes?.date?.size || 0) +
        (APP.setup.forcedTypes?.categorical?.size || 0) +
        (APP.setup.forcedTypes?.continuous?.size || 0);
      if (excludedCount) updateStateChip("excluded", { value: excludedCount, visible: true, setByStep: 1 });
      if (forcedCount) updateStateChip("forced", { value: forcedCount, visible: true, setByStep: 1 });
    }

    function renderStateChips() {
      const el = $("stateChips");
      if (!el) return;

      syncStateChips();

      const sc = APP.ui?.chips;
      const items = sc?.items;
      const order = sc?.order;
      if (!items || !Array.isArray(order)) {
        el.innerHTML = "";
        el.classList.add("hidden");
        return;
      }

      const chips = [];
      const step = APP.step || 0;
      for (const key of order) {
        const item = items[key];
        if (!item?.visible) continue;
        if (item.value === null || item.value === undefined || item.value === "") continue;
        const setBy = Number.isFinite(item.setByStep) ? item.setByStep : null;
        if (setBy !== null && step <= setBy && item.kind !== "warn") continue;
        const cls = ["pill", item.kind].filter(Boolean).join(" ");
        const titleAttr = item.title ? ` title="${escapeHtml(item.title)}"` : "";
        chips.push(
          `<span class="${cls}"${titleAttr}>` +
            `${escapeHtml(item.label)}: <span class="mono">${escapeHtml(String(item.value))}</span>` +
          `</span>`
        );
      }

      if (!chips.length) {
        el.innerHTML = "";
        el.classList.add("hidden");
        return;
      }

      el.classList.remove("hidden");
      el.innerHTML = chips.join(" ");
    }

    function refreshSplitDateCol() {
      const dateCols = APP.raw.columns.filter(c => APP.raw.colMeta[c]?.include && APP.raw.colMeta[c]?.inferredType === "date");
      const current = APP.setup.splitDateCol;

      $("splitDateCol").innerHTML = dateCols.length
        ? dateCols.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")
        : `<option value="">(no date columns detected)</option>`;

      if (dateCols.length) {
        if (current && dateCols.includes(current)) {
          $("splitDateCol").value = current;
        } else {
          APP.setup.splitDateCol = dateCols[0];
          $("splitDateCol").value = dateCols[0];
        }
      } else {
        APP.setup.splitDateCol = null;
      }

      syncSetupUI();
    }

    // ----------------------------
    // Build dataset + preprocessing (fit on TRAIN only)
    // ----------------------------
    function sampleRowIndices(nRows, maxRows, seed, mode = "random") {
      if (!maxRows || maxRows <= 0 || nRows <= maxRows) {
        return Array.from({ length: nRows }, (_, i) => i);
      }
      if (mode === "time") {
        const start = Math.max(0, nRows - maxRows);
        return Array.from({ length: maxRows }, (_, k) => start + k);
      }
      const rng = mulberry32(seed);
      const idx = Array.from({ length: nRows }, (_, i) => i);
      shuffleInPlace(idx, rng);
      return idx.slice(0, maxRows);
    }

    function syncMaxFeaturesUi() {
      const modeEl = $("maxFeaturesMode");
      const valueEl = $("maxFeaturesValue");
      if (!modeEl || !valueEl) return;
      const mode = modeEl.value || "all";
      const showValue = (mode === "fraction" || mode === "count");
      valueEl.classList.toggle("hidden", !showValue);
      valueEl.disabled = !showValue;
      if (mode === "fraction") {
        valueEl.placeholder = "e.g. 0.33";
        valueEl.min = "0";
        valueEl.max = "1";
        valueEl.step = "0.01";
        valueEl.inputMode = "decimal";
      } else if (mode === "count") {
        valueEl.placeholder = "e.g. 12";
        valueEl.min = "1";
        valueEl.removeAttribute("max");
        valueEl.step = "1";
        valueEl.inputMode = "numeric";
      } else {
        valueEl.placeholder = "";
        valueEl.removeAttribute("min");
        valueEl.removeAttribute("max");
        valueEl.removeAttribute("step");
        valueEl.removeAttribute("inputmode");
      }
    }

    function parseMaxFeatures(modeRaw, valueRaw, nFeatures) {
      const mode = normStr(modeRaw) || "all";
      if (mode === "all") return 1.0;
      if (mode === "sqrt") return Math.max(1, Math.floor(Math.sqrt(nFeatures)));
      if (mode === "log2") return Math.max(1, Math.floor(Math.log2(nFeatures)));
      const value = normStr(valueRaw);
      if (mode === "fraction") {
        const x = Number(value);
        if (Number.isFinite(x) && x > 0 && x < 1) return x;
        return 1.0;
      }
      if (mode === "count") {
        const k = Math.floor(Number(value));
        if (Number.isFinite(k) && k >= 1) return Math.min(k, nFeatures);
        return 1.0;
      }
      return 1.0;
    }

    function parseOptionalPositiveInt(v) {
      const s = normStr(v);
      if (!s) return null;
      const x = Math.floor(Number(s));
      if (!Number.isFinite(x) || x <= 0) return null;
      return x;
    }

    function estimateDerivedFeatureCount() {
      const targetCol = APP.raw.targetCol;
      const meta = APP.raw.colMeta || {};
      if (!targetCol) return 0;

      const featureCols = APP.raw.columns.filter(c => c !== targetCol && meta[c]?.include);
      const cont = featureCols.filter(c => meta[c]?.inferredType === "continuous").length;
      const cat = featureCols.filter(c => meta[c]?.inferredType === "categorical").length;
      const date = featureCols.filter(c => meta[c]?.inferredType === "date").length;

      const DATE_FEATURES_PER_COL = 14; // 13 parts + _na
      return (cont * 2) + (cat * 1) + (date * DATE_FEATURES_PER_COL);
    }

    function suggestMaxFeaturesSetting(task) {
      return { mode: "all", value: "" };
    }

    function suggestTreeOptions({ nRows, nFeatures }) {
      const nr = Math.max(1, Math.floor(nRows || 1));
      const nf = Math.max(1, Math.floor(nFeatures || 1));
      const featurePenalty = Math.max(0, Math.floor(Math.log2(nf)) - 8); // >256 derived features => shallower
      const maxDepthBase = Math.floor(Math.log2(nr)) + 6;
      const maxDepth = Math.min(24, Math.max(16, maxDepthBase - featurePenalty));
      const minNumSamples = Math.min(20, Math.max(5, Math.floor(nr / 2000)));
      return { maxDepth, minNumSamples };
    }

    function applyAutoTrainDefaults() {
      if (!APP.raw.targetCol) return;

      const maxRows = Math.floor(parseNum($("maxRows")?.value) || 0);
      const rawN = APP.raw.rows.length || 0;
      const nRows = (maxRows > 0) ? Math.min(rawN, maxRows) : rawN;
      const nFeatures = estimateDerivedFeatureCount();

      const task = decideTaskFromTarget(APP.raw.rows, APP.raw.targetCol, APP.setup.taskMode, APP.raw.colMeta);

      const mfModeEl = $("maxFeaturesMode");
      const mfValueEl = $("maxFeaturesValue");
      const mdEl = $("maxDepth");
      const msEl = $("minNumSamples");
      if (!mfModeEl || !mfValueEl || !mdEl || !msEl) return;

      const suggestedMf = suggestMaxFeaturesSetting(task);
      const suggestedTree = suggestTreeOptions({ nRows, nFeatures });

      if (!mfModeEl.dataset.userSet) mfModeEl.value = suggestedMf.mode;
      if (!mfValueEl.dataset.userSet) mfValueEl.value = suggestedMf.value;
      syncMaxFeaturesUi();
      if (!mdEl.dataset.userSet) mdEl.value = String(suggestedTree.maxDepth);
      if (!msEl.dataset.userSet) msEl.value = String(suggestedTree.minNumSamples);
    }

    function renderTrainingPresetButtons() {
      const preset = APP.ui.trainingPreset || "";
      $("presetFastBtn")?.classList.toggle("active", preset === "fast");
      $("presetBalancedBtn")?.classList.toggle("active", preset === "balanced");
      $("presetThoroughBtn")?.classList.toggle("active", preset === "thorough");
    }

    function clearTrainingPreset() {
      if (!APP.ui.trainingPreset) return;
      APP.ui.trainingPreset = "";
      renderTrainingPresetButtons();
    }

    function countIncludedFeatureTypes() {
      const meta = APP.raw.colMeta || {};
      const target = APP.raw.targetCol;
      const out = { categorical: 0, continuous: 0, date: 0 };
      for (const c of APP.raw.columns || []) {
        if (c === target) continue;
        const m = meta[c];
        if (!m?.include) continue;
        if (m.inferredType === "continuous") out.continuous++;
        else if (m.inferredType === "date") out.date++;
        else out.categorical++;
      }
      return out;
    }

    function chooseFastMaxFeaturesSetting() {
      const { categorical, continuous } = countIncludedFeatureTypes();
      if (!categorical && !continuous) return { mode: "sqrt", value: "" };
      if (categorical >= continuous) return { mode: "sqrt", value: "" };
      return { mode: "fraction", value: "0.333" };
    }

    function applyTrainingPreset(presetKey, { silent = false } = {}) {
      const key = String(presetKey || "").toLowerCase();
      const maxRowsEl = $("maxRows");
      const nEstimatorsEl = $("nEstimators");
      const maxFeaturesModeEl = $("maxFeaturesMode");
      const maxFeaturesValueEl = $("maxFeaturesValue");
      const maxDepthEl = $("maxDepth");
      const minNumSamplesEl = $("minNumSamples");
      if (!maxRowsEl || !nEstimatorsEl || !maxFeaturesModeEl || !maxFeaturesValueEl || !maxDepthEl || !minNumSamplesEl) return;

      const setTrainInputs = ({ maxRows, nEstimators, maxDepth, minNumSamples, maxFeaturesMode, maxFeaturesValue }) => {
        maxRowsEl.value = String(maxRows);
        APP.setup.maxRows = Math.floor(parseNum(maxRowsEl.value) || 0);

        nEstimatorsEl.value = String(nEstimators);
        maxDepthEl.value = String(maxDepth);
        minNumSamplesEl.value = String(minNumSamples);

        maxFeaturesModeEl.value = String(maxFeaturesMode);
        maxFeaturesValueEl.value = (maxFeaturesValue === null || maxFeaturesValue === undefined) ? "" : String(maxFeaturesValue);
        maxFeaturesModeEl.dataset.userSet = "1";
        maxFeaturesValueEl.dataset.userSet = "1";
        maxDepthEl.dataset.userSet = "1";
        minNumSamplesEl.dataset.userSet = "1";
        syncMaxFeaturesUi();

        APP.ui.trainingPreset = key;
        renderTrainingPresetButtons();
        markSetupDirty();
        syncSetupUI();
        renderStateChips();
      };

      if (key === "fast") {
        const mf = chooseFastMaxFeaturesSetting();
        setTrainInputs({
          maxRows: 100,
          nEstimators: 50,
          maxDepth: 14,
          minNumSamples: 20,
          maxFeaturesMode: mf.mode,
          maxFeaturesValue: mf.value,
        });
        if (!silent) showToast("Preset applied: Fast", "good");
        return;
      }
      if (key === "balanced") {
        setTrainInputs({
          maxRows: 1000,
          nEstimators: 100,
          maxDepth: 20,
          minNumSamples: 10,
          maxFeaturesMode: "all",
          maxFeaturesValue: "",
        });
        if (!silent) showToast("Preset applied: Balanced", "good");
        return;
      }
      if (key === "thorough") {
        setTrainInputs({
          maxRows: 0,
          nEstimators: 400,
          maxDepth: 24,
          minNumSamples: 5,
          maxFeaturesMode: "all",
          maxFeaturesValue: "",
        });
        if (!silent) showToast("Preset applied: Thorough", "good");
        return;
      }
    }

    function buildInverseMapping(mappingObj) {
      if (!mappingObj) return null;
      const inv = {};
      for (const [k, v] of Object.entries(mappingObj)) inv[v] = k;
      return inv;
    }

    function getRowTargetValue(row, targetCol, task, targetTransform, meta) {
      if (task === "regression") {
        const tType = meta[targetCol]?.inferredType;
        let yiRaw;
        if (tType === "date") {
          const d = parseDate(row[targetCol]);
          if (!d) return null;
          yiRaw = d.getTime();
        } else {
          const x = parseNum(row[targetCol]);
          if (!Number.isFinite(x)) return null;
          yiRaw = x;
        }

        if (targetTransform === "log1p") {
          if (yiRaw < 0) return null;
          return { yRaw: yiRaw, y: Math.log1p(yiRaw) };
        }
        return { yRaw: yiRaw, y: yiRaw };
      } else {
        const s = normStr(row[targetCol]) || "#na#";
        return { yRaw: s, y: s };
      }
    }

    function transformRowToFeatures(row, pipeline) {
      const contCols = pipeline.preprocess.continuous.cols;
      const catCols  = pipeline.preprocess.categorical.cols;
      const dateCols = pipeline.preprocess.date.cols;

      const feats = [];

      for (const c of contCols) {
        const x = parseNum(row[c]);
        const miss = !Number.isFinite(x);
        feats.push(miss ? pipeline.preprocess.continuous.median[c] : x);
        feats.push(miss ? 1 : 0);
      }

      for (const c of catCols) {
        const s = normStr(row[c]) || pipeline.preprocess.categorical.missingToken;
        const m = pipeline.preprocess.categorical.mapping[c];
        feats.push((m[s] === undefined) ? pipeline.preprocess.categorical.unknownId : m[s]);
      }

      for (const c of dateCols) {
        const d = parseDate(row[c]);
        const miss = !d;
        const dt = miss ? new Date(pipeline.preprocess.date.medianElapsed[c]) : d;
        const p = dateParts(dt);

        feats.push(p.year);
        feats.push(p.month);
        feats.push(p.week);
        feats.push(p.day);
        feats.push(p.dayofweek);
        feats.push(p.dayofyear);
        feats.push(p.is_month_end);
        feats.push(p.is_month_start);
        feats.push(p.is_quarter_end);
        feats.push(p.is_quarter_start);
        feats.push(p.is_year_end);
        feats.push(p.is_year_start);
        feats.push(p.elapsed);
        feats.push(miss ? 1 : 0);
      }

      return feats;
    }

    function buildDataset(seed, testFrac, splitMode, splitDateCol) {
      const rows = APP.raw.rows;
      const columns = APP.raw.columns;
      const targetCol = APP.raw.targetCol;
      const meta = APP.raw.colMeta;

      const maxRows = Math.floor(parseNum($("maxRows").value) || 0);

      const usedIdx = sampleRowIndices(rows.length, maxRows, seed, splitMode);
      const sampledRows = usedIdx.map(i => rows[i]);

      const includeCols = columns.filter(c => (c === targetCol) || (meta[c]?.include));
      const featureCols = includeCols.filter(c => c !== targetCol);

      const contCols = featureCols.filter(c => meta[c]?.inferredType === "continuous");
      const catCols  = featureCols.filter(c => meta[c]?.inferredType === "categorical");
      const dateCols = featureCols.filter(c => meta[c]?.inferredType === "date");

      const task = decideTaskFromTarget(sampledRows, targetCol, APP.setup.taskMode, meta);
      const targetTransform = APP.setup.targetTransform;
      const splitStrategy = $("splitStrategy")?.value || "random";

      // derived feature schema
      const DATE_PARTS = [
        "year","month","week","day","dayofweek","dayofyear",
        "is_month_end","is_month_start","is_quarter_end","is_quarter_start","is_year_end","is_year_start",
        "elapsed"
      ];

      const featureNames = [];
      const baseForDerived = [];

      for (const c of contCols) {
        featureNames.push(c); baseForDerived.push(c);
        featureNames.push(`${c}_na`); baseForDerived.push(c);
      }
      for (const c of catCols) {
        featureNames.push(c); baseForDerived.push(c);
      }
      for (const c of dateCols) {
        for (const p of DATE_PARTS) { featureNames.push(`${c}_${p}`); baseForDerived.push(c); }
        featureNames.push(`${c}_na`); baseForDerived.push(c);
      }

      // Filter unusable rows by target parse (regression) / transform constraints
      const rowRefs = [];
      const yAll = [];
      const yAllRaw = [];
      let droppedTargets = 0;

      for (const r of sampledRows) {
        const tv = getRowTargetValue(r, targetCol, task, targetTransform, meta);
        if (!tv) { droppedTargets++; continue; }
        rowRefs.push(r);
        yAll.push(tv.y);
        yAllRaw.push(tv.yRaw);
      }

      if (!rowRefs.length) {
        return {
          Xtrain: [], ytrain: [], Xtest: [], ytest: [],
          testRowRefs: [],
          trainRowRefs: [],
          featureNames, baseForDerived,
          pipeline: null, task,
          dropped: { unusableTargetRows: droppedTargets, unseenTestLabels: 0, sampledRows: sampledRows.length, usableRows: 0 }
        };
      }

      // Split BEFORE fitting preprocessors to avoid leakage
      let split;
      if (splitMode === "time" && splitDateCol) {
        const method = $("splitMethod").value || "cutoff";
        const cutoffStr = $("cutoffDate").value || "";
        let cutoffMs = null;
        if (method === "cutoff" && cutoffStr) {
          const d = new Date(`${cutoffStr}T00:00:00`);
          cutoffMs = Number.isFinite(d.getTime()) ? d.getTime() : null;
        }

        if (method === "cutoff" && cutoffMs !== null) {
          split = splitTimeBasedCutoff(rowRefs, splitDateCol, cutoffMs);
          if (!split.trainIdx.length || !split.testIdx.length) {
            split = splitTimeBased(rowRefs, splitDateCol, testFrac);
          }
        } else {
          split = splitTimeBased(rowRefs, splitDateCol, testFrac);
        }
      }
      else {
        if (task === "classification" && splitStrategy === "stratified") {
          split = splitStratified(yAll, testFrac, seed);
        } else {
          split = splitRandom(rowRefs.length, testFrac, seed);
        }
      }

      const trainRows = split.trainIdx.map(i => rowRefs[i]);
      const testRows = split.testIdx.map(i => rowRefs[i]);

      // Fit preprocessors on TRAIN only
      const contMedian = {};
      for (const c of contCols) {
        const vals = [];
        for (const r of trainRows) {
          const x = parseNum(r[c]);
          if (Number.isFinite(x)) vals.push(x);
        }
        contMedian[c] = median(vals);
      }

      const dateMedian = {};
      for (const c of dateCols) {
        const vals = [];
        for (const r of trainRows) {
          const d = parseDate(r[c]);
          if (d) vals.push(d.getTime());
        }
        dateMedian[c] = median(vals);
      }

      const catMapping = {};
      for (const c of catCols) {
        const m = new Map();
        m.set("#na#", 0);
        let id = 1;
        for (const r of trainRows) {
          const s = normStr(r[c]) || "#na#";
          if (!m.has(s)) m.set(s, id++);
        }
        catMapping[c] = Object.fromEntries(m.entries());
      }

      let targetMapping = null;
      let numTargetClasses = null;
      let normalizeTargetLabel = null;
      if (task === "classification") {
        const topN = APP.setup.multiClass?.topN || null;
        const dt = APP.setup.multiClass?.derivedTarget || null;
        const derivedActive = Boolean(dt?.enabled && dt.derivedCol && targetCol === dt.derivedCol);
        const enabled = Boolean(topN?.enabled) && !derivedActive;
        const keepN = Math.max(1, Math.floor(topN?.keep || 1));
        const rareLabel = normStr(topN?.rareLabel) || "RARE";

        let topSet = null;
        let hasRare = false;
        let kept = [];

        if (enabled) {
          const counts = new Map();
          for (const i of split.trainIdx) {
            const s = normStr(yAll[i]) || "#na#";
            if (s === "#na#") continue;
            counts.set(s, (counts.get(s) || 0) + 1);
          }

          const entries = Array.from(counts.entries())
            .sort((a, b) => (b[1] - a[1]) || String(a[0]).localeCompare(String(b[0])));
          kept = entries.slice(0, Math.min(keepN, entries.length)).map(([k]) => k);
          topSet = new Set(kept);
          for (const y of yAll) {
            const s = normStr(y) || "#na#";
            if (s === "#na#") continue;
            if (!topSet.has(s)) { hasRare = true; break; }
          }
        }

        normalizeTargetLabel = (label) => {
          const s = normStr(label) || "#na#";
          if (s === "#na#") return "#na#";
          if (!topSet || topSet.has(s)) return s;
          return rareLabel;
        };

        const seen = new Map();
        seen.set("#na#", 0);
        let id = 1;

        if (topSet) {
          for (const s of kept) {
            if (!seen.has(s)) seen.set(s, id++);
          }
          if (hasRare && !seen.has(rareLabel)) seen.set(rareLabel, id++);
        }

        for (const i of split.trainIdx) {
          const s = normalizeTargetLabel(yAll[i]);
          if (!seen.has(s)) seen.set(s, id++);
        }
        targetMapping = Object.fromEntries(seen.entries());
        numTargetClasses = seen.size;
      }

      const pipeline = {
        schemaVersion: "1.3",
        createdAt: new Date().toISOString(),
        fileName: APP.raw.fileName,
        originalColumns: [...columns],
        includedColumns: [...includeCols],
        targetCol,
        task,
        targetTransform,
        procs: ["add_datepart", "FillMissing", "Categorify"],
        preprocess: {
          continuous: { cols: [...contCols], median: { ...contMedian } },
          categorical: { cols: [...catCols], mapping: JSON.parse(JSON.stringify(catMapping)), missingToken: "#na#", unknownId: 0 },
          date: { cols: [...dateCols], medianElapsed: { ...dateMedian }, parts: [...DATE_PARTS] }
        },
        derivedFeatureNames: [...featureNames],
        derivedFeatureBase: [...baseForDerived],
        target: { col: targetCol, mapping: targetMapping, numClasses: numTargetClasses },
        library: { name: "ml-random-forest", version: "2.1.0" },
        fittedOn: {
          splitMode,
          splitDateCol: splitDateCol || null,
          splitMethod: (splitMode === "time") ? ($("splitMethod").value || "cutoff") : "fraction",
          cutoffDate: (splitMode === "time") ? ($("cutoffDate").value || "") : "",
          nTrain: trainRows.length,
          nTest: testRows.length
        }
      };

      // Transform TRAIN
      const Xtrain = trainRows.map(r => transformRowToFeatures(r, pipeline));
      let ytrain;
      if (task === "regression") {
        ytrain = split.trainIdx.map(i => yAll[i]);
      } else {
        ytrain = split.trainIdx.map(i => {
          const s = normalizeTargetLabel ? normalizeTargetLabel(yAll[i]) : yAll[i];
          return (targetMapping[s] === undefined) ? 0 : targetMapping[s];
        });
      }

      // Transform TEST (drop unseen labels for classification)
      const Xtest = [];
      const ytest = [];
      const testRowRefs = [];
      let droppedUnseenTestLabels = 0;

      if (task === "regression") {
        for (const i of split.testIdx) {
          Xtest.push(transformRowToFeatures(rowRefs[i], pipeline));
          ytest.push(yAll[i]);
          testRowRefs.push(rowRefs[i]);
        }
      } else {
        for (const i of split.testIdx) {
          const label = normalizeTargetLabel ? normalizeTargetLabel(yAll[i]) : yAll[i];
          const id = targetMapping[label];
          if (id === undefined) { droppedUnseenTestLabels++; continue; }
          Xtest.push(transformRowToFeatures(rowRefs[i], pipeline));
          ytest.push(id);
          testRowRefs.push(rowRefs[i]);
        }
      }

      return {
        Xtrain, ytrain, Xtest, ytest, testRowRefs,
        trainRowRefs: trainRows,
        featureNames, baseForDerived,
        pipeline, task,
        dropped: {
          unusableTargetRows: droppedTargets,
          unseenTestLabels: droppedUnseenTestLabels,
          sampledRows: sampledRows.length,
          usableRows: rowRefs.length
        }
      };
    }

    // ----------------------------
    // Split
    // ----------------------------
    function splitRandom(n, testFrac, seed) {
      const rng = mulberry32(seed);
      const idx = Array.from({ length: n }, (_, i) => i);
      shuffleInPlace(idx, rng);
      const nTest = Math.max(1, Math.floor(n * testFrac));
      const testIdx = idx.slice(0, nTest);
      const trainIdx = idx.slice(nTest);
      return { trainIdx, testIdx };
    }

    function splitStratified(y, testFrac, seed) {
      const groups = new Map();
      for (let i = 0; i < y.length; i++) {
        const label = y[i];
        if (!groups.has(label)) groups.set(label, []);
        groups.get(label).push(i);
      }

      const rng = mulberry32(seed);
      const trainIdx = [];
      const testIdx = [];

      for (const idxs of groups.values()) {
        shuffleInPlace(idxs, rng);
        const nTest = Math.max(1, Math.floor(idxs.length * testFrac));
        testIdx.push(...idxs.slice(0, nTest));
        trainIdx.push(...idxs.slice(nTest));
      }

      return { trainIdx, testIdx };
    }

    function splitTimeBased(rowRefs, dateCol, testFrac) {
      const keys = rowRefs.map((r, i) => {
        const d = parseDate(r[dateCol]);
        const t = d ? d.getTime() : Number.NEGATIVE_INFINITY;
        return { i, t };
      });
      keys.sort((a,b)=>a.t-b.t);

      const n = keys.length;
      const nTest = Math.max(1, Math.floor(n * testFrac));
      const test = keys.slice(Math.max(0, n - nTest)).map(o => o.i);
      const train = keys.slice(0, Math.max(0, n - nTest)).map(o => o.i);
      return { trainIdx: train, testIdx: test };
    }

    function splitTimeBasedCutoff(rowRefs, dateCol, cutoffMs) {
      const trainIdx = [];
      const testIdx = [];
      for (let i = 0; i < rowRefs.length; i++) {
        const d = parseDate(rowRefs[i][dateCol]);
        const t = d ? d.getTime() : Number.NEGATIVE_INFINITY;
        if (t < cutoffMs) trainIdx.push(i);
        else testIdx.push(i);
      }
      return { trainIdx, testIdx };
    }

    function effectiveSplitMode() {
      const dateCols = APP.raw.columns.filter(c => APP.raw.colMeta[c]?.include && APP.raw.colMeta[c]?.inferredType === "date");
      const strategy = $("splitStrategy")?.value || "random";
      return (dateCols.length && strategy === "time") ? "time" : "random";
    }

    function formatPreviewCount(n) {
      return Number.isFinite(n) ? n.toLocaleString() : "—";
    }

    function formatPreviewDate(ms) {
      if (!Number.isFinite(ms)) return "—";
      const d = new Date(ms);
      if (!Number.isFinite(d.getTime())) return "—";
      return d.toISOString().slice(0, 10);
    }

    function updateSplitPreview() {
      const callout = $("splitPreview");
      if (!callout) return;
      if (!APP.ui.showAdvancedSettings) {
        callout.className = "callout hidden";
        callout.innerHTML = "";
        return;
      }

      const rows = APP.raw.rows || [];
      const targetCol = APP.raw.targetCol;
      if (!rows.length || !targetCol) {
        callout.className = "callout";
        callout.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">Split preview</div>
          <div class="muted2">Select a target and load data to preview the split.</div>`;
        return;
      }

      const seed = parseNum($("seed")?.value) || 42;
      const splitMode = effectiveSplitMode();
      const splitDateCol = (splitMode === "time") ? ($("splitDateCol")?.value || APP.setup.splitDateCol) : null;
      const maxPreviewRows = 10000;
      const maxRowsSetting = Math.max(0, Math.floor(parseNum($("maxRows")?.value) || 0));

      let sampleIdx;
      if (maxRowsSetting > 0) {
        const baseIdx = sampleRowIndices(rows.length, maxRowsSetting, seed, splitMode);
        if (baseIdx.length <= maxPreviewRows) {
          sampleIdx = baseIdx;
        } else if (splitMode === "time") {
          sampleIdx = baseIdx.slice(Math.max(0, baseIdx.length - maxPreviewRows));
        } else {
          const pick = sampleIndicesNoAlloc(baseIdx.length, maxPreviewRows, (seed ^ 0x9e3779b9) >>> 0);
          sampleIdx = pick.map(j => baseIdx[j]);
        }
      } else {
        sampleIdx = sampleRowIndices(rows.length, maxPreviewRows, seed, splitMode);
      }
      const sampledRows = sampleIdx.map(i => rows[i]);
      const task = decideTaskFromTarget(sampledRows, targetCol, APP.setup.taskMode, APP.raw.colMeta);
      const testFrac = Math.min(0.5, Math.max(0.05, parseNum($("testFrac")?.value) || 0.1));
      const splitStrategy = $("splitStrategy")?.value || "random";

      const rowRefs = [];
      const yAll = [];
      let droppedTargets = 0;
      for (const r of sampledRows) {
        const tv = getRowTargetValue(r, targetCol, task, APP.setup.targetTransform, APP.raw.colMeta);
        if (!tv) { droppedTargets++; continue; }
        rowRefs.push(r);
        yAll.push(tv.y);
      }

      if (!rowRefs.length) {
        callout.className = "callout warn";
        callout.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">Split preview</div>
          <div class="muted2">No usable rows in the preview sample. Check the target column.</div>`;
        return;
      }

      let split;
      if (splitMode === "time" && splitDateCol) {
        const method = $("splitMethod")?.value || "cutoff";
        const cutoffStr = $("cutoffDate")?.value || "";
        let cutoffMs = null;
        if (method === "cutoff" && cutoffStr) {
          const d = new Date(`${cutoffStr}T00:00:00`);
          cutoffMs = Number.isFinite(d.getTime()) ? d.getTime() : null;
        }

        if (method === "cutoff" && cutoffMs !== null) {
          split = splitTimeBasedCutoff(rowRefs, splitDateCol, cutoffMs);
          if (!split.trainIdx.length || !split.testIdx.length) {
            split = splitTimeBased(rowRefs, splitDateCol, testFrac);
          }
        } else {
          split = splitTimeBased(rowRefs, splitDateCol, testFrac);
        }
      } else {
        if (task === "classification" && splitStrategy === "stratified") {
          split = splitStratified(yAll, testFrac, seed);
        } else {
          split = splitRandom(rowRefs.length, testFrac, seed);
        }
      }

      const trainCount = split.trainIdx.length;
      const testCount = split.testIdx.length;
      const previewRows = trainCount + testCount;

      let warn = false;
      let detailHtml = "";

      if (splitMode === "time" && splitDateCol) {
        let trainMin = null;
        let trainMax = null;
        let testMin = null;
        let testMax = null;

        for (const idx of split.trainIdx) {
          const d = parseDate(rowRefs[idx]?.[splitDateCol]);
          if (!d) continue;
          const t = d.getTime();
          trainMin = (trainMin === null || t < trainMin) ? t : trainMin;
          trainMax = (trainMax === null || t > trainMax) ? t : trainMax;
        }

        for (const idx of split.testIdx) {
          const d = parseDate(rowRefs[idx]?.[splitDateCol]);
          if (!d) continue;
          const t = d.getTime();
          testMin = (testMin === null || t < testMin) ? t : testMin;
          testMax = (testMax === null || t > testMax) ? t : testMax;
        }

        detailHtml = `<div class="muted2">Train dates: <span class="mono">${formatPreviewDate(trainMin)}</span> → <span class="mono">${formatPreviewDate(trainMax)}</span></div>
          <div class="muted2">Test dates: <span class="mono">${formatPreviewDate(testMin)}</span> → <span class="mono">${formatPreviewDate(testMax)}</span></div>`;
      } else if (task === "classification") {
        const trainCounts = new Map();
        const testCounts = new Map();
        for (const idx of split.trainIdx) {
          const label = normStr(yAll[idx]) || "#na#";
          trainCounts.set(label, (trainCounts.get(label) || 0) + 1);
        }
        for (const idx of split.testIdx) {
          const label = normStr(yAll[idx]) || "#na#";
          testCounts.set(label, (testCounts.get(label) || 0) + 1);
        }

        const labels = new Set([...trainCounts.keys(), ...testCounts.keys()]);
        for (const label of labels) {
          const t = trainCounts.get(label) || 0;
          const v = testCounts.get(label) || 0;
          if (!t || !v) warn = true;
        }

        const top = Array.from(labels)
          .map(label => ({ label, total: (trainCounts.get(label) || 0) + (testCounts.get(label) || 0) }))
          .sort((a, b) => (b.total - a.total) || a.label.localeCompare(b.label))
          .slice(0, 5);

        if (top.length) {
          const lines = top.map(({ label }) => {
            const train = trainCounts.get(label) || 0;
            const test = testCounts.get(label) || 0;
            return `<div class="row" style="justify-content:space-between;gap:12px;">
              <span class="mono">${escapeHtml(label)}</span>
              <span class="muted2">train <span class="mono">${formatPreviewCount(train)}</span> · test <span class="mono">${formatPreviewCount(test)}</span></span>
            </div>`;
          });
          detailHtml = `<div class="muted2" style="margin-top:6px;">Top classes in preview sample:</div>${lines.join("")}`;
        }
      }

      const warnNote = warn
        ? `<div style="margin-top:6px;">Some labels may be absent from train/test. Consider stratified split or adjust cutoff.</div>`
        : "";

      const maxRowsNote = (maxRowsSetting > 0)
        ? ` (max_rows=${formatPreviewCount(maxRowsSetting)})`
        : "";

      callout.className = `callout${warn ? " warn" : ""}`;
      callout.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">Split preview</div>
        <div>Train rows ≈ <span class="mono">${formatPreviewCount(trainCount)}</span> / Test rows ≈ <span class="mono">${formatPreviewCount(testCount)}</span></div>
        <div class="muted2">Based on ${formatPreviewCount(previewRows)} sampled rows${maxRowsNote}${droppedTargets ? ` (${formatPreviewCount(droppedTargets)} dropped)` : ""}.</div>
        ${detailHtml}
        ${warnNote}`;
    }

    function renderTargetPreview() {
      const field = $("targetPreviewField");
      const canvas = $("targetPreviewChart");
      const pill = $("targetPreviewPill");
      const placeholder = $("targetPreviewPlaceholder");
      const hintRow = $("targetPreviewHintRow");
      const hintText = $("targetPreviewHintText");
      const hintBtn = $("targetPreviewLog1pBtn");

      if (!field || !canvas || !pill || !placeholder || !hintRow || !hintText || !hintBtn) return;

      if (!APP.ui.showAdvancedSettings) {
        field.classList.add("hidden");
        return;
      }

      field.classList.remove("hidden");
      hintRow.classList.add("hidden");
      hintBtn.classList.add("hidden");

      const rows = APP.raw.rows || [];
      const targetCol = APP.raw.targetCol;
      if (!rows.length || !targetCol) {
        pill.className = "pill";
        pill.textContent = "—";
        APP.ui.charts.targetPreview = destroyChart(APP.ui.charts.targetPreview);
        placeholder.classList.remove("hidden");
        hintText.textContent = "Select a target to preview its distribution.";
        return;
      }

      const splitMode = effectiveSplitMode();
      const splitDateCol = (splitMode === "time") ? ($("splitDateCol")?.value || APP.setup.splitDateCol) : "";
      const seed = parseNum($("seed")?.value) || 42;
      const maxRowsSetting = Math.max(0, Math.floor(parseNum($("maxRows")?.value) || 0));
      const taskMode = $("taskMode")?.value || APP.setup.taskMode;
      const transformMode = $("targetTransform")?.value || APP.setup.targetTransform || "none";
      const task = decideTaskFromTarget(rows, targetCol, taskMode, APP.raw.colMeta);

      const key = [
        APP.ui.parseSeq || 0,
        APP.ui.showAdvancedSettings ? "adv" : "basic",
        targetCol,
        task,
        transformMode,
        splitMode,
        splitDateCol,
        maxRowsSetting,
        seed,
        rows.length,
      ].join("|");
      if (APP.ui.targetPreviewKey === key) return;
      APP.ui.targetPreviewKey = key;

      const maxSample = 5000;
      const baseIdx = sampleRowIndices(rows.length, maxRowsSetting, seed, splitMode);
      let sampleIdx = baseIdx;
      if (baseIdx.length > maxSample) {
        if (splitMode === "time") {
          sampleIdx = baseIdx.slice(Math.max(0, baseIdx.length - maxSample));
        } else {
          const pick = sampleIndicesNoAlloc(baseIdx.length, maxSample, (seed ^ 0x7f4a7c15) >>> 0);
          sampleIdx = pick.map(j => baseIdx[j]);
        }
      }

      const values = [];
      let dropped = 0;
      for (const i of sampleIdx) {
        const tv = getRowTargetValue(rows[i], targetCol, task, (task === "regression") ? transformMode : "none", APP.raw.colMeta);
        if (!tv) { dropped++; continue; }
        values.push(tv.y);
      }

      if (!values.length) {
        pill.className = "pill warn";
        pill.textContent = "No usable values";
        APP.ui.charts.targetPreview = destroyChart(APP.ui.charts.targetPreview);
        placeholder.classList.remove("hidden");
        hintText.textContent = "No usable target values found in the preview sample.";
        return;
      }

      const ctx = canvas.getContext("2d");
      APP.ui.charts.targetPreview = destroyChart(APP.ui.charts.targetPreview);
      placeholder.classList.add("hidden");

      const baseColor = "rgba(139,92,246,0.70)";
      const borderColor = "rgba(139,92,246,1)";

      if (task === "regression") {
        const nums = values.map(v => Number(v)).filter(v => Number.isFinite(v));
        if (!nums.length) {
          pill.className = "pill warn";
          pill.textContent = "No numeric values";
          placeholder.classList.remove("hidden");
          hintText.textContent = "Target values are not numeric.";
          return;
        }

        const n = nums.length;
        const min = Math.min(...nums);
        const max = Math.max(...nums);
        const nBins = 30;
        const counts = new Array(nBins).fill(0);

        if (min === max) {
          counts[0] = n;
        } else {
          const w = (max - min) / nBins;
          for (const v of nums) {
            const idx = Math.min(nBins - 1, Math.max(0, Math.floor((v - min) / w)));
            counts[idx]++;
          }
        }

        const fmt = (x) => {
          const ax = Math.abs(x);
          if (ax >= 1000) return String(Math.round(x));
          if (ax >= 10) return x.toFixed(1);
          return x.toFixed(2);
        };

        const labels = (min === max)
          ? [fmt(min)]
          : Array.from({ length: nBins }, (_, k) => {
              const a = min + (k * (max - min) / nBins);
              const b = min + ((k + 1) * (max - min) / nBins);
              return `${fmt(a)}–${fmt(b)}`;
            });

        pill.className = "pill";
        const tfTag = (transformMode === "log1p") ? " · log1p" : "";
        pill.textContent = `n=${nums.length.toLocaleString()}${dropped ? ` (${dropped.toLocaleString()} dropped)` : ""}${tfTag}`;

        APP.ui.charts.targetPreview = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Count",
                data: (min === max) ? [nums.length] : counts,
                backgroundColor: baseColor,
                borderColor,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (item) => `Count: ${Number(item.raw || 0).toLocaleString()}`,
                },
              },
            },
            scales: {
              x: {
                ticks: { color: "rgba(234,240,255,0.75)", maxRotation: 0, autoSkip: true },
                grid: { color: "rgba(234,240,255,0.08)" },
              },
              y: {
                beginAtZero: true,
                ticks: { color: "rgba(234,240,255,0.75)" },
                grid: { color: "rgba(234,240,255,0.08)" },
              },
            },
          },
        });

        const zeros = nums.reduce((a, v) => a + ((v === 0) ? 1 : 0), 0);
        const zerosFrac = zeros / Math.max(1, n);
        const nonNeg = min >= 0;
        const mean = nums.reduce((a, v) => a + v, 0) / Math.max(1, n);
        const m2 = nums.reduce((a, v) => { const d = v - mean; return a + d * d; }, 0) / Math.max(1, n);
        const sd = Math.sqrt(m2);
        const m3 = nums.reduce((a, v) => { const d = v - mean; return a + d * d * d; }, 0) / Math.max(1, n);
        const skew = (sd > 0) ? (m3 / Math.pow(sd, 3)) : 0;
        const shouldSuggest = (transformMode !== "log1p") && nonNeg && (zerosFrac >= 0.25 || Math.abs(skew) >= 1.5);
        const transformEl = $("targetTransform");
        const canApply = Boolean(transformEl && transformEl.value !== "log1p");

        if (shouldSuggest) {
          hintRow.classList.remove("hidden");
          hintText.textContent = "Consider log1p transform (skewed / many zeros).";
          hintBtn.classList.toggle("hidden", !canApply);
        }
        if (!shouldSuggest && transformMode === "log1p") {
          hintRow.classList.remove("hidden");
          hintText.textContent = "Preview shows log1p-transformed target (training uses the transformed scale).";
          hintBtn.classList.add("hidden");
        }

      } else {
        const counts = new Map();
        for (const v of values) {
          const s = normStr(v) || "#na#";
          counts.set(s, (counts.get(s) || 0) + 1);
        }

        const entries = Array.from(counts.entries())
          .map(([label, c]) => ({ label, c }))
          .sort((a, b) => (b.c - a.c) || a.label.localeCompare(b.label));

        const top = entries.slice(0, 10);
        const topSum = top.reduce((a, x) => a + x.c, 0);
        const other = entries.reduce((a, x) => a + x.c, 0) - topSum;
        const labels = top.map(x => x.label).concat(other > 0 ? ["Other"] : []);
        const data = top.map(x => x.c).concat(other > 0 ? [other] : []);

        pill.className = "pill";
        pill.textContent = `n=${values.length.toLocaleString()}${dropped ? ` (${dropped.toLocaleString()} dropped)` : ""}`;

        APP.ui.charts.targetPreview = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Count",
                data,
                backgroundColor: baseColor,
                borderColor,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { color: "rgba(234,240,255,0.75)", maxRotation: 0, autoSkip: true },
                grid: { color: "rgba(234,240,255,0.08)" },
              },
              y: {
                beginAtZero: true,
                ticks: { color: "rgba(234,240,255,0.75)" },
                grid: { color: "rgba(234,240,255,0.08)" },
              },
            },
          },
        });
      }
    }

    // ----------------------------
    // Charts
    // ----------------------------
    const FEATURE_COLORS = {
      continuous: { fill: "rgba(79, 152, 255, 0.75)", stroke: "rgba(79, 152, 255, 1)" },
      categorical: { fill: "rgba(182, 120, 255, 0.75)", stroke: "rgba(182, 120, 255, 1)" },
      date: { fill: "rgba(255, 170, 80, 0.75)", stroke: "rgba(255, 170, 80, 1)" },
      datepart: { fill: "rgba(255, 170, 80, 0.75)", stroke: "rgba(255, 170, 80, 1)" },
      other: { fill: "rgba(160, 175, 205, 0.60)", stroke: "rgba(160, 175, 205, 0.90)" },
    };

    function baseTypeOfColumn(col) {
      const t = APP.raw.colMeta?.[col]?.inferredType;
      if (t === "continuous" || t === "categorical" || t === "date") return t;
      return "other";
    }

    function buildDerivedTypeByFeature(featureNames, baseForDerived) {
      const map = {};
      for (let i = 0; i < featureNames.length; i++) {
        const feat = featureNames[i];
        const base = baseForDerived[i] || feat;
        const baseType = baseTypeOfColumn(base);
        map[feat] = (baseType === "date") ? "datepart" : baseType;
      }
      return map;
    }

    function colorsForFiLabels(labels, mode) {
      const backgroundColor = [];
      const borderColor = [];
      const derivedMap = APP.train.derivedTypeByFeature || {};
      for (const name of labels) {
        const t = (mode === "derived")
          ? (derivedMap[name] || baseTypeOfColumn(name))
          : baseTypeOfColumn(name);
        const c = FEATURE_COLORS[t] || FEATURE_COLORS.other;
        backgroundColor.push(c.fill);
        borderColor.push(c.stroke);
      }
      return { backgroundColor, borderColor };
    }

    function destroyChart(ch) {
      if (ch) { try { ch.destroy(); } catch {} }
      return null;
    }

    function clearSecondaryViz() {
      APP.ui.charts.secondary = destroyChart(APP.ui.charts.secondary);
      const m = $("secondaryMatrix");
      if (m) m.innerHTML = "";
      hide($("secondaryMatrix"));
      show($("secondaryChart"));
      hide($("classFocusRow"));
      const sel = $("classFocus");
      if (sel) sel.onchange = null;
      if ($("classMetrics")) $("classMetrics").textContent = "—";
    }

    function renderFIChart(pairs, titleLabel, mode = "base") {
      const top = pairs.slice(0, 20);
      const labels = top.map(x => x.name);
      const data = top.map(x => x.imp);
      const colors = colorsForFiLabels(labels, mode);

      const ctx = $("fiChart").getContext("2d");
      APP.ui.charts.fi = destroyChart(APP.ui.charts.fi);

      APP.ui.charts.fi = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: titleLabel || "importance",
            data,
            backgroundColor: colors.backgroundColor,
            borderColor: colors.borderColor,
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          indexAxis: "y",
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } },
            y: { ticks: { color: "rgba(234,240,255,0.75)" }, grid: { display: false } }
          }
        }
      });
    }

    function renderShiftFIChart(pairs) {
      const top = (pairs || []).slice(0, 20);
      const labels = top.map(x => x.name);
      const data = top.map(x => x.imp);
      const colors = colorsForFiLabels(labels, "base");

      const ctx = $("shiftFiChart").getContext("2d");
      APP.ui.charts.shift = destroyChart(APP.ui.charts.shift);

      APP.ui.charts.shift = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "shift importance",
            data,
            backgroundColor: colors.backgroundColor,
            borderColor: colors.borderColor,
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          indexAxis: "y",
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } },
            y: { ticks: { color: "rgba(234,240,255,0.75)" }, grid: { display: false } }
          }
        }
      });
    }

    function sampleRows(rows, maxRows, seed) {
      const n = rows.length;
      if (n <= maxRows) return { rows, idx: Array.from({ length: n }, (_, i) => i) };
      const rng = mulberry32(seed >>> 0);
      const idx = Array.from({ length: n }, (_, i) => i);
      shuffleInPlace(idx, rng);
      const pick = idx.slice(0, maxRows);
      return { rows: pick.map(i => rows[i]), idx: pick };
    }

    function buildShiftPipelineFromRows(basePipeline, rowsAll) {
      const contCols = basePipeline.preprocess.continuous.cols;
      const catCols = basePipeline.preprocess.categorical.cols;
      const dateCols = basePipeline.preprocess.date.cols;
      const DATE_PARTS = basePipeline.preprocess.date.parts;

      const contMedian = {};
      for (const c of contCols) {
        const vals = [];
        for (const r of rowsAll) {
          const x = parseNum(r[c]);
          if (Number.isFinite(x)) vals.push(x);
        }
        contMedian[c] = median(vals);
      }

      const dateMedian = {};
      for (const c of dateCols) {
        const vals = [];
        for (const r of rowsAll) {
          const d = parseDate(r[c]);
          if (d) vals.push(d.getTime());
        }
        dateMedian[c] = median(vals);
      }

      const catMapping = {};
      for (const c of catCols) {
        const m = new Map();
        m.set("#na#", 0);
        let id = 1;
        for (const r of rowsAll) {
          const s = normStr(r[c]) || "#na#";
          if (!m.has(s)) m.set(s, id++);
        }
        catMapping[c] = Object.fromEntries(m.entries());
      }

      return {
        preprocess: {
          continuous: { cols: [...contCols], median: { ...contMedian } },
          categorical: { cols: [...catCols], mapping: JSON.parse(JSON.stringify(catMapping)), missingToken: "#na#", unknownId: 0 },
          date: { cols: [...dateCols], medianElapsed: { ...dateMedian }, parts: [...DATE_PARTS] }
        }
      };
    }

    async function computeShiftDiagnostics({ trainRows, testRows, pipeline, featureNames, baseForDerived, seed, signal }) {
      // Fit procs on combined (train+test) rows to avoid artificial shift from "unknown category" encoding.
      const nTrain = trainRows.length;
      const nTest = testRows.length;
      const total = nTrain + nTest;
      if (!nTrain || !nTest || !total) return null;

      // IMPORTANT: Balance classes 50/50; otherwise accuracy is dominated by class imbalance
      // (e.g., with a 90/10 train/test split, a dumb classifier gets 0.90 accuracy).
      const maxTotal = 20000;
      const perClass = Math.max(1, Math.min(Math.floor(maxTotal / 2), nTrain, nTest));

      const trainS = sampleRows(trainRows, perClass, seed + 101);
      const testS = sampleRows(testRows, perClass, seed + 202);
      const rowsAll = trainS.rows.concat(testS.rows);

      const shiftPipe = buildShiftPipelineFromRows(pipeline, rowsAll);
      const X = rowsAll.map(r => transformRowToFeatures(r, shiftPipe));
      const y = new Array(trainS.rows.length).fill(0).concat(new Array(testS.rows.length).fill(1));

      const trees = 120;
      const shiftModel = new RandomForestClassifier({
        seed: Math.floor(seed + 777),
        nEstimators: trees,
        maxFeatures: 1.0,
        replacement: false,
        useSampleBagging: true,
      });

      const info = await trainForestWithProgress(shiftModel, X, y, {
        onProgress: () => {},
        signal: signal || null,
      });

      const oobPred = info?.oobPred || null;
      let oobAcc = null;
      let oobBalAcc = null;
      let oobF1 = null;
      let oobCovered = 0;
      if (oobPred && oobPred.length === y.length) {
        const filtered = filterPaired(y.map(v => Number(v)), oobPred.map(v => (v === null ? null : Number(v))));
        oobCovered = filtered.yTrue.length;
        if (filtered.yTrue.length) {
          oobAcc = accuracy(filtered.yTrue, filtered.yPred);
          oobBalAcc = balancedAccuracy(filtered.yTrue, filtered.yPred, 2);
          oobF1 = f1Macro(filtered.yTrue, filtered.yPred, 2);
        }
      }

      let fi = null;
      try { fi = shiftModel.featureImportance(); } catch { fi = null; }
      const fiBase = (fi && fi.length === featureNames.length)
        ? aggregateFI(fi, featureNames, baseForDerived)
        : [];

      return {
        oobAcc,
        oobBalAcc,
        oobF1,
        oobCovered,
        nTotal: y.length,
        nTrainUsed: trainS.rows.length,
        nTestUsed: testS.rows.length,
        fiBase,
      };
    }

    function renderRegressionScatter(yTrue, yPred) {
      clearSecondaryViz();

      const n = yTrue.length;
      const maxPts = Math.min(2000, n);
      const rng = mulberry32(1337);
      const idx = Array.from({ length: n }, (_, i) => i);
      shuffleInPlace(idx, rng);
      const pick = idx.slice(0, maxPts);

      const pts = pick.map(i => ({ x: yTrue[i], y: yPred[i] }));

      // Reference line y = x across the visible range
      let minV = Infinity, maxV = -Infinity;
      for (let i = 0; i < pts.length; i++) {
        const x = pts[i].x, y = pts[i].y;
        if (Number.isFinite(x)) { if (x < minV) minV = x; if (x > maxV) maxV = x; }
        if (Number.isFinite(y)) { if (y < minV) minV = y; if (y > maxV) maxV = y; }
      }
      if (!Number.isFinite(minV) || !Number.isFinite(maxV) || minV === maxV) {
        minV = 0; maxV = 1;
      }

      const refLine = [{ x: minV, y: minV }, { x: maxV, y: maxV }];

      const ctx = $("secondaryChart").getContext("2d");
      APP.ui.charts.secondary = destroyChart(APP.ui.charts.secondary);

      APP.ui.charts.secondary = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [
            { label: "pred vs true", data: pts, pointRadius: 2 },
            {
              type: "line",
              label: "y = x",
              data: refLine,
              pointRadius: 0,
              borderWidth: 1,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "true" }, ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } },
            y: { title: { display: true, text: "pred" }, ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } }
          }
        }
      });
    }

    function renderConfusionMatrix(yTrue, yPred, invMap, maxClasses = 10) {
      clearSecondaryViz();
      hide($("secondaryChart"));
      show($("secondaryMatrix"));
      show($("classFocusRow"));

      const labelOf = (c) => (invMap && invMap[c] !== undefined) ? String(invMap[c]) : String(c);

      const support = new Map();
      for (const t of yTrue) support.set(t, (support.get(t) || 0) + 1);
      const classes = Array.from(support.keys()).sort((a, b) => (support.get(b) || 0) - (support.get(a) || 0));
      const shown = classes.slice(0, Math.min(maxClasses, classes.length));

      const idx = new Map(shown.map((c, i) => [c, i]));
      const k = shown.length;
      const mat = Array.from({ length: k }, () => new Array(k).fill(0));
      const rowSum = new Array(k).fill(0);

      for (let i = 0; i < yTrue.length; i++) {
        const ti = idx.get(yTrue[i]);
        const pi = idx.get(yPred[i]);
        if (ti === undefined || pi === undefined) continue;
        mat[ti][pi] += 1;
        rowSum[ti] += 1;
      }

      let maxFrac = 0;
      for (let r = 0; r < k; r++) {
        const denom = Math.max(1, rowSum[r]);
        for (let c = 0; c < k; c++) maxFrac = Math.max(maxFrac, mat[r][c] / denom);
      }
      maxFrac = Math.max(1e-9, maxFrac);

      const head = [
        `<th class="stickyCol">true \\\\ pred</th>`,
        ...shown.map(c => `<th>${escapeHtml(labelOf(c))}</th>`),
      ].join("");

      const rows = [];
      for (let r = 0; r < k; r++) {
        const trLabel = escapeHtml(labelOf(shown[r]));
        const denom = Math.max(1, rowSum[r]);
        const cells = [];
        cells.push(`<td class="stickyCol">${trLabel}</td>`);
        for (let c = 0; c < k; c++) {
          const v = mat[r][c];
          const frac = v / denom;
          const a = 0.10 + 0.74 * Math.pow(frac / maxFrac, 0.85);
          const isDiag = (r === c);
          const cls = `cmCell${isDiag ? " cmDiag" : ""}`;
          const title = `${labelOf(shown[r])} → ${labelOf(shown[c])}: ${v} (${(frac * 100).toFixed(1)}%)`;
          cells.push(`<td class="${cls}" title="${escapeHtml(title)}" style="background: rgba(139,92,246,${a.toFixed(3)});">${v}</td>`);
        }
        rows.push(`<tr>${cells.join("")}</tr>`);
      }

      $("secondaryMatrix").innerHTML = `<table class="cm"><thead><tr>${head}</tr></thead><tbody>${rows.join("")}</tbody></table>`;

      const sel = $("classFocus");
      const cur = sel.value;
      const opts = [`<option value="">(all classes)</option>`]
        .concat(shown.map(c => `<option value="${escapeHtml(String(c))}">${escapeHtml(labelOf(c))}</option>`));
      sel.innerHTML = opts.join("");
      if (cur) sel.value = cur;

      const updateMetrics = () => {
        const v = sel.value;
        if (!v) { $("classMetrics").textContent = "Select a class for precision/recall/micro-F1 (one-vs-rest)."; return; }
        const clsId = Number(v);
        let tp = 0, fp = 0, fn = 0, supportN = 0;
        for (let i = 0; i < yTrue.length; i++) {
          const t = yTrue[i], p = yPred[i];
          if (t === clsId) { supportN++; if (p === clsId) tp++; else fn++; }
          else { if (p === clsId) fp++; }
        }
        const prec = tp / Math.max(1, tp + fp);
        const rec = tp / Math.max(1, tp + fn);
        const f1 = (prec + rec) ? (2 * prec * rec) / (prec + rec) : 0;
        $("classMetrics").innerHTML =
          `Precision <span class="mono">${formatNum(prec, 4)}</span> · ` +
          `Recall <span class="mono">${formatNum(rec, 4)}</span> · ` +
          `Micro-F1 <span class="mono">${formatNum(f1, 4)}</span> · ` +
          `Support <span class="mono">${supportN}</span>`;
      };
      sel.onchange = updateMetrics;
      updateMetrics();
    }

    // ----------------------------
    // Feature importance aggregation
    // ----------------------------
    function aggregateFI(fiDerived, featureNames, baseForDerived) {
      const agg = new Map();
      for (let i = 0; i < fiDerived.length; i++) {
        const base = baseForDerived[i] || featureNames[i] || `f${i}`;
        agg.set(base, (agg.get(base) || 0) + (Number.isFinite(fiDerived[i]) ? fiDerived[i] : 0));
      }
      return Array.from(agg.entries())
        .map(([name, imp]) => ({ name, imp }))
        .sort((a,b)=>b.imp-a.imp);
    }

    // ----------------------------
    // Prune → retrain (feature selection loop)
    // ----------------------------
    function currentIncludedFeatureCols() {
      const targetCol = APP.raw.targetCol;
      const meta = APP.raw.colMeta || {};
      return APP.raw.columns.filter(c => c !== targetCol && meta[c]?.include);
    }

    function normalizeFi(fiBase) {
      const xs = (fiBase || [])
        .filter(x => x && typeof x.name === "string" && Number.isFinite(x.imp))
        .map(x => ({ name: x.name, imp: Math.max(0, Number(x.imp)) }));
      const sum = xs.reduce((a, x) => a + x.imp, 0);
      if (!(sum > 0)) return [];
      let cum = 0;
      return xs.map(x => {
        const frac = x.imp / sum;
        cum += frac;
        return { name: x.name, imp: x.imp, frac, cum };
      });
    }

    const PRUNE_SHOW_THRESHOLD = 0.002;

    function applyExclusionsAndRetrain({ dropCols, reason }) {
      const cols = (dropCols || []).filter(c => c && c !== APP.raw.targetCol);
      if (!cols.length) return;
      if (APP.ui.training.isTraining) return;

      APP.ui.pruneUndoExcluded = new Set(APP.setup.excluded);
      APP.ui.pruneUndoReason = reason || "prune";
      APP.ui.pruneJustApplied = true;

      for (const c of cols) APP.setup.excluded.add(c);
      syncHiddenTypingLists();
      recomputeColumnMeta();
      refreshSplitDateCol();
      syncSetupUI();
      renderColumnTable();
      syncButtons();

      gotoStep(2);
      setTimeout(() => trainModel(), 50);
    }

    function undoLastPrune() {
      if (!APP.ui.pruneUndoExcluded) return;
      if (APP.ui.training.isTraining) return;
      APP.setup.excluded = new Set(APP.ui.pruneUndoExcluded);
      APP.ui.pruneUndoExcluded = null;
      APP.ui.pruneUndoReason = "";
      APP.ui.pruneJustApplied = false;
      syncHiddenTypingLists();
      recomputeColumnMeta();
      refreshSplitDateCol();
      syncSetupUI();
      renderColumnTable();
      syncButtons();
      updatePruneMiniUi();
    }

    function updatePruneMiniUi() {
      const hasModel = Boolean(APP.train.model && APP.train.pipeline);
      $("pruneUndoBtn").disabled = !APP.ui.pruneUndoExcluded;

      if (!hasModel) {
        hide($("pruneImpRow"));
        $("pruneImpBtn").disabled = true;
        $("pruneShiftTopBtn").disabled = true;
        $("pruneMiniHint").textContent = "Train a model to enable pruning.";
        return;
      }

      const fiNorm = normalizeFi(APP.train.fiBase);
      const hasFi = fiNorm.length > 0;
      const includedCols = currentIncludedFeatureCols();
      const hasLow = hasFi && fiNorm.some(x => includedCols.includes(x.name) && x.frac < PRUNE_SHOW_THRESHOLD);
      if (hasLow) show($("pruneImpRow"));
      else hide($("pruneImpRow"));
      $("pruneImpBtn").disabled = !(hasFi && hasLow);

      const shift = APP.train.shift;
      const shiftScore = shift?.oobBalAcc ?? shift?.oobAcc ?? null;
      const shiftReady = (shiftScore !== null) && shiftScore >= 0.75 && Array.isArray(shift?.fiBase) && normalizeFi(shift.fiBase).length;
      $("pruneShiftTopBtn").disabled = !shiftReady;

      const included = currentIncludedFeatureCols().length;
      const excluded = APP.setup.excluded?.size || 0;
      const shiftTxt = (shiftScore === null) ? "shift: n/a" : `shift=${formatNum(shiftScore, 3)}`;
      $("pruneMiniHint").textContent = `Included=${included} · Excluded=${excluded} · ${shiftTxt}`;
    }

    // ----------------------------
    // Predictions explorer
    // ----------------------------
    function updateUncertaintyPills() {
      const task = APP.train.pipeline?.task || "";
      const metric = (task === "regression") ? "tree std" : "1 - vote_frac";

      const p = $("uncertaintyPill");
      if (!APP.train.model || !APP.train.pipeline) {
        p.className = "pill";
        p.textContent = "Uncertainty: —";
        p.title = "";
        return;
      }

      const st = APP.train.uncertaintyStatus || "none";
      if (st === "running") {
        p.className = "pill warn";
        p.textContent = `Uncertainty: computing (${metric})`;
        p.title = "Computing how much the trees disagree for each test row.";
      } else if (st === "ready") {
        p.className = "pill good";
        p.textContent = `Uncertainty: ready (${metric})`;
        p.title = "Higher means less agreement across trees (less confidence).";
      } else if (st === "error") {
        p.className = "pill bad";
        p.textContent = "Uncertainty: failed";
        p.title = APP.train.uncertaintyError || "";
      } else {
        p.className = "pill";
        p.textContent = "Uncertainty: —";
        p.title = "";
      }
    }

    async function computeTreeDisagreementUncertainty({ model, X, pipeline, ensemblePred, signal }) {
      if (!model || !pipeline || !Array.isArray(X)) throw new Error("Missing model/pipeline/X.");
      const task = pipeline.task;
      const nRows = X.length;

      if (signal?.aborted) throw new DOMException("Aborted", "AbortError");

      const tryPredictionValues = async () => {
        if (typeof model.predictionValues !== "function") return null;
        let predValues;
        try {
          predValues = model.predictionValues(X);
        } catch (e) {
          try {
            predValues = model.predictionValues(new Matrix(X));
          } catch {
            throw e;
          }
        }
        if (!Array.isArray(predValues) || predValues.length === 0) throw new Error("predictionValues() returned no data.");
        if (!Array.isArray(predValues[0])) throw new Error("predictionValues() returned unexpected shape.");

        const n0 = predValues.length;
        const n1 = Array.isArray(predValues[0]) ? predValues[0].length : 0;
        const shape = (n0 === nRows) ? "rowMajor"
          : (n1 === nRows) ? "treeMajor"
          : "unknown";
        if (shape === "unknown") throw new Error(`predictionValues() shape mismatch (got ${n0}x${n1}, expected ${nRows} rows).`);
        const nTrees = (shape === "rowMajor") ? (predValues[0]?.length || 0) : predValues.length;
        if (!nTrees) throw new Error("predictionValues() reported 0 trees.");

        if (task === "regression") {
          const mean = new Float64Array(nRows);
          const m2 = new Float64Array(nRows);
          const count = new Uint16Array(nRows);

          if (shape === "rowMajor") {
            for (let i = 0; i < nRows; i++) {
              if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
              const row = predValues[i];
              if (!Array.isArray(row) || !row.length) continue;
              let c = 0;
              let mu = 0;
              let m2i = 0;
              for (let t = 0; t < row.length; t++) {
                const x = Number(row[t]);
                if (!Number.isFinite(x)) continue;
                c++;
                const d1 = x - mu;
                mu += d1 / c;
                const d2 = x - mu;
                m2i += d1 * d2;
              }
              count[i] = Math.min(65535, c);
              mean[i] = mu;
              m2[i] = m2i;
              if (i % 4000 === 0) await new Promise(r => setTimeout(r, 0));
            }
          } else {
            for (let t = 0; t < predValues.length; t++) {
              if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
              const tree = predValues[t];
              if (!Array.isArray(tree) || tree.length !== nRows) throw new Error("predictionValues() tree length mismatch.");
              for (let i = 0; i < nRows; i++) {
                const x = Number(tree[i]);
                if (!Number.isFinite(x)) continue;
                const c = (count[i] + 1);
                count[i] = c;
                const d1 = x - mean[i];
                mean[i] += d1 / c;
                const d2 = x - mean[i];
                m2[i] += d1 * d2;
              }
              if (t % 5 === 0) await new Promise(r => setTimeout(r, 0));
            }
          }

          const treeStd = new Float64Array(nRows);
          const uncertainty = new Float64Array(nRows);
          for (let i = 0; i < nRows; i++) {
            const c = count[i];
            const v = (c > 1) ? (m2[i] / (c - 1)) : 0;
            const s = Number.isFinite(v) && v > 0 ? Math.sqrt(v) : 0;
            treeStd[i] = s;
            uncertainty[i] = s;
          }

          return {
            uncertainty: Array.from(uncertainty),
            details: { treeStd: Array.from(treeStd), treeMean: Array.from(mean), treeCount: Array.from(count) },
          };
        }

        if (task === "classification") {
          const numClasses = pipeline.target?.numClasses || null;
          const voteFracMode = new Float64Array(nRows);
          const voteMargin = new Float64Array(nRows);
          const voteEntropy = new Float64Array(nRows);
          const uncertainty = new Float64Array(nRows);

          const canDenseCount = Number.isFinite(numClasses) && numClasses > 0 && numClasses <= 200 && (nRows * numClasses) <= 10_000_000;
          if (canDenseCount && shape === "treeMajor") {
            const k = numClasses;
            const counts = new Uint16Array(nRows * k);
            for (let t = 0; t < predValues.length; t++) {
              if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
              const tree = predValues[t];
              if (!Array.isArray(tree) || tree.length !== nRows) throw new Error("predictionValues() tree length mismatch.");
              for (let i = 0; i < nRows; i++) {
                const cls = Number(tree[i]);
                if (!Number.isFinite(cls)) continue;
                const c = Math.floor(cls);
                if (c < 0 || c >= k) continue;
                const idx = i * k + c;
                if (counts[idx] < 65535) counts[idx]++;
              }
              if (t % 5 === 0) await new Promise(r => setTimeout(r, 0));
            }
            for (let i = 0; i < nRows; i++) {
              let maxC = 0, secondC = 0, sumC = 0;
              let ent = 0;
              const base = i * k;
              for (let c = 0; c < k; c++) {
                const v = counts[base + c];
                sumC += v;
                if (v >= maxC) { secondC = maxC; maxC = v; }
                else if (v > secondC) secondC = v;
              }
              const denom = Math.max(1, sumC);
              for (let c = 0; c < k; c++) {
                const v = counts[base + c];
                if (!v) continue;
                const p = v / denom;
                ent += -p * Math.log(p);
              }
              const frac = maxC / denom;
              const mar = (maxC - secondC) / denom;
              const entNorm = (k > 1) ? (ent / Math.log(k)) : 0;
              voteFracMode[i] = frac;
              voteMargin[i] = mar;
              voteEntropy[i] = entNorm;
              uncertainty[i] = 1 - frac;
            }
          } else {
            throw new Error("predictionValues() classification fallback unsupported for this shape/classes.");
          }

          return {
            uncertainty: Array.from(uncertainty),
            details: {
              voteFracMode: Array.from(voteFracMode),
              voteMargin: Array.from(voteMargin),
              voteEntropy: Array.from(voteEntropy),
              nTrees,
            }
          };
        }

        throw new Error(`Unknown task: ${task}`);
      };

      const tryEstimators = async () => {
        const est = model.estimators;
        if (!Array.isArray(est) || !est.length) throw new Error("Model has no estimators.");
        const nTrees = est.length;
        let Xm = null;
        const treePredict = (t) => {
          try {
            return est[t].predict(X);
          } catch (e) {
            try {
              if (!Xm) Xm = new Matrix(X);
              return est[t].predict(Xm);
            } catch {
              throw e;
            }
          }
        };

        if (task === "regression") {
          const mean = new Float64Array(nRows);
          const m2 = new Float64Array(nRows);
          const count = new Uint16Array(nRows);

          for (let t = 0; t < nTrees; t++) {
            if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
            const treePred = treePredict(t);
            if (!Array.isArray(treePred) || treePred.length !== nRows) throw new Error("Estimator prediction length mismatch.");
            for (let i = 0; i < nRows; i++) {
              const x = Number(treePred[i]);
              if (!Number.isFinite(x)) continue;
              const c = (count[i] + 1);
              count[i] = c;
              const d1 = x - mean[i];
              mean[i] += d1 / c;
              const d2 = x - mean[i];
              m2[i] += d1 * d2;
            }
            if (t % 5 === 0) await new Promise(r => setTimeout(r, 0));
          }

          const treeStd = new Float64Array(nRows);
          const uncertainty = new Float64Array(nRows);
          for (let i = 0; i < nRows; i++) {
            const c = count[i];
            const v = (c > 1) ? (m2[i] / (c - 1)) : 0;
            const s = Number.isFinite(v) && v > 0 ? Math.sqrt(v) : 0;
            treeStd[i] = s;
            uncertainty[i] = s;
          }

          return {
            uncertainty: Array.from(uncertainty),
            details: { treeStd: Array.from(treeStd), treeMean: Array.from(mean), treeCount: Array.from(count) },
          };
        }

        if (task === "classification") {
          const numClasses = pipeline.target?.numClasses || null;
          const canDenseCount = Number.isFinite(numClasses) && numClasses > 0 && numClasses <= 200 && (nRows * numClasses) <= 10_000_000;

          const voteFracMode = new Float64Array(nRows);
          const voteMargin = new Float64Array(nRows);
          const voteEntropy = new Float64Array(nRows);
          const uncertainty = new Float64Array(nRows);

          if (canDenseCount) {
            const k = numClasses;
            const counts = new Uint16Array(nRows * k);
            for (let t = 0; t < nTrees; t++) {
              if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
              const treePred = treePredict(t);
              if (!Array.isArray(treePred) || treePred.length !== nRows) throw new Error("Estimator prediction length mismatch.");
              for (let i = 0; i < nRows; i++) {
                const cls = Number(treePred[i]);
                if (!Number.isFinite(cls)) continue;
                const c = Math.floor(cls);
                if (c < 0 || c >= k) continue;
                const idx = i * k + c;
                if (counts[idx] < 65535) counts[idx]++;
              }
              if (t % 5 === 0) await new Promise(r => setTimeout(r, 0));
            }

            for (let i = 0; i < nRows; i++) {
              let maxC = 0, secondC = 0, sumC = 0;
              let ent = 0;
              const base = i * k;
              for (let c = 0; c < k; c++) {
                const v = counts[base + c];
                sumC += v;
                if (v >= maxC) { secondC = maxC; maxC = v; }
                else if (v > secondC) secondC = v;
              }
              const denom = Math.max(1, sumC);
              for (let c = 0; c < k; c++) {
                const v = counts[base + c];
                if (!v) continue;
                const p = v / denom;
                ent += -p * Math.log(p);
              }
              const frac = maxC / denom;
              const mar = (maxC - secondC) / denom;
              const entNorm = (k > 1) ? (ent / Math.log(k)) : 0;
              voteFracMode[i] = frac;
              voteMargin[i] = mar;
              voteEntropy[i] = entNorm;
              uncertainty[i] = 1 - frac;
            }

            return {
              uncertainty: Array.from(uncertainty),
              details: {
                voteFracMode: Array.from(voteFracMode),
                voteMargin: Array.from(voteMargin),
                voteEntropy: Array.from(voteEntropy),
                nTrees,
              }
            };
          }

          // Fallback for large/unknown class counts: agreement with ensemble prediction.
          if (!Array.isArray(ensemblePred) || ensemblePred.length !== nRows) throw new Error("Need ensemblePred for classification uncertainty fallback.");
          const agree = new Uint16Array(nRows);
          for (let t = 0; t < nTrees; t++) {
            if (signal?.aborted) throw new DOMException("Aborted", "AbortError");
            const treePred = treePredict(t);
            if (!Array.isArray(treePred) || treePred.length !== nRows) throw new Error("Estimator prediction length mismatch.");
            for (let i = 0; i < nRows; i++) {
              if (Number(treePred[i]) === Number(ensemblePred[i])) agree[i]++;
            }
            if (t % 5 === 0) await new Promise(r => setTimeout(r, 0));
          }
          for (let i = 0; i < nRows; i++) {
            const frac = agree[i] / Math.max(1, nTrees);
            voteFracMode[i] = frac;
            voteMargin[i] = NaN;
            voteEntropy[i] = NaN;
            uncertainty[i] = 1 - frac;
          }
          return {
            uncertainty: Array.from(uncertainty),
            details: { voteFracMode: Array.from(voteFracMode), voteMargin: null, voteEntropy: null, nTrees },
          };
        }

        throw new Error(`Unknown task: ${task}`);
      };

      try {
        const out = await tryPredictionValues();
        if (out) return out;
      } catch (e) {
        // Fall through to estimator-based computation.
      }
      return await tryEstimators();
    }

    function currentPredView() {
      const pageSize = Math.max(10, Math.floor(parseNum($("pageSize").value) || 50));
      const filter = normStr($("predFilter").value).toLowerCase();
      APP.ui.predFilter = filter;

      const yTrueDisp = APP.train.pipeline.task === "classification"
        ? APP.train.yTest.map(v => String(APP.train.pipeline.targetInvMapping?.[v] ?? v))
        : APP.train.yTest.map(v => String(v));

      const yPredDisp = APP.train.pipeline.task === "classification"
        ? APP.train.yPredLabel
        : APP.train.yPred.map(v => String(v));

      const idxAll = Array.from({ length: APP.train.yTest.length }, (_, i) => i);
      const idxFiltered = filter
        ? idxAll.filter(i => (yTrueDisp[i] || "").toLowerCase().includes(filter) || (yPredDisp[i] || "").toLowerCase().includes(filter))
        : idxAll;

      const n = idxFiltered.length;
      const maxPage = Math.max(0, Math.ceil(n / pageSize) - 1);
      APP.ui.predPage = Math.max(0, Math.min(APP.ui.predPage, maxPage));

      const start = APP.ui.predPage * pageSize;
      const end = Math.min(n, start + pageSize);
      const pageIdx = idxFiltered.slice(start, end);

      return { pageSize, filter, idxFiltered, pageIdx, n, start, end, maxPage, yTrueDisp, yPredDisp };
    }

    function renderPredTable() {
      const targetCol = APP.raw.targetCol;
      const featureCols = APP.raw.columns.filter(c => c !== targetCol);
      const colsShown = featureCols.slice(0, Math.min(10, featureCols.length));

      const view = currentPredView();

      const headCols = ["__y_true__", "__y_pred__", "__err__", "__abs_err__", "__uncertainty__"].concat(colsShown);
      const thead = "<thead><tr>" + headCols.map(c => `<th>${escapeHtml(c)}</th>`).join("") + "</tr></thead>";

      const rowsHtml = view.pageIdx.map(i => {
        const r = APP.train.testRowRefs[i];

        const yt = view.yTrueDisp[i];
        const yp = view.yPredDisp[i];

        const err = APP.train.err[i];
        const absErr = APP.train.absErr[i];
        const unc = Array.isArray(APP.train.uncertainty) ? APP.train.uncertainty[i] : null;

        const cells = [
          `<td class="mono">${escapeHtml(String(yt))}</td>`,
          `<td class="mono">${escapeHtml(String(yp))}</td>`,
          `<td class="mono">${escapeHtml(String(Number.isFinite(err) ? formatNum(err, 6) : err))}</td>`,
          `<td class="mono">${escapeHtml(String(Number.isFinite(absErr) ? formatNum(absErr, 6) : absErr))}</td>`,
          `<td class="mono">${escapeHtml(String(Number.isFinite(unc) ? formatNum(unc, 6) : ""))}</td>`,
        ];

        for (const c of colsShown) {
          cells.push(`<td>${escapeHtml(truncate(normStr(r[c]) || "", 200))}</td>`);
        }

        return `<tr>${cells.join("")}</tr>`;
      }).join("");

      $("predTable").innerHTML = thead + `<tbody>${rowsHtml}</tbody>`;
    }

    function renderPredInsights() {
      if (!APP.train.model || !APP.train.pipeline) return;
      updateUncertaintyPills();

      const targetCol = APP.raw.targetCol;
      const featureCols = APP.raw.columns.filter(c => c !== targetCol);
      const colsShown = featureCols.slice(0, Math.min(6, featureCols.length));

      const topK = Math.max(10, Math.floor(parseNum($("predTopK").value) || 30));
      const n = APP.train.testRowRefs.length;

      const idxAll = Array.from({ length: n }, (_, i) => i);
      const uncReady = Array.isArray(APP.train.uncertainty) && APP.train.uncertainty.length === n;
      const idxWorst = idxAll
        .slice()
        .sort((a, b) => {
          const da = APP.train.absErr[a] || 0;
          const db = APP.train.absErr[b] || 0;
          if (db !== da) return db - da;
          if (!uncReady) return 0;
          return (APP.train.uncertainty[b] || 0) - (APP.train.uncertainty[a] || 0);
        })
        .slice(0, Math.min(topK, n));

      const idxUnc = uncReady
        ? idxAll.slice().sort((a, b) => (APP.train.uncertainty[b] || 0) - (APP.train.uncertainty[a] || 0)).slice(0, Math.min(topK, n))
        : [];

      const task = APP.train.pipeline.task;
      const inv = APP.train.pipeline.targetInvMapping;
      const yTrueDisp = (task === "classification")
        ? APP.train.yTest.map(v => String(inv?.[v] ?? v))
        : APP.train.yTest.map(v => String(v));
      const yPredDisp = (task === "classification")
        ? APP.train.yPredLabel
        : APP.train.yPred.map(v => String(v));

      const renderRankTable = (tableId, idx, emptyText) => {
        const headCols = ["i", "y_true", "y_pred", "err", "abs_err", "uncertainty"].concat(colsShown);
        const thead = "<thead><tr>" + headCols.map(c => `<th>${escapeHtml(c)}</th>`).join("") + "</tr></thead>";
        if (!idx.length) {
          $(tableId).innerHTML = thead + `<tbody><tr><td colspan="${headCols.length}" class="muted2">${escapeHtml(emptyText)}</td></tr></tbody>`;
          return;
        }
        const rowsHtml = idx.map(i => {
          const r = APP.train.testRowRefs[i];
          const yt = yTrueDisp[i];
          const yp = yPredDisp[i];
          const err = APP.train.err[i];
          const absErr = APP.train.absErr[i];
          const unc = uncReady ? APP.train.uncertainty[i] : null;
          const cells = [
            `<td class="mono">${i}</td>`,
            `<td class="mono">${escapeHtml(String(yt))}</td>`,
            `<td class="mono">${escapeHtml(String(yp))}</td>`,
            `<td class="mono">${escapeHtml(String(Number.isFinite(err) ? formatNum(err, 6) : err))}</td>`,
            `<td class="mono">${escapeHtml(String(Number.isFinite(absErr) ? formatNum(absErr, 6) : absErr))}</td>`,
            `<td class="mono">${escapeHtml(String(Number.isFinite(unc) ? formatNum(unc, 6) : ""))}</td>`,
          ];
          for (const c of colsShown) {
            cells.push(`<td>${escapeHtml(truncate(normStr(r[c]) || "", 200))}</td>`);
          }
          return `<tr>${cells.join("")}</tr>`;
        }).join("");
        $(tableId).innerHTML = thead + `<tbody>${rowsHtml}</tbody>`;
      };

      renderRankTable("worstErrTable", idxWorst, "No rows.");
      const uncStatus = APP.train.uncertaintyStatus || "none";
      const uncEmpty = uncReady
        ? "No rows."
        : (uncStatus === "error")
          ? `Uncertainty failed: ${APP.train.uncertaintyError || "unknown error"}`
          : "Uncertainty is still computing (tree disagreement).";
      renderRankTable("highUncTable", idxUnc, uncEmpty);

      renderErrVsUncChart();
    }

    function renderErrVsUncChart() {
      const pl = APP.train.pipeline;
      if (!pl) return;

      const n = APP.train.testRowRefs.length;
      const uncReady = Array.isArray(APP.train.uncertainty) && APP.train.uncertainty.length === n;
      if (!uncReady) {
        $("errUncPill").className = "pill warn";
        $("errUncPill").textContent = "waiting for uncertainty…";
        APP.ui.charts.errUnc = destroyChart(APP.ui.charts.errUnc);
        return;
      }

      const maxPts = Math.min(2000, n);
      const rng = mulberry32(2025);
      const idx = Array.from({ length: n }, (_, i) => i);
      shuffleInPlace(idx, rng);
      const pick = idx.slice(0, maxPts);

      const pts = [];
      for (let j = 0; j < pick.length; j++) {
        const i = pick[j];
        const x0 = APP.train.absErr[i];
        const y0 = APP.train.uncertainty[i];
        if (!Number.isFinite(x0) || !Number.isFinite(y0)) continue;
        const x = (pl.task === "classification") ? (x0 + (rng() - 0.5) * 0.06) : x0;
        pts.push({ x, y: y0 });
      }

      $("errUncPill").className = "pill";
      $("errUncPill").textContent = `n=${pts.length}`;

      const ctx = $("errUncChart").getContext("2d");
      APP.ui.charts.errUnc = destroyChart(APP.ui.charts.errUnc);
      APP.ui.charts.errUnc = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [
            { label: "abs(error) vs uncertainty", data: pts, pointRadius: 2 },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "abs(error)" }, ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } },
            y: { title: { display: true, text: "uncertainty (tree disagreement)" }, ticks: { color: "rgba(234,240,255,0.75)" }, grid: { color: "rgba(234,240,255,0.08)" } },
          }
        }
      });
    }

    function buildPredictionsCsv() {
      const targetCol = APP.raw.targetCol;
      const cols = ["y_true", "y_pred", "err", "abs_err", "uncertainty"];
      if (APP.train.pipeline.task === "classification") cols.push("vote_frac_mode", "vote_margin", "vote_entropy");
      if (APP.train.pipeline.task === "regression") cols.push("tree_std");
      cols.push(...APP.raw.columns.filter(c => c !== targetCol));
      const inv = APP.train.pipeline.targetInvMapping;

      const lines = [];
      lines.push(cols.map(csvCell).join(","));

      for (let i = 0; i < APP.train.testRowRefs.length; i++) {
        const r = APP.train.testRowRefs[i];

        let yt = APP.train.yTest[i];
        let yp = APP.train.yPred[i];

        if (APP.train.pipeline.task === "classification") {
          yt = inv?.[yt] ?? yt;
          yp = APP.train.yPredLabel[i];
        }

        const row = [];
        row.push(String(yt));
        row.push(String(yp));
        row.push(String(APP.train.err?.[i] ?? ""));
        row.push(String(APP.train.absErr?.[i] ?? ""));
        row.push(String(Array.isArray(APP.train.uncertainty) ? (APP.train.uncertainty[i] ?? "") : ""));
        if (APP.train.pipeline.task === "classification") {
          const d = APP.train.uncertaintyDetails || {};
          row.push(String(Array.isArray(d.voteFracMode) ? (d.voteFracMode[i] ?? "") : ""));
          row.push(String(Array.isArray(d.voteMargin) ? (d.voteMargin[i] ?? "") : ""));
          row.push(String(Array.isArray(d.voteEntropy) ? (d.voteEntropy[i] ?? "") : ""));
        }
        if (APP.train.pipeline.task === "regression") {
          const d = APP.train.uncertaintyDetails || {};
          row.push(String(Array.isArray(d.treeStd) ? (d.treeStd[i] ?? "") : ""));
        }
        for (const c of APP.raw.columns.filter(c => c !== targetCol)) row.push(normStr(r[c]) || "");

        lines.push(row.map(csvCell).join(","));
      }

      return lines.join("\n");
    }

    // ----------------------------
    // Training
    // ----------------------------
    function trainingStatusHtml(task, completedUnits, totalUnits, startMs) {
      const elapsedMs = performance.now() - startMs;
      let etaText = "estimating…";
      if (completedUnits > 0 && totalUnits > 0) {
        const msPerUnit = elapsedMs / Math.max(1, completedUnits);
        const remainingMs = msPerUnit * Math.max(0, totalUnits - completedUnits);
        etaText = formatDuration(remainingMs);
      }

      const prog = (totalUnits > 0)
        ? `Tree <span class="mono">${completedUnits}</span>/<span class="mono">${totalUnits}</span>`
        : `Tree <span class="mono">${completedUnits}</span>`;

      return `<span class="spinner"></span> Training (${escapeHtml(task)})… ` +
        `<span class="muted2">${prog} · Elapsed <span class="mono">${formatDuration(elapsedMs)}</span> · ETA <span class="mono">${etaText}</span></span>`;
    }

    function trainingCalloutBodyHtml(task, completedUnits, totalUnits, startMs) {
      const elapsedMs = performance.now() - startMs;
      let etaText = "estimating…";
      if (completedUnits > 0 && totalUnits > 0) {
        const msPerUnit = elapsedMs / Math.max(1, completedUnits);
        const remainingMs = msPerUnit * Math.max(0, totalUnits - completedUnits);
        etaText = formatDuration(remainingMs);
      }

      const prog = (totalUnits > 0)
        ? `Tree <span class="mono">${completedUnits}</span>/<span class="mono">${totalUnits}</span>`
        : `Tree <span class="mono">${completedUnits}</span>`;

      return `<span class="spinner"></span> ` +
        `<span class="mono">${escapeHtml(task)}</span> · ` +
        `<span class="muted2">${prog} · Elapsed <span class="mono">${formatDuration(elapsedMs)}</span> · ETA <span class="mono">${etaText}</span></span>`;
    }

    function setResultsSidePanel({ visible, title, bodyHtml, cls }) {
      const panel = $("resultsSidePanel");
      const titleEl = $("resultsSideTitle");
      const bodyEl = $("resultsSideBody");
      if (!panel || !titleEl || !bodyEl) return;
      if (!visible) {
        panel.className = "callout hidden";
        titleEl.textContent = "—";
        bodyEl.textContent = "—";
        return;
      }
      panel.className = `callout ${cls || ""}`.trim();
      titleEl.textContent = title || "";
      bodyEl.innerHTML = bodyHtml || "";
    }

    function renderResultsSidePanel(task) {
      const isTraining = Boolean(APP.ui.training.isTraining);
      const trained = Math.max(0, Math.floor(APP.ui.training.completedUnits || 0));
      const total = Math.max(0, Math.floor(APP.ui.training.totalUnits || 0));

      if (isTraining) {
        setResultsSidePanel({
          visible: true,
          title: "Training",
          bodyHtml: trainingCalloutBodyHtml(task, trained, total, APP.ui.training.startMs),
          cls: "",
        });
        return;
      }

      const prev = APP.ui.prevRunSummary;
      const cur = APP.train.runSummary;
      if (prev && prev.runId && cur && cur.runId && prev.runId !== cur.runId && prev.task === cur.task) {
        const betterIsLower = (cur.task === "regression");
        const a = Number(prev.test?.primary);
        const b = Number(cur.test?.primary);
        const delta = (Number.isFinite(a) && Number.isFinite(b)) ? (b - a) : null;
        const improved = (delta !== null)
          ? (betterIsLower ? (delta < 0) : (delta > 0))
          : null;

        const cls = (improved === null) ? "" : (improved ? "good" : "warn");
        const deltaTxt = (delta === null) ? "n/a" : `${delta >= 0 ? "+" : ""}${formatNum(delta, 6)}`;
        const prevTxt = Number.isFinite(a) ? formatNum(a, 6) : "n/a";
        const curTxt = Number.isFinite(b) ? formatNum(b, 6) : "n/a";

        const oA = Number(prev.oob?.value);
        const oB = Number(cur.oob?.value);
        const oDelta = (Number.isFinite(oA) && Number.isFinite(oB)) ? (oB - oA) : null;
        const oDeltaTxt = (oDelta === null) ? "n/a" : `${oDelta >= 0 ? "+" : ""}${formatNum(oDelta, 6)}`;

        const body =
          `${escapeHtml(cur.test?.primaryLabel || "Test metric")}: <span class="mono">${escapeHtml(curTxt)}</span> (prev <span class="mono">${escapeHtml(prevTxt)}</span>, Δ <span class="mono">${escapeHtml(deltaTxt)}</span>)` +
          (prev.oob?.label && cur.oob?.label
            ? `<div style="margin-top:6px;">${escapeHtml(cur.oob.label)}: <span class="mono">${escapeHtml(Number.isFinite(oB) ? formatNum(oB, 6) : "n/a")}</span> (prev <span class="mono">${escapeHtml(Number.isFinite(oA) ? formatNum(oA, 6) : "n/a")}</span>, Δ <span class="mono">${escapeHtml(oDeltaTxt)}</span>)</div>`
            : "") +
          `<div style="margin-top:6px;">Columns: included <span class="mono">${cur.includedCols}</span> (prev <span class="mono">${prev.includedCols}</span>) · excluded <span class="mono">${cur.excludedCols}</span> (prev <span class="mono">${prev.excludedCols}</span>)</div>`;

        setResultsSidePanel({ visible: true, title: "Compare to previous run", bodyHtml: body, cls });
        return;
      }

      if (isModelReady()) {
        setResultsSidePanel({
          visible: true,
          title: "Done",
          bodyHtml: `Model trained locally. <span class="muted2">Use <span class="mono">Retrain</span> to run again.</span>`,
          cls: "good",
        });
        return;
      }

      setResultsSidePanel({
        visible: true,
        title: "Not trained",
        bodyHtml: `Continue to <span class="mono">Results</span> from <span class="mono">Settings</span> to train a model.`,
        cls: "",
      });
    }

    function updateTrainingCallout(task, completedUnits, totalUnits) {
      if (APP.step !== 2) return;
      renderResultsSidePanel(task);
    }

    function isFrac01(x) {
      return x > 0 && x <= 1;
    }

    function isFloatNotInt(x) {
      return Number(x) === x && x % 1 !== 0;
    }

    function rngFromSeed(seed) {
      if (seed === undefined) return MersenneTwister19937.autoSeed();
      if (Number.isInteger(seed)) return MersenneTwister19937.seed(seed);
      throw new RangeError(`Expected seed must be undefined or integer not ${seed}`);
    }

    function yieldToBrowserPaint() {
      return new Promise(resolve => {
        const raf = window.requestAnimationFrame || ((cb) => setTimeout(cb, 16));
        setTimeout(() => raf(() => setTimeout(resolve, 0)), 0);
      });
    }

    function withTemporaryTrainedEstimators(model, trainedEstimators, fn) {
      if (!model) return fn();
      const k = Math.max(0, Math.floor(trainedEstimators || 0));
      const hasEstimators = Array.isArray(model.estimators);
      const hasIndexes = Array.isArray(model.indexes);
      const prevNE = model.nEstimators;
      const prevEstLen = hasEstimators ? model.estimators.length : null;
      const prevIdxLen = hasIndexes ? model.indexes.length : null;
      try {
        if (hasEstimators) model.estimators.length = k;
        if (hasIndexes) model.indexes.length = k;
        model.nEstimators = k;
        return fn();
      } finally {
        if (hasEstimators && prevEstLen !== null) model.estimators.length = prevEstLen;
        if (hasIndexes && prevIdxLen !== null) model.indexes.length = prevIdxLen;
        model.nEstimators = prevNE;
      }
    }

    function sampleWithBagging(X, y, seed, includeOob) {
      const engine = rngFromSeed(seed);
      const pickRow = integer(0, X.rows - 1);

      const bagIdx = new Array(X.rows);
      const ys = new Array(X.rows);
      const seen = includeOob ? new Uint8Array(X.rows) : null;
      let unseenCount = includeOob ? X.rows : 0;

      for (let i = 0; i < X.rows; i++) {
        const idx = pickRow(engine);
        bagIdx[i] = idx;
        ys[i] = y[idx];
        if (includeOob && seen[idx] === 0) {
          seen[idx] = 1;
          unseenCount--;
        }
      }

      const Xbag = new MatrixRowSelectionView(X, bagIdx);

      let Xoob = null;
      let ioob = [];
      if (includeOob) {
        const oobIdx = new Array(unseenCount);
        let p = unseenCount;
        for (let i = X.rows - 1; i >= 0 && p > 0; --i) {
          if (seen[i] === 0) oobIdx[--p] = i;
        }
        if (oobIdx.length) Xoob = new MatrixRowSelectionView(X, oobIdx);
        ioob = oobIdx;
      }

      return { X: Xbag, y: ys, Xoob, ioob, seed: engine.next() };
    }

    function selectRandomFeatures(X, n, replacement, seed) {
      if (X.columns < n) throw new RangeError("N should be less or equal to the number of columns of X");

      const engine = rngFromSeed(seed);
      const pickCol = integer(0, X.columns - 1);

      let usedIndex;
      if (replacement) {
        usedIndex = new Array(n);
        for (let i = 0; i < n; i++) {
          usedIndex[i] = pickCol(engine);
        }
      } else {
        const used = new Set();
        usedIndex = [];
        while (usedIndex.length < n) {
          const c = pickCol(engine);
          if (used.has(c)) continue;
          used.add(c);
          usedIndex.push(c);
        }
      }

      const Xsub = new MatrixColumnSelectionView(X, usedIndex);
      return { X: Xsub, usedIndex, seed: engine.next() };
    }

    function computeOobResults(oobEntries, y, selectionFn) {
      const all = Array.from({ length: y.length }, () => []);
      for (const entry of oobEntries) {
        if (!entry) continue;
        const idxs = entry.index || [];
        const preds = entry.predicted || [];
        for (let i = 0; i < idxs.length; i++) {
          all[idxs[i]].push(preds[i]);
        }
      }
      return all.map((preds, i) => {
        if (!preds.length) return null;
        return { true: y[i], all: preds, predicted: selectionFn(preds) };
      });
    }

    async function trainForestWithProgress(model, X, y, { onProgress, signal }) {
      let seed = model.seed;
      let Xm = Matrix.checkMatrix(X);
      let ym = y;

      model.maxFeatures = model.maxFeatures || Xm.columns;
      model.numberFeatures = Xm.columns;
      model.numberSamples = Xm.rows;

      if (isFrac01(model.maxFeatures)) model.n = Math.floor(Xm.columns * model.maxFeatures);
      else if (Number.isInteger(model.maxFeatures)) {
        if (model.maxFeatures > Xm.columns) throw new RangeError(`The maxFeatures parameter should be less than ${Xm.columns}`);
        model.n = model.maxFeatures;
      } else {
        throw new RangeError(`Cannot process the maxFeatures parameter ${model.maxFeatures}`);
      }

      if (model.maxSamples) {
        if (model.maxSamples < 0) throw new RangeError("Please choose a positive value for maxSamples");
        if (isFloatNotInt(model.maxSamples)) {
          if (model.maxSamples > 1) throw new RangeError("Please choose either a float value between 0 and 1 or a positive integer for maxSamples");
          model.numberSamples = Math.floor(Xm.rows * model.maxSamples);
        } else if (Number.isInteger(model.maxSamples)) {
          if (model.maxSamples > Xm.rows) throw new RangeError(`The maxSamples parameter should be less than ${Xm.rows}`);
          model.numberSamples = model.maxSamples;
        }
      }

      if (model.maxSamples && Xm.rows !== model.numberSamples) {
        const sub = new Matrix(model.numberSamples, Xm.columns);
        for (let i = 0; i < model.numberSamples; i++) sub.setRow(i, Xm.getRow(i));
        Xm = sub;
        ym = ym.slice(0, model.numberSamples);
      }

      const nEstimators = model.nEstimators;
      const TreeClass = model.isClassifier ? DecisionTreeClassifier : DecisionTreeRegression;

      model.estimators = new Array(nEstimators);
      model.indexes = new Array(nEstimators);

      const includeOob = Boolean(!model.noOOB && model.useSampleBagging);
      const oobEntries = includeOob ? new Array(nEstimators) : null;
      const yieldEvery = Math.max(1, Math.floor(nEstimators / 100));
      const MIN_YIELD_MS = 2000;
      let lastYieldMs = performance.now();

      let trainedEstimators = 0;
      for (let t = 0; t < nEstimators; t++) {
        if (signal?.aborted) break;

        const bag = model.useSampleBagging
          ? sampleWithBagging(Xm, ym, seed, includeOob)
          : { X: Xm, y: ym, seed, Xoob: null, ioob: [] };
        seed = bag.seed;

        const feat = selectRandomFeatures(bag.X, model.n, model.replacement, seed);
        seed = feat.seed;

        model.indexes[t] = feat.usedIndex;
        model.estimators[t] = new TreeClass(model.treeOptions);
        model.estimators[t].train(feat.X, bag.y);

        if (includeOob && bag.Xoob && bag.ioob && bag.ioob.length) {
          const XoobSub = new MatrixColumnSelectionView(bag.Xoob, feat.usedIndex);
          oobEntries[t] = { index: bag.ioob, predicted: model.estimators[t].predict(XoobSub) };
        }

        trainedEstimators = t + 1;
        onProgress(trainedEstimators, nEstimators);

        const now = performance.now();
        const shouldYieldByCount = ((t + 1) < nEstimators && ((t + 1) % yieldEvery === 0));
        const shouldYieldByTime = ((t + 1) < nEstimators && (now - lastYieldMs) >= MIN_YIELD_MS);
        if (shouldYieldByCount || shouldYieldByTime) {
          await new Promise(r => setTimeout(r, 0));
          lastYieldMs = performance.now();
        }
      }

      if (trainedEstimators !== nEstimators) {
        model.estimators = model.estimators.slice(0, trainedEstimators);
        model.indexes = model.indexes.slice(0, trainedEstimators);
        model.nEstimators = trainedEstimators;
      }

      if (includeOob && oobEntries) {
        const used = oobEntries.slice(0, trainedEstimators);
        const oob = computeOobResults(used, ym, model.selection.bind(model));
        const oobPred = oob.map(x => (x && x.predicted !== undefined) ? x.predicted : null);
        const covered = oobPred.reduce((a, v) => a + (v === null ? 0 : 1), 0);
        const complete = oob.length && oob.every(x => x && x.predicted !== null && x.predicted !== undefined);
        if (complete) model.oobResults = oob;
        return { trainedEstimators, stoppedEarly: trainedEstimators !== nEstimators, oobPred, oobCovered: covered };
      }

      return { trainedEstimators, stoppedEarly: trainedEstimators !== nEstimators, oobPred: null, oobCovered: 0 };
    }

    async function trainModel() {
      const abortController = new AbortController();
      APP.ui.training.abortController = abortController;
      APP.ui.training.stopRequested = false;
      setTrainingUi(true);

      APP.ui.training.runSeq = (APP.ui.training.runSeq || 0) + 1;
      const runSeq = APP.ui.training.runSeq;
      APP.ui.shiftAutoExpandedRunSeq = 0;

      try { APP.ui.training.diagAbortController?.abort(); } catch {}
      APP.ui.training.diagAbortController = new AbortController();
      const diagSignal = APP.ui.training.diagAbortController.signal;

      if (APP.train.runSummary) {
        APP.ui.prevRunSummary = { ...APP.train.runSummary };
      }

      APP.ui.training.startMs = performance.now();
      $("trainStatus").innerHTML = `<span class="spinner"></span> Preparing data…`;

      await new Promise(r => setTimeout(r, 0));

      const testFrac = Math.min(0.5, Math.max(0.05, parseNum($("testFrac").value) || 0.1));
      APP.setup.testFrac = testFrac;

      const seed = Math.floor(parseNum($("seed").value) || 42);
      const replacement = ($("replacement").value === "true");
      const nEstimators = Math.max(10, Math.floor(parseNum($("nEstimators").value) || 100));

      const splitMode = effectiveSplitMode();
      const splitDateCol = (splitMode === "time") ? APP.setup.splitDateCol : null;

      let built;
      try {
        built = buildDataset(seed, testFrac, splitMode, splitDateCol);
      } catch (e) {
        $("trainStatus").innerHTML = `<span class="pill bad">Failed</span> <span class="mono">${escapeHtml(e?.message || String(e))}</span>`;
        APP.ui.training.abortController = null;
        APP.ui.training.stopRequested = false;
        setTrainingUi(false);
        return;
      }

      const { Xtrain, ytrain, Xtest, ytest, testRowRefs, trainRowRefs, featureNames, baseForDerived, pipeline, task, dropped } = built;

      if (!pipeline || !Xtrain.length || !Xtest.length) {
        const hint = (!pipeline || !Xtrain.length)
          ? "Check target parsing/transform choice, and ensure enough usable rows exist."
          : "Test split ended up empty after filtering (e.g., unseen labels). Try a different split or larger sample.";
        $("trainStatus").innerHTML = `<span class="pill bad">No usable rows</span> <span class="muted2">${escapeHtml(hint)}</span>`;
        APP.ui.training.abortController = null;
        APP.ui.training.stopRequested = false;
        setTrainingUi(false);
        return;
      }

      const maxFeaturesParsed = parseMaxFeatures($("maxFeaturesMode").value, $("maxFeaturesValue").value, featureNames.length);
      const maxDepth = parseOptionalPositiveInt($("maxDepth")?.value);
      const minNumSamples = parseOptionalPositiveInt($("minNumSamples")?.value);
      const treeOptions = {};
      if (maxDepth !== null) treeOptions.maxDepth = maxDepth;
      if (minNumSamples !== null) treeOptions.minNumSamples = minNumSamples;
      const rfOptions = {
        seed,
        maxFeatures: maxFeaturesParsed,
        replacement,              // feature sampling replacement (usually false)
        nEstimators,
        useSampleBagging: true,   // bootstrap rows (actual “bagging”)
        treeOptions,
      };

      APP.ui.training.totalUnits = nEstimators;
      APP.ui.training.completedUnits = 0;
      $("trainStatus").innerHTML = trainingStatusHtml(task, 0, nEstimators, APP.ui.training.startMs);
      await new Promise(r => setTimeout(r, 0));

      let model;
      let trainInfo;
      try {
        model = (task === "regression") ? new RandomForestRegression(rfOptions) : new RandomForestClassifier(rfOptions);

        APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 2);
        renderStepper();
        if (APP.step === 2) renderResultsPlaceholders();

        const invTarget = buildInverseMapping(pipeline.target.mapping);
        APP.train.rfOptions = rfOptions;
        APP.train.model = model;
        APP.train.pipeline = { ...pipeline, targetInvMapping: invTarget };
        APP.train.featureNames = featureNames;
        APP.train.baseForDerived = baseForDerived;
        APP.train.derivedTypeByFeature = buildDerivedTypeByFeature(featureNames, baseForDerived);
        APP.train.split = {
          trainIdx: Array.from({ length: Xtrain.length }, (_, i) => i),
          testIdx: Array.from({ length: Xtest.length }, (_, i) => i)
        };
        APP.train.testRowRefs = testRowRefs;
        APP.train.dropped = dropped;
        APP.train.shift = null;

        const transform = pipeline.targetTransform;
        const ytestRaw = (pipeline.task === "regression" && transform === "log1p")
          ? ytest.map(v => Math.expm1(v))
          : ytest.slice();
        APP.train.yTest = ytestRaw;
        APP.train.yPred = [];
        APP.train.fiDerived = [];
        APP.train.fiBase = [];

        const LIVE_MIN_MS = 2000;
        let liveLastMs = performance.now();
        let liveTimer = null;
        let liveRefreshing = false;
        let livePending = false;
        let liveErrorCount = 0;

        const runSeqForLive = runSeq;
        const queueLiveUpdate = (force = false) => {
          if (runSeqForLive !== APP.ui.training.runSeq) return;
          if (!APP.ui.training.isTraining) return;
          const now = performance.now();
          const dueIn = force ? 0 : Math.max(0, (liveLastMs + LIVE_MIN_MS) - now);
          if (liveTimer) return;
          liveTimer = setTimeout(async () => {
            liveTimer = null;
            if (runSeqForLive !== APP.ui.training.runSeq) return;
            if (!APP.ui.training.isTraining) return;
            if (liveRefreshing) { livePending = true; return; }
            if (APP.ui.training.completedUnits <= 0) return;
            liveRefreshing = true;
            try {
              const trainedNow = Math.max(1, Math.floor(APP.ui.training.completedUnits || 1));
              const ypredNow = withTemporaryTrainedEstimators(model, trainedNow, () => model.predict(Xtest));
              const ypredRaw = (pipeline.task === "regression" && transform === "log1p")
                ? ypredNow.map(v => Math.expm1(v))
                : (pipeline.task === "regression")
                  ? ypredNow.slice()
                  : ypredNow.map(v => Number(v));

              APP.train.yPred = ypredRaw;

              let fi = null;
              try { fi = withTemporaryTrainedEstimators(model, trainedNow, () => model.featureImportance()); } catch { fi = null; }
              APP.train.fiDerived = (fi && fi.length === featureNames.length)
                ? featureNames.map((name, i) => ({ name, imp: Number.isFinite(fi[i]) ? fi[i] : 0 }))
                    .sort((a,b)=>b.imp-a.imp)
                : [];
              APP.train.fiBase = (fi && fi.length === featureNames.length)
                ? aggregateFI(fi, featureNames, baseForDerived)
                : [];

              if (APP.step === 2) {
                renderResultsLivePartial();
                await yieldToBrowserPaint();
              }
              liveLastMs = performance.now();
            } catch (e) {
              liveErrorCount++;
              if (liveErrorCount <= 3) console.warn("Live results update failed", e);
            }
            liveRefreshing = false;
            if (livePending) { livePending = false; queueLiveUpdate(true); }
          }, dueIn);
        };

        trainInfo = await trainForestWithProgress(model, Xtrain, ytrain, {
          onProgress: (completedUnits, totalUnits) => {
            APP.ui.training.completedUnits = completedUnits;
            APP.ui.training.totalUnits = totalUnits;
            $("trainStatus").innerHTML = trainingStatusHtml(task, completedUnits, totalUnits, APP.ui.training.startMs);
            updateTrainingCallout(task, completedUnits, totalUnits);
            queueLiveUpdate(false);
          },
          signal: abortController.signal,
        });
      } catch (e) {
        if (isAbortError(e) || APP.ui.training.stopRequested) {
          $("trainStatus").innerHTML = `<span class="pill warn">Stopped</span> <span class="muted2">Training aborted.</span>`;
        } else {
          $("trainStatus").innerHTML = `<span class="pill bad">Train failed</span> <span class="mono">${escapeHtml(e?.message || String(e))}</span>`;
        }
        APP.ui.training.abortController = null;
        APP.ui.training.stopRequested = false;
        setTrainingUi(false);
        return;
      }

      if (!trainInfo?.trainedEstimators) {
        $("trainStatus").innerHTML = `<span class="pill warn">Stopped</span> <span class="muted2">No trees were trained.</span>`;
        APP.ui.training.abortController = null;
        APP.ui.training.stopRequested = false;
        setTrainingUi(false);
        return;
      }

      if (trainInfo?.stoppedEarly) {
        $("trainStatus").innerHTML =
          `<span class="spinner"></span> Training stopped early ` +
          `<span class="muted2">(trees <span class="mono">${trainInfo.trainedEstimators}</span>/<span class="mono">${nEstimators}</span>). Scoring…</span>`;
        await new Promise(r => setTimeout(r, 0));
      }

      $("trainStatus").innerHTML = `<span class="spinner"></span> Scoring test split…`;
      await new Promise(r => setTimeout(r, 0));

      let ypred;
      try {
        ypred = model.predict(Xtest);
      } catch (e) {
        if (isAbortError(e) || APP.ui.training.stopRequested) {
          $("trainStatus").innerHTML = `<span class="pill warn">Stopped</span> <span class="muted2">Training aborted.</span>`;
        } else {
          $("trainStatus").innerHTML = `<span class="pill bad">Predict failed</span> <span class="mono">${escapeHtml(e?.message || String(e))}</span>`;
        }
        APP.ui.training.abortController = null;
        APP.ui.training.stopRequested = false;
        setTrainingUi(false);
        return;
      }

      let oobPred = trainInfo?.oobPred || null;
      if (!oobPred) {
        try { oobPred = model.predictOOB(); } catch {}
      }

      let fi = null;
      try { fi = model.featureImportance(); } catch { fi = null; }

      const fiDerived = (fi && fi.length === featureNames.length)
        ? featureNames.map((name, i) => ({ name, imp: Number.isFinite(fi[i]) ? fi[i] : 0 }))
            .sort((a,b)=>b.imp-a.imp)
        : [];

      const fiBase = (fi && fi.length === featureNames.length)
        ? aggregateFI(fi, featureNames, baseForDerived)
        : [];

      const transform = pipeline.targetTransform;
      let ytestRaw = ytest.slice();
      let ypredRaw = ypred.slice();

      if (pipeline.task === "regression" && transform === "log1p") {
        ytestRaw = ytest.map(v => Math.expm1(v));
        ypredRaw = ypred.map(v => Math.expm1(v));
      }

      const invTarget = buildInverseMapping(pipeline.target.mapping);

      APP.train.rfOptions = rfOptions;
      APP.train.model = model;
      APP.train.pipeline = { ...pipeline, targetInvMapping: invTarget };
      APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 2);
      renderStepper();
      APP.train.featureNames = featureNames;
      APP.train.baseForDerived = baseForDerived;
      APP.train.derivedTypeByFeature = buildDerivedTypeByFeature(featureNames, baseForDerived);
      APP.train.split = {
        trainIdx: Array.from({ length: Xtrain.length }, (_, i) => i),
        testIdx: Array.from({ length: Xtest.length }, (_, i) => i)
      };
      APP.train.yTrain = ytrain;
      APP.train.yTest = ytestRaw;
      APP.train.yPred = ypredRaw;
      APP.train.err = new Array(ytestRaw.length);
      APP.train.absErr = new Array(ytestRaw.length);
      APP.train.oobPred = oobPred;
      APP.train.testRowRefs = testRowRefs;
      APP.train.fiDerived = fiDerived;
      APP.train.fiBase = fiBase;
      APP.train.dropped = dropped;
      APP.train.shift = { status: "running" };
      APP.train.uncertainty = null;
      APP.train.uncertaintyDetails = null;
      APP.train.uncertaintyStatus = "running";
      APP.train.uncertaintyError = "";

      if (pipeline.task === "classification") {
        const inv = invTarget || {};
        APP.train.yPredLabel = ypred.map(v => String(inv[v] ?? v));
        APP.train.yTestLabel = ytest.map(v => String(inv[v] ?? v));
      } else {
        APP.train.yPredLabel = ypredRaw.map(v => String(v));
        APP.train.yTestLabel = ytestRaw.map(v => String(v));
      }

      for (let i = 0; i < ytestRaw.length; i++) {
        if (pipeline.task === "regression") {
          const e = Number(ypredRaw[i]) - Number(ytestRaw[i]);
          APP.train.err[i] = e;
          APP.train.absErr[i] = Math.abs(e);
        } else {
          const e = (Number(ypred[i]) === Number(ytest[i])) ? 0 : 1;
          APP.train.err[i] = e;
          APP.train.absErr[i] = e;
        }
      }

      // Run summary (test + OOB, for compare + pruning loop)
      const testSummary = (pipeline.task === "regression")
        ? (() => {
          const rm = rmse(ytestRaw, ypredRaw);
          const ma = mae(ytestRaw, ypredRaw);
          const r = r2(ytestRaw, ypredRaw);
          const rl = rmsle(ytestRaw, ypredRaw);
          return { primaryLabel: "Test RMSE", primary: rm, sub: `MAE=${formatNum(ma,6)} · R²=${formatNum(r,6)} · RMSLE=${rl===null?"n/a":formatNum(rl,6)}` };
        })()
        : (() => {
          const yT = ytest.map(v => Number(v));
          const yP = ypred.map(v => Number(v));
          const acc = accuracy(yT, yP);
          const f1 = f1Macro(yT, yP, pipeline.target.numClasses || 2);
          return { primaryLabel: "Test Accuracy", primary: acc, sub: `Macro-F1=${formatNum(f1,6)} · Classes=${pipeline.target.numClasses}` };
        })();

      let oobSummary = null;
      if (Array.isArray(oobPred) && oobPred.length === ytrain.length) {
        if (pipeline.task === "regression") {
          const ytRaw = (pipeline.targetTransform === "log1p") ? ytrain.map(v => Math.expm1(v)) : ytrain.slice();
          const ypRaw = (pipeline.targetTransform === "log1p")
            ? oobPred.map(v => (v === null || v === undefined) ? null : Math.expm1(v))
            : oobPred.map(v => (v === null || v === undefined) ? null : Number(v));
          const f = filterPaired(ytRaw, ypRaw);
          const cov = f.yTrue.length / Math.max(1, ytrain.length);
          const oobRm = f.yTrue.length ? rmse(f.yTrue, f.yPred) : null;
          oobSummary = { label: "OOB RMSE", value: oobRm, coverage: cov, sub: `OOB cov=${Math.round(cov * 100)}%` };
        } else {
          const f = filterPaired(ytrain.map(v => Number(v)), oobPred.map(v => (v === null || v === undefined) ? null : Number(v)));
          const cov = f.yTrue.length / Math.max(1, ytrain.length);
          const oobAcc = f.yTrue.length ? accuracy(f.yTrue, f.yPred) : null;
          oobSummary = { label: "OOB Accuracy", value: oobAcc, coverage: cov, sub: `OOB cov=${Math.round(cov * 100)}%` };
        }
      }

      APP.train.runSummary = {
        runId: Date.now(),
        task: pipeline.task,
        test: testSummary,
        oob: oobSummary,
        includedCols: currentIncludedFeatureCols().length,
        excludedCols: APP.setup.excluded?.size || 0,
        pruneReason: APP.ui.pruneJustApplied ? (APP.ui.pruneUndoReason || "") : "",
      };
      APP.ui.pruneJustApplied = false;

      // Render results ASAP (test metrics + plots). Diagnostics fill in asynchronously below.
      setResultsTab("overview");
      renderResults();
      gotoStep(2);

      $("trainStatus").innerHTML = `<span class="pill good">Done</span> <span class="muted2">Model trained locally.</span>`;
      showToast("Training complete", "good");
      APP.ui.setupDirty = false;
      APP.ui.training.abortController = null;
      APP.ui.training.stopRequested = false;
      setTrainingUi(false);

      // Background: shift diagnostic
      (async () => {
        try {
          await yieldToBrowserPaint();
          const shift = await computeShiftDiagnostics({
            trainRows: trainRowRefs,
            testRows: testRowRefs,
            pipeline,
            featureNames,
            baseForDerived,
            seed,
            signal: diagSignal,
          });
          if (runSeq !== APP.ui.training.runSeq) return;
          APP.train.shift = shift || null;
          renderShiftSection();
        } catch {
          if (runSeq !== APP.ui.training.runSeq) return;
          APP.train.shift = null;
          renderShiftSection();
        }
      })();

      // Background: uncertainty via tree disagreement (predictionValues)
      (async () => {
        try {
          await yieldToBrowserPaint();
          const out = await computeTreeDisagreementUncertainty({
            model,
            X: Xtest,
            pipeline,
            ensemblePred: (pipeline.task === "classification") ? ypred : null,
            signal: diagSignal,
          });
          if (runSeq !== APP.ui.training.runSeq) return;
          APP.train.uncertainty = out.uncertainty || null;
          APP.train.uncertaintyDetails = out.details || null;
          APP.train.uncertaintyStatus = "ready";
          APP.train.uncertaintyError = "";
        } catch (e) {
          if (runSeq !== APP.ui.training.runSeq) return;
          APP.train.uncertainty = null;
          APP.train.uncertaintyDetails = null;
          APP.train.uncertaintyStatus = "error";
          APP.train.uncertaintyError = e?.message || String(e);
        }
        renderPredInsights();
        renderPredTable();
      })();
    }

    // ----------------------------
    // Results rendering
    // ----------------------------
    function renderShiftSection() {
      const shift = APP.train.shift;
      const isRunning = Boolean(shift && shift.status === "running");
      const shiftScore = shift?.oobBalAcc ?? shift?.oobAcc ?? null;

      if (isRunning) {
        $("shiftPill").className = "pill";
        $("shiftPill").textContent = "Shift: running…";
        $("shiftSummary").textContent = "Training an is_valid model in the background (predict train vs validation).";
        return;
      }

      if (!shift || shiftScore === null) {
        $("shiftPill").className = "pill";
        $("shiftPill").textContent = "Shift: n/a";
        $("shiftSummary").textContent = "Shift diagnostic unavailable (not enough rows, or OOB not available).";
        APP.ui.charts.shift = destroyChart(APP.ui.charts.shift);
        try {
          const c = $("shiftFiChart");
          const ctx = c.getContext("2d");
          ctx.clearRect(0, 0, c.width, c.height);
        } catch {}
        return;
      }

      const details = $("shiftDetails");
      if (details && shiftScore > 0.6 && APP.ui.shiftAutoExpandedRunSeq !== APP.ui.training.runSeq) {
        details.open = true;
        APP.ui.shiftAutoExpandedRunSeq = APP.ui.training.runSeq;
      }

      const cov = shift.nTotal ? (shift.oobCovered / shift.nTotal) : 0;
      const covTxt = `${Math.round(cov * 100)}%`;
      const balTxt = formatNum(shiftScore, 6);
      const accTxt = (shift.oobAcc === null) ? "n/a" : formatNum(shift.oobAcc, 6);
      const f1Txt = (shift.oobF1 === null) ? "n/a" : formatNum(shift.oobF1, 6);
      const baseline = shift.nTotal ? (Math.max(shift.nTrainUsed || 0, shift.nTestUsed || 0) / shift.nTotal) : null;
      const baselineTxt = (baseline === null) ? "n/a" : formatNum(baseline, 6);
      const severity = (shiftScore >= 0.90) ? "bad" : (shiftScore >= 0.75) ? "warn" : "good";

      $("shiftPill").className = `pill ${severity}`.trim();
      $("shiftPill").textContent = `Shift OOB bal-acc=${balTxt}`;
      $("shiftSummary").innerHTML =
        `<div style="margin-bottom:6px;">This trains a second random forest where the target is <span class="mono">is_valid</span>: <span class="mono">0</span>=train, <span class="mono">1</span>=validation.</div>` +
        `<div style="margin-bottom:6px;">If it can easily predict which split a row came from, your validation set is in a different “domain” (time shift, IDs, leakage, changing missingness).</div>` +
        `<div style="margin-bottom:6px;">Interpretation: <span class="mono">~0.50</span> is good (hard to tell); <span class="mono">≥0.75</span> suggests strong shift; <span class="mono">≥0.90</span> is severe.</div>` +
        `<div style="margin-bottom:6px;">Score: OOB bal-acc <span class="mono">${balTxt}</span> · raw acc <span class="mono">${accTxt}</span> · baseline <span class="mono">${baselineTxt}</span> · F1 <span class="mono">${f1Txt}</span> · OOB coverage <span class="mono">${covTxt}</span>.</div>` +
        `<div class="muted2" style="margin-bottom:6px;">Rows used: train=<span class="mono">${shift.nTrainUsed}</span>, valid=<span class="mono">${shift.nTestUsed}</span> (balanced on purpose).</div>` +
        `<div>Use “Top shift drivers” to spot culprits (often IDs, timestamps/elapsed, or proxies for the target). Try excluding them, changing the cutoff, or using only recent data.</div>`;

      renderShiftFIChart(shift.fiBase || []);
      updatePruneMiniUi();
    }

    function renderResultsPlaceholders() {
      const targetCol = APP.raw.targetCol || "—";
      const splitMode = effectiveSplitMode();
      const splitText = splitMode === "time" ? `time-based (${APP.setup.splitDateCol || "—"})` : "random";
      const testText = `${Math.round((APP.setup.testFrac || 0.1) * 100)}%`;
      const maxRowsTxt = String(APP.setup.maxRows || 0) === "0" ? "all" : String(APP.setup.maxRows || "—");
      const estFeatures = estimateDerivedFeatureCount();

      if ($("setupSummary")) $("setupSummary").textContent = `Target=${targetCol} · Split=${splitText} · Test=${testText}`;
      if ($("featureSummary")) $("featureSummary").textContent = `Max rows=${maxRowsTxt} · Est. features≈${estFeatures || "—"}`;

      $("primaryMetricLabel").textContent = "Test metric";
      $("primaryMetricValue").textContent = "—";
      $("primaryMetricSub").textContent = "Training will start and update automatically.";

      const total = Math.max(0, Math.floor(APP.ui.training.totalUnits || 0));
      const totalTxt = total ? `/${total}` : "";
      $("resultsCallouts").innerHTML = "";
      setResultsSidePanel({
        visible: true,
        title: "Training",
        bodyHtml: `<span class="spinner"></span> Starting… Trees <span class="mono">0${escapeHtml(totalTxt)}</span>`,
        cls: "",
      });

      $("secondaryChartTitle").textContent = "Test chart";
      $("secondaryChartPill").textContent = "—";
      $("secondaryChartHint").textContent = "Charts will populate as trees finish.";

      clearSecondaryViz();
      APP.ui.charts.fi = destroyChart(APP.ui.charts.fi);
      $("secondaryPlaceholder").classList.remove("hidden");
      $("fiChartPlaceholder").classList.remove("hidden");
    }

    function renderResultsLivePartial() {
      const pl = APP.train.pipeline;
      if (!pl) return;

      const task = pl.task;
      const splitMode = effectiveSplitMode();
      const splitText = splitMode === "time"
        ? `time-based (${APP.setup.splitDateCol})`
        : "random";

      if ($("setupSummary")) {
        $("setupSummary").textContent =
          `Target=${pl.targetCol} · Task=${task} · Split=${splitText} · Test=${Math.round(APP.setup.testFrac*100)}%`;
      }

      if ($("featureSummary")) {
        $("featureSummary").textContent =
          `Rows: train=${APP.train.split.trainIdx.length}, test=${APP.train.split.testIdx.length} · Features=${APP.train.featureNames.length} · Transform=${pl.targetTransform}`;
      }

      const trained = Math.max(0, Math.floor(APP.ui.training.completedUnits || 0));
      const total = Math.max(0, Math.floor(APP.ui.training.totalUnits || 0));

      renderResultsSidePanel(task);

      $("resultsCallouts").innerHTML = "";
      const addCallout = (cls, title, body) => {
        const el = document.createElement("div");
        el.className = `callout ${cls || ""}`.trim();
        el.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">${escapeHtml(title)}</div>
                        <div class="muted2">${body}</div>`;
        $("resultsCallouts").appendChild(el);
      };

      if (APP.train.dropped?.unusableTargetRows) {
        addCallout("warn", "Some rows were dropped (target not usable)",
          `Dropped <span class="mono">${APP.train.dropped.unusableTargetRows}</span> rows due to missing/invalid target values (or incompatible log1p).`
        );
      }
      if (APP.train.dropped?.unseenTestLabels) {
        addCallout("warn", "Some test rows were dropped (unseen labels)",
          `Dropped <span class="mono">${APP.train.dropped.unseenTestLabels}</span> test rows because their label never appeared in the training split (train-only label encoding).`
        );
      }

      const hasPred = Array.isArray(APP.train.yPred) && APP.train.yPred.length;
      const hasFi = (Array.isArray(APP.train.fiBase) && APP.train.fiBase.length) || (Array.isArray(APP.train.fiDerived) && APP.train.fiDerived.length);
      $("secondaryPlaceholder").classList.toggle("hidden", Boolean(hasPred));
      $("fiChartPlaceholder").classList.toggle("hidden", Boolean(hasFi));

      const hasFullPred = Boolean(
        Array.isArray(APP.train.yTest) &&
        Array.isArray(APP.train.yPred) &&
        APP.train.yTest.length > 0 &&
        APP.train.yPred.length === APP.train.yTest.length
      );
      if (!hasFullPred) {
        $("primaryMetricLabel").textContent = (task === "regression") ? "Test RMSE" : "Test Accuracy";
        $("primaryMetricValue").textContent = "—";
        $("primaryMetricSub").textContent = "Waiting for first live prediction…";
        $("secondaryChartTitle").textContent = (task === "regression") ? "Predicted vs true (scatter)" : "Confusion matrix (top classes)";
        $("secondaryChartPill").textContent = `trees=${trained}${total ? `/${total}` : ""}`;
        $("secondaryChartHint").textContent = "Updates periodically during training.";
        clearSecondaryViz();
        return;
      }

      if (task === "regression") {
        const yTrue = APP.train.yTest;
        const yPred = APP.train.yPred;

        const rm = rmse(yTrue, yPred);
        const ma = mae(yTrue, yPred);
        const r = r2(yTrue, yPred);
        const rl = rmsle(yTrue, yPred);

        $("primaryMetricLabel").textContent = "Test RMSE";
        $("primaryMetricValue").textContent = formatNum(rm, 6);
        $("primaryMetricSub").textContent = `MAE=${formatNum(ma,6)} · R²=${formatNum(r,6)} · RMSLE=${rl===null?"n/a":formatNum(rl,6)}`;

        $("secondaryChartTitle").textContent = "Predicted vs true (scatter)";
        $("secondaryChartPill").textContent = `trees=${trained}${total ? `/${total}` : ""}`;
        $("secondaryChartHint").textContent = "Updates periodically during training.";
        renderRegressionScatter(APP.train.yTest, APP.train.yPred);

      } else {
        const yTrue = APP.train.yTest.map(v => Number(v));
        const yPred = APP.train.yPred.map(v => Number(v));

        const acc = accuracy(yTrue, yPred);
        const f1 = f1Macro(yTrue, yPred, pl.target.numClasses || 2);

        $("primaryMetricLabel").textContent = "Test Accuracy";
        $("primaryMetricValue").textContent = formatNum(acc, 6);
        $("primaryMetricSub").textContent = `Macro-F1=${formatNum(f1,6)} · Classes=${pl.target.numClasses}`;

        $("secondaryChartTitle").textContent = "Confusion matrix (top classes)";
        $("secondaryChartPill").textContent = `trees=${trained}${total ? `/${total}` : ""}`;
        $("secondaryChartHint").textContent = "Updates periodically during training.";
        renderConfusionMatrix(yTrue, yPred, pl.targetInvMapping, 15);
      }

      const mode = $("importanceMode").value;
      if (hasFi) {
        if (mode === "derived") renderFIChart(APP.train.fiDerived || [], "importance", "derived");
        else renderFIChart(APP.train.fiBase || [], "importance", "base");
      }
    }

    function renderResults() {
      const pl = APP.train.pipeline;
      const task = pl.task;

      $("secondaryPlaceholder").classList.add("hidden");
      $("fiChartPlaceholder").classList.add("hidden");

      const splitMode = effectiveSplitMode();
      const splitText = splitMode === "time"
        ? `time-based (${APP.setup.splitDateCol})`
        : "random";

      if ($("setupSummary")) {
        $("setupSummary").textContent =
          `Target=${pl.targetCol} · Task=${task} · Split=${splitText} · Test=${Math.round(APP.setup.testFrac*100)}%`;
      }

      if ($("featureSummary")) {
        $("featureSummary").textContent =
          `Rows: train=${APP.train.split.trainIdx.length}, test=${APP.train.split.testIdx.length} · Features=${APP.train.featureNames.length} · Transform=${pl.targetTransform}`;
      }

      renderResultsSidePanel(task);

      $("resultsCallouts").innerHTML = "";

      const addCallout = (cls, title, body) => {
        const el = document.createElement("div");
        el.className = `callout ${cls || ""}`.trim();
        el.innerHTML = `<div style="font-weight:650;margin-bottom:6px;">${escapeHtml(title)}</div>
                        <div class="muted2">${body}</div>`;
        $("resultsCallouts").appendChild(el);
      };

      if (APP.train.dropped?.unusableTargetRows) {
        addCallout("warn", "Some rows were dropped (target not usable)",
          `Dropped <span class="mono">${APP.train.dropped.unusableTargetRows}</span> rows due to missing/invalid target values (or incompatible log1p).`
        );
      }
      if (APP.train.dropped?.unseenTestLabels) {
        addCallout("warn", "Some test rows were dropped (unseen labels)",
          `Dropped <span class="mono">${APP.train.dropped.unseenTestLabels}</span> test rows because their label never appeared in the training split (train-only label encoding).`
        );
      }

      const cur = APP.train.runSummary;
      if (cur?.pruneReason) {
        addCallout("", "Prune applied", escapeHtml(cur.pruneReason));
      }

      if (task === "regression") {
        const yTrue = APP.train.yTest;
        const yPred = APP.train.yPred;

        const rm = rmse(yTrue, yPred);
        const ma = mae(yTrue, yPred);
        const r = r2(yTrue, yPred);
        const rl = rmsle(yTrue, yPred);

        $("primaryMetricLabel").textContent = "Test RMSE";
        $("primaryMetricValue").textContent = formatNum(rm, 6);
        $("primaryMetricSub").textContent = `MAE=${formatNum(ma,6)} · R²=${formatNum(r,6)} · RMSLE=${rl===null?"n/a":formatNum(rl,6)}`;

        $("secondaryChartTitle").textContent = "Predicted vs true (scatter)";
        $("secondaryChartPill").textContent = `n=${APP.train.yTest.length}`;
        $("secondaryChartHint").textContent = "Ideally points cluster around the diagonal. Outliers can indicate missingness, leakage, or rare categories.";
        renderRegressionScatter(APP.train.yTest, APP.train.yPred);

      } else {
        const yTrue = APP.train.yTest.map(v => Number(v));
        const yPred = APP.train.yPred.map(v => Number(v));

        const acc = accuracy(yTrue, yPred);
        const f1 = f1Macro(yTrue, yPred, pl.target.numClasses || 2);

        $("primaryMetricLabel").textContent = "Test Accuracy";
        $("primaryMetricValue").textContent = formatNum(acc, 6);
        $("primaryMetricSub").textContent = `Macro-F1=${formatNum(f1,6)} · Classes=${pl.target.numClasses}`;

        $("secondaryChartTitle").textContent = "Confusion matrix (top classes)";
        $("secondaryChartPill").textContent = `classes=${pl.target.numClasses}`;
        $("secondaryChartHint").textContent = "Rows are true labels, columns are predicted. Cell shading is row-normalized; diagonal highlighted. For many classes, we show only the most frequent.";
        renderConfusionMatrix(yTrue, yPred, pl.targetInvMapping, 15);
      }

      renderShiftSection();

      const mode = $("importanceMode").value;
      if (mode === "derived") renderFIChart(APP.train.fiDerived, "importance", "derived");
      else renderFIChart(APP.train.fiBase, "importance", "base");

      APP.ui.predPage = 0;
      $("predFilter").value = "";
      if ($("predFullDetails")) $("predFullDetails").open = true;
      if ($("predInsightsDetails")) $("predInsightsDetails").open = false;
      updateUncertaintyPills();
      renderPredInsights();
      renderPredTable();
      updatePruneMiniUi();

      forceDetailsOpen("shiftDetails");
      forceDetailsOpen("predFullDetails");
      updateExportUI();
    }

    // ----------------------------
    // Export
    // ----------------------------
    function buildArtifact() {
      if (APP.ui.training.isTraining) return null;
      const model = APP.train.model;
      const pipeline = APP.train.pipeline;
      if (!model || !pipeline) return null;
      if (!Number.isFinite(model.nEstimators) || model.nEstimators <= 0) return null;

      return {
        schemaVersion: pipeline.schemaVersion,
        createdAt: pipeline.createdAt,
        fileName: pipeline.fileName,
        originalColumns: pipeline.originalColumns,
        includedColumns: pipeline.includedColumns,
        selectedTypes: Object.fromEntries(Object.entries(APP.raw.colMeta).map(([k, v]) => [k, v.inferredType])),
        typing: {
          maxCard: APP.setup.maxCard,
          excludeCols: APP.setup.excludeCols,
          forceDate: APP.setup.forceDate,
          forceCat: APP.setup.forceCat,
          forceCont: APP.setup.forceCont,
        },
        targetCol: pipeline.targetCol,
        task: pipeline.task,
        targetTransform: pipeline.targetTransform,
        derivedFeatureNames: pipeline.derivedFeatureNames,
        derivedFeatureBase: pipeline.derivedFeatureBase,
        preprocess: pipeline.preprocess,
        target: {
          col: pipeline.target.col,
          mapping: pipeline.target.mapping,
          numClasses: pipeline.target.numClasses
        },
        rfOptions: APP.train.rfOptions,
        model: model.toJSON(),
        library: pipeline.library,
        fittedOn: pipeline.fittedOn
      };
    }

    function buildSampleCode(artifact) {
      return `/**
 * rf_artifact.json contains:
 * - preprocessing pipeline (label encoders, medians, date expansion)
 * - a serialized ml-random-forest model (toJSON())
 *
 * Browser example uses ESM CDN import via esm.sh
 * Node example uses 'ml-random-forest' from npm.
 */

import { RandomForestRegression, RandomForestClassifier } from "https://esm.sh/ml-random-forest@2.1.0";

function normStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function parseNum(v){ const s=normStr(v); if(!s) return NaN; const x=Number(s); return Number.isFinite(x)?x:NaN; }

function looksLikeDateString(s){
  const t=s.trim(); if(!t) return false;
  if(!(/[\\/\\-T:]/.test(t))) return false;
  const p1=/^\\d{4}[-\\/]\\d{1,2}[-\\/]\\d{1,2}(\\b|T)/;
  const p2=/^\\d{1,2}[-\\/]\\d{1,2}[-\\/]\\d{2,4}(\\b|T)/;
  const p3=/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}/;
  return p1.test(t)||p2.test(t)||p3.test(t);
}
function parseDate(v){
  const s=normStr(v); if(!s) return null;
  if(!looksLikeDateString(s)) return null;
  const d=new Date(s); if(Number.isNaN(d.getTime())) return null;
  return d;
}
function dateParts(d){
  function isoWeekNumber(d){
    const dt=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum=dt.getUTCDay()||7;
    dt.setUTCDate(dt.getUTCDate()+4-dayNum);
    const yearStart=new Date(Date.UTC(dt.getUTCFullYear(),0,1));
    return Math.ceil((((dt-yearStart)/86400000)+1)/7);
  }

  const year=d.getFullYear(), month=d.getMonth()+1, week=isoWeekNumber(d), day=d.getDate(), dow=d.getDay();
  const start=new Date(d.getFullYear(),0,1);
  const dayOfYear=Math.floor((d-start)/86400000)+1;

  const isMonthStart=(day===1);
  const isMonthEnd=(new Date(d.getFullYear(), d.getMonth()+1, 0).getDate()===day);

  const qStart=new Set([1,4,7,10]), qEnd=new Set([3,6,9,12]);
  const isQuarterStart=qStart.has(month)&&isMonthStart;
  const isQuarterEnd=qEnd.has(month)&&isMonthEnd;

  const isYearStart=(month===1&&day===1);
  const isYearEnd=(month===12&&day===31);

  return {
    year,month,week,day,dayofweek:dow,dayofyear:dayOfYear,
    is_month_end:isMonthEnd?1:0, is_month_start:isMonthStart?1:0,
    is_quarter_end:isQuarterEnd?1:0, is_quarter_start:isQuarterStart?1:0,
    is_year_end:isYearEnd?1:0, is_year_start:isYearStart?1:0,
    elapsed:d.getTime()
  };
}

function transformRow(row, artifact){
  const contCols=artifact.preprocess.continuous.cols;
  const catCols=artifact.preprocess.categorical.cols;
  const dateCols=artifact.preprocess.date.cols;

  const feats=[];

  for(const c of contCols){
    const x=parseNum(row[c]);
    const miss=!Number.isFinite(x);
    feats.push(miss ? artifact.preprocess.continuous.median[c] : x);
    feats.push(miss ? 1 : 0);
  }

  for(const c of catCols){
    const s=normStr(row[c]) || artifact.preprocess.categorical.missingToken;
    const m=artifact.preprocess.categorical.mapping[c];
    feats.push((m[s]===undefined) ? artifact.preprocess.categorical.unknownId : m[s]);
  }

  for(const c of dateCols){
    const d=parseDate(row[c]);
    const miss=!d;
    const dt=miss ? new Date(artifact.preprocess.date.medianElapsed[c]) : d;
    const p=dateParts(dt);

    feats.push(p.year); feats.push(p.month); feats.push(p.week); feats.push(p.day);
    feats.push(p.dayofweek); feats.push(p.dayofyear);
    feats.push(p.is_month_end); feats.push(p.is_month_start);
    feats.push(p.is_quarter_end); feats.push(p.is_quarter_start);
    feats.push(p.is_year_end); feats.push(p.is_year_start);
    feats.push(p.elapsed);
    feats.push(miss ? 1 : 0);
  }

  return feats;
}

function loadModel(artifact){
  return (artifact.task==="regression")
    ? RandomForestRegression.load(artifact.model)
    : RandomForestClassifier.load(artifact.model);
}

function invertTargetIfNeeded(yPred, artifact){
  if(artifact.task!=="regression") return yPred;
  if(artifact.targetTransform==="log1p") return Math.expm1(yPred);
  return yPred;
}

// Example:
// const artifact = await (await fetch("./rf_artifact.json")).json();
// const model = loadModel(artifact);
// const x = transformRow(rowObj, artifact);
// let yPred = model.predict([x])[0];
// yPred = invertTargetIfNeeded(yPred, artifact);
// console.log("prediction:", yPred);
`;
    }

    function buildSampleCodePy(artifact) {
      const task = String(artifact.task || "unknown");
      const targetCol = String(artifact.targetCol || artifact.target?.col || "unknown");
      const transform = String(artifact.targetTransform || "none");
      const nFeatures = Array.isArray(artifact.derivedFeatureNames) ? artifact.derivedFeatureNames.length : 0;
      return `"""
RFG export: rf_artifact.json

This artifact contains:
- preprocessing metadata (label encoders, medians, date expansion)
- a random forest model serialized for the JavaScript library:
    ml-random-forest (trees from ml-cart)

Python note:
There is no built-in Python loader for this JS model JSON. Use the JS example for
inference, or retrain an equivalent model in Python (e.g. scikit-learn).
"""

import json
from pathlib import Path

# Generated metadata:
# task=${task}
# targetCol=${targetCol}
# targetTransform=${transform}
# n_features=${nFeatures}

artifact = json.loads(Path("rf_artifact.json").read_text(encoding="utf-8"))

print("task:", artifact.get("task"))
print("targetCol:", artifact.get("targetCol"))
print("targetTransform:", artifact.get("targetTransform"))
print("n_features:", len(artifact.get("derivedFeatureNames", [])))

if artifact.get("task") == "classification":
  mapping = (artifact.get("target", {}) or {}).get("mapping", {}) or {}
  print("numClasses:", (artifact.get("target", {}) or {}).get("numClasses"))
  print("example label mapping:", list(mapping.items())[:5])

raise NotImplementedError(
  "Model is serialized for ml-random-forest (JavaScript). "
  "Use the JS example for predictions, or retrain in Python."
)
`;
    }

    function renderExportSampleCode() {
      const artifact = buildArtifact();
      if (!artifact) {
        $("sampleCode").textContent = "";
        return;
      }
      const lang = (APP.ui.exportLang === "py") ? "py" : "js";
      $("sampleCode").textContent = (lang === "py") ? buildSampleCodePy(artifact) : buildSampleCode(artifact);
    }

    async function updateExportUI() {
      const artifact = buildArtifact();
      if (!artifact) { renderExportSampleCode(); return; }
      renderExportSampleCode();
      APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 3);
      renderStepper();
    }

    // ----------------------------
    // App wiring
    // ----------------------------
    function syncGlobalContinueBtn() {
      const btn = $("globalContinueBtn");
      if (!btn) return;

      const step = APP.step || 0;
      if (step === 3) {
        btn.classList.remove("hidden");
        btn.textContent = "Download";
        btn.title = "Download rf_artifact.zip";
        btn.setAttribute("aria-label", "Download rf_artifact.zip");
        btn.disabled = !Boolean(buildArtifact());
        return;
      }

      const next = step + 1;
      if (next >= STEPS.length) {
        btn.classList.add("hidden");
        btn.disabled = true;
        btn.title = "";
        btn.setAttribute("aria-label", "Continue");
        return;
      }

      btn.classList.remove("hidden");
      btn.textContent = "Continue";
      btn.title = `Continue to ${STEPS[next].title}`;
      btn.setAttribute("aria-label", `Continue to ${STEPS[next].title}`);

      let canContinue = true;
      if (step === 0) canContinue = (APP.raw.rows.length && APP.raw.columns.length);
      if (step === 1) canContinue = Boolean(APP.raw.targetCol);
      if (step === 2) canContinue = Boolean(buildArtifact());

      btn.disabled = !canContinue;
    }

    function syncGlobalBackBtn() {
      const btn = $("globalBackBtn");
      if (!btn) return;

      const step = APP.step || 0;
      if (step <= 0) {
        btn.classList.add("hidden");
        btn.disabled = true;
        btn.title = "";
        btn.setAttribute("aria-label", "Back");
        return;
      }

      btn.classList.remove("hidden");
      btn.title = `Back to ${STEPS[step - 1].title}`;
      btn.setAttribute("aria-label", `Back to ${STEPS[step - 1].title}`);
      btn.disabled = Boolean(APP.ui.training.isTraining);
    }

    function syncGlobalStopBtn() {
      const btn = $("globalStopBtn");
      if (!btn) return;
      const isTraining = Boolean(APP.ui.training.isTraining);
      const showRetrain = (!isTraining && (APP.step === 2) && isModelReady());
      btn.classList.toggle("hidden", !(isTraining || showRetrain));

      if (isTraining) {
        btn.className = "btn danger";
        btn.textContent = "Stop";
        btn.disabled = Boolean(APP.ui.training.stopRequested);
        btn.title = "Stop training";
        btn.setAttribute("aria-label", "Stop training");
      } else {
        if (APP.step !== 2) {
          btn.classList.add("hidden");
          btn.disabled = true;
          btn.title = "";
          btn.setAttribute("aria-label", "Retrain model");
          return;
        }
        btn.className = "btn";
        btn.textContent = "Retrain";
        btn.disabled = false;
        btn.title = "Retrain model";
        btn.setAttribute("aria-label", "Retrain model");
      }
    }

    function syncButtons() {
      setTrainingUi(APP.ui.training.isTraining);
      updateExportUI();
      if ($("jumpToExportBtn")) $("jumpToExportBtn").disabled = APP.ui.training.isTraining || !APP.train.model || !APP.train.pipeline;
      syncGlobalContinueBtn();
      syncGlobalBackBtn();
      syncGlobalStopBtn();
      renderStateChips();
    }

	    function hardReset() {
      try { APP.ui.training.abortController?.abort(); } catch {}
      try { APP.ui.training.diagAbortController?.abort(); } catch {}
      APP.ui.training.abortController = null;
      APP.ui.training.diagAbortController = null;
      APP.ui.training.isTraining = false;
      APP.ui.training.stopRequested = false;
      APP.ui.training.autoStartOnResults = false;
      APP.ui.training.runSeq = 0;
      APP.ui.shiftAutoExpandedRunSeq = 0;

      APP.ui.parseSeq = (APP.ui.parseSeq || 0) + 1;
      APP.step = 0;
      APP.raw = { fileName: null, rows: [], columns: [], colMeta: {}, targetCol: null };
      APP.setup = {
        splitDateCol: null,
        splitMethod: "cutoff",
        cutoffDate: "",
        splitStrategy: "stratified",
        testFrac: 0.1,
	        taskMode: "regression",
        targetTransform: "none",
        maxRows: 1000,
        maxCard: 50,
        forceDate: "",
        forceCat: "",
        forceCont: "",
        excludeCols: "",
        excluded: new Set(),
        autoExcludedReasons: {},
        forcedTypes: {
          date: new Set(),
          categorical: new Set(),
          continuous: new Set(),
        },
        multiClass: {
          topN: {
            enabled: false,
            keep: 5,
            rareLabel: "RARE",
          },
          derivedTarget: {
            enabled: false,
            sourceCol: null,
            derivedCol: "",
            expr: "",
            lastStatus: "",
            lastError: "",
          },
        },
      };
      resetStateChips({ clearValues: true });
      syncHiddenTypingLists();
      APP.train = {
        rfOptions: null,
        model: null,
        pipeline: null,
        featureNames: [],
        baseForDerived: [],
        derivedTypeByFeature: null,
        split: { trainIdx: [], testIdx: [] },
        yTrain: [],
        yTest: [],
        yPred: [],
        yPredLabel: [],
        err: [],
        absErr: [],
        uncertainty: null,
        uncertaintyDetails: null,
        uncertaintyStatus: "none",
        uncertaintyError: "",
        runSummary: null,
        oobPred: null,
        testRowRefs: [],
        fiDerived: [],
        fiBase: [],
        shift: null,
        dropped: { unusableTargetRows: 0, unseenTestLabels: 0, sampledRows: 0, usableRows: 0 }
      };
      APP.ui.predPage = 0;
      APP.ui.predFilter = "";
      APP.ui.previewFilter = "";
      APP.ui.showAdvancedSettings = false;
      APP.ui.resultsTab = "overview";
      APP.ui.setupDirty = false;
      APP.ui.prevRunSummary = null;
      APP.ui.pruneUndoExcluded = null;
      APP.ui.pruneUndoReason = "";
      APP.ui.pruneJustApplied = false;
      APP.ui.maxUnlockedStep = 0;

      APP.ui.charts.fi = destroyChart(APP.ui.charts.fi);
      APP.ui.charts.secondary = destroyChart(APP.ui.charts.secondary);
      APP.ui.charts.shift = destroyChart(APP.ui.charts.shift);
      APP.ui.charts.errUnc = destroyChart(APP.ui.charts.errUnc);
      APP.ui.charts.targetPreview = destroyChart(APP.ui.charts.targetPreview);

      $("trainStatus").innerHTML = "";
	      setTrainingUi(false);
      setResultsTab(APP.ui.resultsTab);

      hide($("uploadSummary"));
      show($("dropZone"));
      $("previewTable").innerHTML = "";
      if ($("targetSearch")) $("targetSearch").value = "";
      $("predTable").innerHTML = "";
      $("worstErrTable").innerHTML = "";
      $("highUncTable").innerHTML = "";
      $("resultsCallouts").innerHTML = "";
      $("uncertaintyPill").textContent = "Uncertainty: —";
      $("uncertaintyPill").className = "pill";
      $("errUncPill").textContent = "—";
      $("errUncPill").className = "pill";
      if ($("predInsightsDetails")) $("predInsightsDetails").open = false;
      $("pruneUndoBtn").disabled = true;
      $("pruneImpBtn").disabled = true;
      $("pruneShiftTopBtn").disabled = true;
      $("pruneMiniHint").textContent = "—";
      hide($("pruneImpRow"));
      $("shiftPill").textContent = "—";
      $("shiftPill").className = "pill";
      $("shiftSummary").textContent = "—";
      if ($("shiftDetails")) $("shiftDetails").open = true;

      $("testFrac").value = "0.1";
      $("cutoffDate").value = "";
      $("seed").value = "42";
      $("maxRows").value = "1000";
      $("maxCard").value = "50";
      $("nEstimators").value = "100";
      $("maxFeaturesMode").value = "all";
      $("maxFeaturesValue").value = "";
      syncMaxFeaturesUi();
      $("maxDepth").value = "20";
      $("minNumSamples").value = "10";
      $("replacement").value = "false";
	      $("taskMode").value = "regression";
      $("targetTransform").value = "none";
      $("splitMethod").value = "cutoff";
      $("splitStrategy").value = "stratified";
      delete $("splitStrategy").dataset.userSet;
      $("predTopK").value = "30";
      $("predFilter").value = "";
      $("pageSize").value = "50";
      $("importanceMode").value = "base";
      if ($("predFullDetails")) $("predFullDetails").open = true;
      if ($("predInsightsDetails")) $("predInsightsDetails").open = false;
      $("pruneMinImp").value = "0.002";
      if ($("maxFeaturesMode")) delete $("maxFeaturesMode").dataset.userSet;
      if ($("maxFeaturesValue")) delete $("maxFeaturesValue").dataset.userSet;
      if ($("maxDepth")) delete $("maxDepth").dataset.userSet;
      if ($("minNumSamples")) delete $("minNumSamples").dataset.userSet;
      if ($("colFilterField")) $("colFilterField").classList.add("hidden");
      if ($("colFilter")) $("colFilter").value = "";

      if ($("advancedTargetDetails")) $("advancedTargetDetails").classList.add("hidden");
      if ($("multiClassSummaryCallout")) $("multiClassSummaryCallout").innerHTML = "";
      if ($("topNEnable")) $("topNEnable").checked = false;
      if ($("topNKeep")) $("topNKeep").value = "5";
      if ($("topNSummary")) $("topNSummary").textContent = "—";
      if ($("derivedTargetColName")) $("derivedTargetColName").value = "";
      if ($("derivedTargetColName")) delete $("derivedTargetColName").dataset.userSet;
      if ($("derivedTargetExpr")) $("derivedTargetExpr").value = "";
      if ($("derivedTargetExpr")) delete $("derivedTargetExpr").dataset.userSet;
      if ($("derivedTargetStatus")) $("derivedTargetStatus").textContent = "—";

      gotoStep(0);
    }

	    function resetForNewFile() {
	      const taskModeRaw = $("taskMode").value;
	      const taskMode =
	        (taskModeRaw === "regression" || taskModeRaw === "classification")
	          ? taskModeRaw
	          : "regression";
      const splitStrategyUserSet = $("splitStrategy").dataset.userSet === "true";
      const prefs = {
        testFrac: parseNum($("testFrac").value) || 0.1,
        splitMethod: $("splitMethod").value || "cutoff",
        cutoffDate: $("cutoffDate").value || "",
        splitStrategy: $("splitStrategy").value || "stratified",
        splitStrategyUserSet,
        taskMode,
        targetTransform: $("targetTransform").value,
        maxRows: Math.floor(parseNum($("maxRows").value) || 0),
        maxCard: Math.max(1, Math.floor(parseNum($("maxCard").value) || 50)),
        nEstimators: Math.max(10, Math.floor(parseNum($("nEstimators").value) || 100)),
        maxFeaturesMode: $("maxFeaturesMode").value || "all",
        maxFeaturesValue: $("maxFeaturesValue").value || "",
        maxDepth: $("maxDepth")?.value || "",
        minNumSamples: $("minNumSamples")?.value || "",
        replacement: $("replacement").value || "false",
        seed: $("seed").value,
      };

      hardReset();

      APP.setup.testFrac = Math.min(0.5, Math.max(0.05, prefs.testFrac));
      APP.setup.splitMethod = prefs.splitMethod;
      APP.setup.cutoffDate = prefs.cutoffDate;
      APP.setup.splitStrategy = prefs.splitStrategy;
      APP.setup.taskMode = prefs.taskMode;
      APP.setup.targetTransform = prefs.targetTransform;
      APP.setup.maxRows = Math.max(0, prefs.maxRows);
      APP.setup.maxCard = prefs.maxCard;
      APP.setup.excluded = new Set();
      APP.setup.autoExcludedReasons = {};
      APP.setup.forcedTypes = { date: new Set(), categorical: new Set(), continuous: new Set() };
      syncHiddenTypingLists();

      $("testFrac").value = String(APP.setup.testFrac);
      $("splitMethod").value = APP.setup.splitMethod;
      $("cutoffDate").value = APP.setup.cutoffDate;
      $("splitStrategy").value = APP.setup.splitStrategy;
      if (prefs.splitStrategyUserSet) $("splitStrategy").dataset.userSet = "true";
      else delete $("splitStrategy").dataset.userSet;
      $("taskMode").value = taskMode;
      $("targetTransform").value = prefs.targetTransform;
      $("maxRows").value = String(APP.setup.maxRows);
      $("maxCard").value = String(APP.setup.maxCard);
      $("nEstimators").value = String(prefs.nEstimators);
      $("maxFeaturesMode").value = String(prefs.maxFeaturesMode);
      $("maxFeaturesValue").value = String(prefs.maxFeaturesValue);
      syncMaxFeaturesUi();
      if ($("maxDepth")) $("maxDepth").value = String(prefs.maxDepth);
      if ($("minNumSamples")) $("minNumSamples").value = String(prefs.minNumSamples);
      $("replacement").value = String(prefs.replacement);
      $("seed").value = prefs.seed;
    }

    function handleParsed(rows, cols, fileName) {
      if (!rows.length || !cols.length) {
        showToast("Parse failed: no rows/columns found.", "bad");
        return;
      }

      APP.raw.fileName = fileName || "data.csv";
      APP.raw.rows = rows;
      APP.raw.columns = cols;
      APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 1);
      renderStepper();

      recomputeColumnMeta();
      applyDefaultColumnExclusions();
      recomputeColumnMeta();

      APP.ui.previewFilter = "";
      renderPreviewTable(rows, cols);
      bindPreviewTargetPicker();

      hide($("dropZone"));
      show($("uploadSummary"));

      $("targetSearch").value = "";

      APP.raw.targetCol = null;
      renderTargetSelect();
      refreshSplitDateCol();
      syncSetupUI();
      renderColumnTable();
      syncButtons();
    }

    function handleFile(file) {
      if (!file) return;

      const parseSeq = (APP.ui.parseSeq = (APP.ui.parseSeq || 0) + 1);

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        worker: true,
        complete: (res) => {
          if (parseSeq !== APP.ui.parseSeq) return;
          const rows = res.data || [];
          const cols = (res.meta && res.meta.fields) ? res.meta.fields.filter(Boolean) : [];
          handleParsed(rows, cols, file.name);
        },
        error: (err) => {
          if (parseSeq !== APP.ui.parseSeq) return;
          showToast(`Parse error: ${err?.message || String(err)}`, "bad");
        }
      });
    }

    function parseSampleCsvText(text, fileName = "sample.csv") {
      APP.ui.parseSeq = (APP.ui.parseSeq || 0) + 1;
      const res = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false });
      const rows = res.data || [];
      const cols = (res.meta && res.meta.fields) ? res.meta.fields.filter(Boolean) : [];
      handleParsed(rows, cols, fileName);
    }

    // ----------------------------
    // Events
    // ----------------------------
    $("resetAllBtn")?.addEventListener("click", hardReset);

    $("browseBtn").addEventListener("click", () => $("fileInput").click());
    $("fileInput").addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      resetForNewFile();
      handleFile(f);
    });

    $("sampleBtn").addEventListener("click", () => {
      resetForNewFile();
      const text = $("embeddedTitanicCsv")?.textContent || "";
      parseSampleCsvText(text.trim(), "titanic.csv");
      showToast("Loaded sample: titanic.csv", "good");
    });

    const dz = $("dropZone");
    dz.addEventListener("dragover", (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add("dragover"); });
    dz.addEventListener("dragleave", (e) => { e.stopPropagation(); dz.classList.remove("dragover"); });
    dz.addEventListener("drop", (e) => {
      e.preventDefault(); e.stopPropagation(); dz.classList.remove("dragover");
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      resetForNewFile();
      handleFile(f);
    });

    function isFileDragEvent(e) {
      const dt = e.dataTransfer;
      if (!dt) return false;
      if (dt.files && dt.files.length) return true;
      const types = dt.types ? Array.from(dt.types) : [];
      return types.includes("Files");
    }

    let globalDragDepth = 0;
    function setGlobalDropOverlayVisible(visible) {
      const el = $("globalDropOverlay");
      if (!el) return;
      if (visible) el.classList.remove("hidden");
      else el.classList.add("hidden");
    }

    window.addEventListener("dragenter", (e) => {
      if (!isFileDragEvent(e)) return;
      globalDragDepth += 1;
      setGlobalDropOverlayVisible(true);
    }, true);

    window.addEventListener("dragleave", (e) => {
      if (!globalDragDepth) return;
      globalDragDepth = Math.max(0, globalDragDepth - 1);
      if (!globalDragDepth) setGlobalDropOverlayVisible(false);
    }, true);

    window.addEventListener("dragover", (e) => {
      if (!isFileDragEvent(e)) return;
      e.preventDefault();
      if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
      setGlobalDropOverlayVisible(true);
    });

    window.addEventListener("drop", (e) => {
      if (!isFileDragEvent(e)) return;
      e.preventDefault();
      globalDragDepth = 0;
      setGlobalDropOverlayVisible(false);
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      resetForNewFile();
      handleFile(f);
    });

    window.addEventListener("dragend", () => {
      globalDragDepth = 0;
      setGlobalDropOverlayVisible(false);
    });

    $("globalContinueBtn").addEventListener("click", () => {
      const btn = $("globalContinueBtn");
      if (!btn || btn.disabled) return;
      if (APP.step === 0) {
        renderTargetSelect();
        refreshSplitDateCol();
        syncSetupUI();
        renderColumnTable();
        gotoStep(1);
        return;
      }

      if (APP.step === 1) {
        APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 2);
        renderStepper();
        const shouldRetrain = Boolean(APP.ui.setupDirty && isModelReady());
        if (!isModelReady() || shouldRetrain) {
          APP.ui.training.completedUnits = 0;
          APP.ui.training.totalUnits = 0;
          APP.ui.training.stopRequested = false;
          APP.ui.training.autoStartOnResults = true;
          APP.ui.training.retrainOnResults = shouldRetrain;
        } else {
          APP.ui.training.autoStartOnResults = false;
          APP.ui.training.retrainOnResults = false;
        }
        gotoStep(2);
        return;
      }

      if (APP.step === 2) {
        gotoStep(3);
        return;
      }

      if (APP.step === 3) {
        downloadArtifactZip();
        return;
      }
    });

    $("jumpToExportBtn")?.addEventListener("click", () => gotoStep(3));

    $("globalBackBtn").addEventListener("click", () => {
      const btn = $("globalBackBtn");
      if (!btn || btn.disabled) return;
      const prev = (APP.step || 0) - 1;
      if (prev < 0) return;
      gotoStep(prev);
    });

    $("globalStopBtn").addEventListener("click", () => {
      const btn = $("globalStopBtn");
      if (!btn || btn.disabled) return;
      if (APP.ui.training.isTraining) {
        requestStopTraining();
        return;
      }
      if (APP.step !== 2) return;
      if (!isModelReady()) return;
      APP.ui.training.completedUnits = 0;
      APP.ui.training.totalUnits = 0;
      APP.ui.training.stopRequested = false;
      renderResultsPlaceholders();
      trainModel();
    });

    $("toggleAdvancedSettingsBtn")?.addEventListener("click", () => {
      APP.ui.showAdvancedSettings = !APP.ui.showAdvancedSettings;
      syncSetupUI();
      syncButtons();
    });

    $("targetPreviewLog1pBtn")?.addEventListener("click", () => {
      const sel = $("targetTransform");
      if (!sel) return;
      sel.value = "log1p";
      sel.dispatchEvent(new Event("change"));
      showToast("Applied log1p target transform", "good");
    });

    function setResultsTab(name) {
      const tabs = {
        overview: { button: "tabOverview", panel: "resultsOverview" },
        diagnostics: { button: "tabDiagnostics", panel: "resultsDiagnostics" },
        predictions: { button: "tabPredictions", panel: "resultsPredictions" },
      };
      const next = tabs[name] ? name : "overview";
      APP.ui.resultsTab = next;
      Object.entries(tabs).forEach(([key, config]) => {
        const btn = $(config.button);
        const panel = $(config.panel);
        const isActive = key === next;
        if (btn) {
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-selected", isActive ? "true" : "false");
        }
        if (panel) panel.classList.toggle("hidden", !isActive);
      });
    }

    $("presetFastBtn")?.addEventListener("click", () => applyTrainingPreset("fast"));
    $("presetBalancedBtn")?.addEventListener("click", () => applyTrainingPreset("balanced"));
    $("presetThoroughBtn")?.addEventListener("click", () => applyTrainingPreset("thorough"));

    function setExportLang(lang) {
      APP.ui.exportLang = (lang === "py") ? "py" : "js";
      const jsBtn = $("exportLangJsBtn");
      const pyBtn = $("exportLangPyBtn");
      if (jsBtn) {
        jsBtn.classList.toggle("active", APP.ui.exportLang === "js");
        jsBtn.setAttribute("aria-selected", APP.ui.exportLang === "js" ? "true" : "false");
      }
      if (pyBtn) {
        pyBtn.classList.toggle("active", APP.ui.exportLang === "py");
        pyBtn.setAttribute("aria-selected", APP.ui.exportLang === "py" ? "true" : "false");
      }
      renderExportSampleCode();
    }

    $("tabOverview")?.addEventListener("click", () => setResultsTab("overview"));
    $("tabDiagnostics")?.addEventListener("click", () => setResultsTab("diagnostics"));
    $("tabPredictions")?.addEventListener("click", () => setResultsTab("predictions"));

    forceDetailsOpen("shiftDetails");
    forceDetailsOpen("predFullDetails");

    $("exportLangJsBtn")?.addEventListener("click", () => setExportLang("js"));
    $("exportLangPyBtn")?.addEventListener("click", () => setExportLang("py"));

    $("targetSelect").addEventListener("change", () => {
      markSetupDirty();
      APP.raw.targetCol = $("targetSelect").value;
      if (APP.raw.targetCol) APP.setup.excluded.delete(APP.raw.targetCol);
      recomputeColumnMeta();
      if (APP.raw.targetCol) {
        const mode = defaultTaskModeForTarget(APP.raw.rows, APP.raw.targetCol, APP.raw.colMeta);
        APP.setup.taskMode = mode;
        if ($("taskMode")) $("taskMode").value = mode;
        updateStateChip("target", { value: APP.raw.targetCol, visible: true });
        updateStateChip("task", { value: mode, visible: true });
        APP.ui.maxUnlockedStep = Math.max(APP.ui.maxUnlockedStep || 0, 2);
        renderStepper();
      }
      applyAutoTrainDefaults();
      refreshSplitDateCol();
      syncSetupUI();
      renderColumnTable();
      syncPreviewTargetHighlight();
      syncButtons();
    });

    $("targetSearch").addEventListener("input", () => {
      APP.ui.previewFilter = $("targetSearch").value;
      renderPreviewTable(APP.raw.rows, APP.raw.columns);
    });

    $("taskMode").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.taskMode = $("taskMode").value;
      syncSetupUI();
      renderStateChips();
      applyAutoTrainDefaults();
      renderTargetPreview();
    });

    $("targetTransform").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.targetTransform = $("targetTransform").value;
      syncSetupUI();
      renderTargetPreview();
    });

    $("maxRows").addEventListener("change", () => {
      APP.setup.maxRows = Math.floor(parseNum($("maxRows").value) || 0);
      markSetupDirty();
      clearTrainingPreset();
      syncSetupUI();
      applyAutoTrainDefaults();
    });
    $("maxRows").addEventListener("input", clearTrainingPreset);
    $("maxRows").addEventListener("input", markSetupDirty);

    $("splitStrategy").addEventListener("change", () => {
      markSetupDirty();
      $("splitStrategy").dataset.userSet = "true";
      APP.setup.splitStrategy = $("splitStrategy").value || "random";
      syncSetupUI();
      renderStateChips();
    });

    $("splitDateCol").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.splitDateCol = $("splitDateCol").value;
      syncSetupUI();
      renderStateChips();
    });

    $("splitMethod").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.splitMethod = $("splitMethod").value;
      syncSetupUI();
      renderStateChips();
    });

    $("cutoffDate").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.cutoffDate = $("cutoffDate").value || "";
      syncSetupUI();
      renderStateChips();
    });

    $("testFrac").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.testFrac = Math.min(0.5, Math.max(0.05, parseNum($("testFrac").value) || 0.1));
      syncSetupUI();
      renderStateChips();
    });

    $("topNEnable").addEventListener("change", () => {
      markSetupDirty();
      APP.setup.multiClass.topN.enabled = Boolean($("topNEnable").checked);
      syncAdvancedTargetUI();
      renderStateChips();
    });

    $("topNKeep").addEventListener("change", () => {
      markSetupDirty();
      const v = Math.max(1, Math.floor(parseNum($("topNKeep").value) || 1));
      APP.setup.multiClass.topN.keep = v;
      $("topNKeep").value = String(v);
      syncAdvancedTargetUI();
      renderStateChips();
    });

    $("derivedTargetColName").addEventListener("input", () => {
      $("derivedTargetColName").dataset.userSet = "1";
      syncAdvancedTargetUI();
    });

    $("derivedTargetExpr").addEventListener("input", () => {
      $("derivedTargetExpr").dataset.userSet = "1";
      syncAdvancedTargetUI();
    });

    $("applyDerivedTargetBtn").addEventListener("click", () => {
      markSetupDirty();
      const dt = APP.setup.multiClass?.derivedTarget || null;
      if (dt) { dt.lastError = ""; dt.lastStatus = ""; }
      try {
        applyDerivedTargetFromExpr();
      } catch (e) {
        if (dt) dt.lastError = e?.message || String(e);
        syncAdvancedTargetUI();
      }
    });

    $("undoDerivedTargetBtn").addEventListener("click", () => {
      markSetupDirty();
      undoDerivedTarget();
      syncAdvancedTargetUI();
      renderStateChips();
    });

    let typingDebounce = null;
    const scheduleTypingRefresh = () => {
      if (!APP.raw.columns.length) return;
      if (typingDebounce) clearTimeout(typingDebounce);
      typingDebounce = setTimeout(() => {
        recomputeColumnMeta();
        refreshSplitDateCol();
        syncSetupUI();
        applyAutoTrainDefaults();
        renderColumnTable();
        syncButtons();
      }, 80);
    };

    function markTrainSettingAsUserSet(id) {
      const el = $(id);
      if (!el) return;
      const mark = () => { el.dataset.userSet = "1"; };
      el.addEventListener("input", mark);
      el.addEventListener("change", mark);
    }
    $("maxFeaturesMode").addEventListener("change", () => {
      clearTrainingPreset();
      markSetupDirty();
      syncMaxFeaturesUi();
    });
    $("maxFeaturesValue").addEventListener("input", clearTrainingPreset);
    $("nEstimators").addEventListener("input", clearTrainingPreset);
    $("maxDepth").addEventListener("input", clearTrainingPreset);
    $("minNumSamples").addEventListener("input", clearTrainingPreset);
    $("maxFeaturesValue").addEventListener("input", markSetupDirty);
    $("nEstimators").addEventListener("input", markSetupDirty);
    $("maxDepth").addEventListener("input", markSetupDirty);
    $("minNumSamples").addEventListener("input", markSetupDirty);
    $("seed").addEventListener("input", markSetupDirty);
    $("replacement").addEventListener("change", markSetupDirty);
    markTrainSettingAsUserSet("maxFeaturesMode");
    markTrainSettingAsUserSet("maxFeaturesValue");
    markTrainSettingAsUserSet("maxDepth");
    markTrainSettingAsUserSet("minNumSamples");
    markTrainSettingAsUserSet("derivedTargetColName");
    markTrainSettingAsUserSet("derivedTargetExpr");

    $("colFilter").addEventListener("input", () => {
      renderColumnTable();
    });
    $("toggleColFilterBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      const field = $("colFilterField");
      if (!field) return;
      field.classList.remove("hidden");
      $("colFilter").focus();
    });

    $("maxCard").addEventListener("input", scheduleTypingRefresh);
    $("maxCard").addEventListener("input", markSetupDirty);
    $("reviewColumnsTable").querySelectorAll("th.sortable[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort");
        if (!key) return;
        if (APP.ui.colSort.key === key) APP.ui.colSort.dir = (APP.ui.colSort.dir === "asc") ? "desc" : "asc";
        else { APP.ui.colSort.key = key; APP.ui.colSort.dir = "asc"; }
        renderColumnTable();
      });
    });


    window.addEventListener("pagehide", (e) => {
      if (e.persisted) return;
      releaseAllResources();
    });
    window.addEventListener("beforeunload", () => {
      releaseAllResources();
    });

    $("importanceMode").addEventListener("change", () => {
      if (!APP.train.model) return;
      const mode = $("importanceMode").value;
      if (mode === "derived") renderFIChart(APP.train.fiDerived, "importance", "derived");
      else renderFIChart(APP.train.fiBase, "importance", "base");
    });

    $("predFilter").addEventListener("input", () => { APP.ui.predPage = 0; renderPredTable(); });
    $("pageSize").addEventListener("change", () => { APP.ui.predPage = 0; renderPredTable(); });
    $("predTopK").addEventListener("change", () => { renderPredInsights(); });
    $("predInsightsDetails").addEventListener("toggle", () => {
      if ($("predInsightsDetails").open) {
        renderPredInsights();
        if (APP.ui.charts.errUnc) APP.ui.charts.errUnc.resize();
      }
    });

    $("pruneImpBtn").addEventListener("click", () => {
      if (!APP.train.model || !APP.train.pipeline) return;
      const included = currentIncludedFeatureCols();
      const fiNorm = normalizeFi(APP.train.fiBase).filter(x => included.includes(x.name));
      if (!fiNorm.length) return;

      const tau = Math.max(0, parseNum($("pruneMinImp").value) || 0);
      const keep = fiNorm.filter(x => x.frac >= tau).map(x => x.name);
      const minKeep = Math.min(included.length, 5);
      if (keep.length < minKeep) {
        keep.length = 0;
        for (let i = 0; i < Math.min(minKeep, fiNorm.length); i++) keep.push(fiNorm[i].name);
      }
      const drop = included.filter(c => !keep.includes(c));
      applyExclusionsAndRetrain({ dropCols: drop, reason: `Pruned low-importance (min imp=${formatNum(tau, 4)})` });
    });

    $("pruneShiftTopBtn").addEventListener("click", () => {
      if (!APP.train.model || !APP.train.pipeline) return;
      const shiftFi = APP.train.shift?.fiBase || null;
      const shiftScore = APP.train.shift?.oobBalAcc ?? APP.train.shift?.oobAcc ?? null;
      if (!Array.isArray(shiftFi) || !shiftFi.length || shiftScore === null) return;
      const included = currentIncludedFeatureCols();
      const fiNorm = normalizeFi(shiftFi).filter(x => included.includes(x.name));
      if (!fiNorm.length) return;
      const top = fiNorm[0].name;
      applyExclusionsAndRetrain({ dropCols: [top], reason: `Pruned top shift driver (${top})` });
    });

    $("pruneUndoBtn").addEventListener("click", () => {
      undoLastPrune();
    });

    $("prevPage").addEventListener("click", () => { APP.ui.predPage = Math.max(0, APP.ui.predPage - 1); renderPredTable(); });
    $("nextPage").addEventListener("click", () => { APP.ui.predPage = APP.ui.predPage + 1; renderPredTable(); });

    $("downloadPredCsvBtn").addEventListener("click", () => {
      if (!APP.train.model) return;
      const csv = buildPredictionsCsv();
      downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), "test_predictions.csv");
    });

    async function downloadArtifactZip() {
      const artifact = buildArtifact();
      if (!artifact) return;

      const sampleJs = buildSampleCode(artifact);
      const samplePy = buildSampleCodePy(artifact);
      if ($("sampleCode") && !$("sampleCode").textContent) renderExportSampleCode();
      const predCsv = APP.train.model ? buildPredictionsCsv() : "";

      const readme = `# Random Forest Artifact

This zip contains:
- rf_artifact.json: preprocessing pipeline + serialized ml-random-forest model
- use_model.js: sample loader code (browser ESM + Node)
- test_predictions.csv: your test split with predictions + uncertainty (tree disagreement)

Notes
- Preprocessing is fit on the training split only to avoid leakage.
- Categorical features are label-encoded. Missing/unknown -> id 0 ("#na#").
- Continuous features are median-imputed + "_na" missing-indicator columns.
- Date features are expanded into date parts + "_na".
- If you trained with targetTransform=log1p, predictions should be inverted with expm1.

Compatibility
- Serialization uses ml-random-forest@2.1.0
`;

      const zip = new JSZip();
      zip.file("rf_artifact.json", JSON.stringify(artifact, null, 2));
      zip.file("use_model.js", sampleJs);
      zip.file("use_model.py", samplePy);
      zip.file("test_predictions.csv", predCsv);
      zip.file("README.md", readme);

      const blob = await zip.generateAsync({ type: "blob" });
      downloadBlob(blob, "rf_artifact.zip");
      showToast("Downloading rf_artifact.zip", "good");
    }

    // Keyboard: Return = "next step" (via training)
    window.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      if (e.shiftKey || e.altKey || e.ctrlKey || e.metaKey) return;

      const ae = document.activeElement;
      if (ae && (ae.tagName === "TEXTAREA" || ae.isContentEditable)) return;
      if (APP.ui.training.isTraining) return;

      if (APP.step === 0) {
        if ($("globalContinueBtn")?.disabled) return;
        e.preventDefault();
        $("globalContinueBtn").click();
        return;
      }

      if (APP.step === 1) {
        if ($("globalContinueBtn")?.disabled) return;
        e.preventDefault();
        $("globalContinueBtn").click();
        return;
      }

      if (APP.step === 2) {
        if ($("globalContinueBtn")?.disabled) return;
        e.preventDefault();
        $("globalContinueBtn").click();
        return;
      }

      if (APP.step === 3) {
        if (!buildArtifact()) return;
        e.preventDefault();
        downloadArtifactZip();
      }
    });

    // ----------------------------
    // Init
    // ----------------------------
    disableChartAnimations();
    renderStepper();

    hardReset();

    syncButtons();
    setExportLang(APP.ui.exportLang);
  </script>


  <!-- Embedded sample CSV (titanic.csv) -->
  <script type="text/plain" id="embeddedTitanicCsv">
PassengerId,Survived,Pclass,Name,Sex,Age,SibSp,Parch,Ticket,Fare,Cabin,Embarked
1,0,3,"Braund, Mr. Owen Harris",male,22,1,0,A/5 21171,7.25,,S
2,1,1,"Cumings, Mrs. John Bradley (Florence Briggs Thayer)",female,38,1,0,PC 17599,71.2833,C85,C
3,1,3,"Heikkinen, Miss. Laina",female,26,0,0,STON/O2. 3101282,7.925,,S
4,1,1,"Futrelle, Mrs. Jacques Heath (Lily May Peel)",female,35,1,0,113803,53.1,C123,S
5,0,3,"Allen, Mr. William Henry",male,35,0,0,373450,8.05,,S
6,0,3,"Moran, Mr. James",male,,0,0,330877,8.4583,,Q
7,0,1,"McCarthy, Mr. Timothy J",male,54,0,0,17463,51.8625,E46,S
8,0,3,"Palsson, Master. Gosta Leonard",male,2,3,1,349909,21.075,,S
9,1,3,"Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)",female,27,0,2,347742,11.1333,,S
10,1,2,"Nasser, Mrs. Nicholas (Adele Achem)",female,14,1,0,237736,30.0708,,C
11,1,3,"Sandstrom, Miss. Marguerite Rut",female,4,1,1,PP 9549,16.7,G6,S
12,1,1,"Bonnell, Miss. Elizabeth",female,58,0,0,113783,26.55,C103,S
13,0,3,"Saundercock, Mr. William Henry",male,20,0,0,A/5. 2151,8.05,,S
14,0,3,"Andersson, Mr. Anders Johan",male,39,1,5,347082,31.275,,S
15,0,3,"Vestrom, Miss. Hulda Amanda Adolfina",female,14,0,0,350406,7.8542,,S
16,1,2,"Hewlett, Mrs. (Mary D Kingcome) ",female,55,0,0,248706,16,,S
17,0,3,"Rice, Master. Eugene",male,2,4,1,382652,29.125,,Q
18,1,2,"Williams, Mr. Charles Eugene",male,,0,0,244373,13,,S
19,0,3,"Vander Planke, Mrs. Julius (Emelia Maria Vandemoortele)",female,31,1,0,345763,18,,S
20,1,3,"Masselmani, Mrs. Fatima",female,,0,0,2649,7.225,,C
21,0,2,"Fynney, Mr. Joseph J",male,35,0,0,239865,26,,S
22,1,2,"Beesley, Mr. Lawrence",male,34,0,0,248698,13,D56,S
23,1,3,"McGowan, Miss. Anna ""Annie""",female,15,0,0,330923,8.0292,,Q
24,1,1,"Sloper, Mr. William Thompson",male,28,0,0,113788,35.5,A6,S
25,0,3,"Palsson, Miss. Torborg Danira",female,8,3,1,349909,21.075,,S
26,1,3,"Asplund, Mrs. Carl Oscar (Selma Augusta Emilia Johansson)",female,38,1,5,347077,31.3875,,S
27,0,3,"Emir, Mr. Farred Chehab",male,,0,0,2631,7.225,,C
28,0,1,"Fortune, Mr. Charles Alexander",male,19,3,2,19950,263,C23 C25 C27,S
29,1,3,"O'Dwyer, Miss. Ellen ""Nellie""",female,,0,0,330959,7.8792,,Q
30,0,3,"Todoroff, Mr. Lalio",male,,0,0,349216,7.8958,,S
31,0,1,"Uruchurtu, Don. Manuel E",male,40,0,0,PC 17601,27.7208,,C
32,1,1,"Spencer, Mrs. William Augustus (Marie Eugenie)",female,,1,0,PC 17569,146.5208,B78,C
33,1,3,"Glynn, Miss. Mary Agatha",female,,0,0,335677,7.75,,Q
34,0,2,"Wheadon, Mr. Edward H",male,66,0,0,C.A. 24579,10.5,,S
35,0,1,"Meyer, Mr. Edgar Joseph",male,28,1,0,PC 17604,82.1708,,C
36,0,1,"Holverson, Mr. Alexander Oskar",male,42,1,0,113789,52,,S
37,1,3,"Mamee, Mr. Hanna",male,,0,0,2677,7.2292,,C
38,0,3,"Cann, Mr. Ernest Charles",male,21,0,0,A./5. 2152,8.05,,S
39,0,3,"Vander Planke, Miss. Augusta Maria",female,18,2,0,345764,18,,S
40,1,3,"Nicola-Yarred, Miss. Jamila",female,14,1,0,2651,11.2417,,C
41,0,3,"Ahlin, Mrs. Johan (Johanna Persdotter Larsson)",female,40,1,0,7546,9.475,,S
42,0,2,"Turpin, Mrs. William John Robert (Dorothy Ann Wonnacott)",female,27,1,0,11668,21,,S
43,0,3,"Kraeff, Mr. Theodor",male,,0,0,349253,7.8958,,C
44,1,2,"Laroche, Miss. Simonne Marie Anne Andree",female,3,1,2,SC/Paris 2123,41.5792,,C
45,1,3,"Devaney, Miss. Margaret Delia",female,19,0,0,330958,7.8792,,Q
46,0,3,"Rogers, Mr. William John",male,,0,0,S.C./A.4. 23567,8.05,,S
47,0,3,"Lennon, Mr. Denis",male,,1,0,370371,15.5,,Q
48,1,3,"O'Driscoll, Miss. Bridget",female,,0,0,14311,7.75,,Q
49,0,3,"Samaan, Mr. Youssef",male,,2,0,2662,21.6792,,C
50,0,3,"Arnold-Franchi, Mrs. Josef (Josefine Franchi)",female,18,1,0,349237,17.8,,S
51,0,3,"Panula, Master. Juha Niilo",male,7,4,1,3101295,39.6875,,S
52,0,3,"Nosworthy, Mr. Richard Cater",male,21,0,0,A/4. 39886,7.8,,S
53,1,1,"Harper, Mrs. Henry Sleeper (Myna Haxtun)",female,49,1,0,PC 17572,76.7292,D33,C
54,1,2,"Faunthorpe, Mrs. Lizzie (Elizabeth Anne Wilkinson)",female,29,1,0,2926,26,,S
55,0,1,"Ostby, Mr. Engelhart Cornelius",male,65,0,1,113509,61.9792,B30,C
56,1,1,"Woolner, Mr. Hugh",male,,0,0,19947,35.5,C52,S
57,1,2,"Rugg, Miss. Emily",female,21,0,0,C.A. 31026,10.5,,S
58,0,3,"Novel, Mr. Mansouer",male,28.5,0,0,2697,7.2292,,C
59,1,2,"West, Miss. Constance Mirium",female,5,1,2,C.A. 34651,27.75,,S
60,0,3,"Goodwin, Master. William Frederick",male,11,5,2,CA 2144,46.9,,S
61,0,3,"Sirayanian, Mr. Orsen",male,22,0,0,2669,7.2292,,C
62,1,1,"Icard, Miss. Amelie",female,38,0,0,113572,80,B28,
63,0,1,"Harris, Mr. Henry Birkhardt",male,45,1,0,36973,83.475,C83,S
64,0,3,"Skoog, Master. Harald",male,4,3,2,347088,27.9,,S
65,0,1,"Stewart, Mr. Albert A",male,,0,0,PC 17605,27.7208,,C
66,1,3,"Moubarek, Master. Gerios",male,,1,1,2661,15.2458,,C
67,1,2,"Nye, Mrs. (Elizabeth Ramell)",female,29,0,0,C.A. 29395,10.5,F33,S
68,0,3,"Crease, Mr. Ernest James",male,19,0,0,S.P. 3464,8.1583,,S
69,1,3,"Andersson, Miss. Erna Alexandra",female,17,4,2,3101281,7.925,,S
70,0,3,"Kink, Mr. Vincenz",male,26,2,0,315151,8.6625,,S
71,0,2,"Jenkin, Mr. Stephen Curnow",male,32,0,0,C.A. 33111,10.5,,S
72,0,3,"Goodwin, Miss. Lillian Amy",female,16,5,2,CA 2144,46.9,,S
73,0,2,"Hood, Mr. Ambrose Jr",male,21,0,0,S.O.C. 14879,73.5,,S
74,0,3,"Chronopoulos, Mr. Apostolos",male,26,1,0,2680,14.4542,,C
75,1,3,"Bing, Mr. Lee",male,32,0,0,1601,56.4958,,S
76,0,3,"Moen, Mr. Sigurd Hansen",male,25,0,0,348123,7.65,F G73,S
77,0,3,"Staneff, Mr. Ivan",male,,0,0,349208,7.8958,,S
78,0,3,"Moutal, Mr. Rahamin Haim",male,,0,0,374746,8.05,,S
79,1,2,"Caldwell, Master. Alden Gates",male,0.83,0,2,248738,29,,S
80,1,3,"Dowdell, Miss. Elizabeth",female,30,0,0,364516,12.475,,S
81,0,3,"Waelens, Mr. Achille",male,22,0,0,345767,9,,S
82,1,3,"Sheerlinck, Mr. Jan Baptist",male,29,0,0,345779,9.5,,S
83,1,3,"McDermott, Miss. Brigdet Delia",female,,0,0,330932,7.7875,,Q
84,0,1,"Carrau, Mr. Francisco M",male,28,0,0,113059,47.1,,S
85,1,2,"Ilett, Miss. Bertha",female,17,0,0,SO/C 14885,10.5,,S
86,1,3,"Backstrom, Mrs. Karl Alfred (Maria Mathilda Gustafsson)",female,33,3,0,3101278,15.85,,S
87,0,3,"Ford, Mr. William Neal",male,16,1,3,W./C. 6608,34.375,,S
88,0,3,"Slocovski, Mr. Selman Francis",male,,0,0,SOTON/OQ 392086,8.05,,S
89,1,1,"Fortune, Miss. Mabel Helen",female,23,3,2,19950,263,C23 C25 C27,S
90,0,3,"Celotti, Mr. Francesco",male,24,0,0,343275,8.05,,S
91,0,3,"Christmann, Mr. Emil",male,29,0,0,343276,8.05,,S
92,0,3,"Andreasson, Mr. Paul Edvin",male,20,0,0,347466,7.8542,,S
93,0,1,"Chaffee, Mr. Herbert Fuller",male,46,1,0,W.E.P. 5734,61.175,E31,S
94,0,3,"Dean, Mr. Bertram Frank",male,26,1,2,C.A. 2315,20.575,,S
95,0,3,"Coxon, Mr. Daniel",male,59,0,0,364500,7.25,,S
96,0,3,"Shorney, Mr. Charles Joseph",male,,0,0,374910,8.05,,S
97,0,1,"Goldschmidt, Mr. George B",male,71,0,0,PC 17754,34.6542,A5,C
98,1,1,"Greenfield, Mr. William Bertram",male,23,0,1,PC 17759,63.3583,D10 D12,C
99,1,2,"Doling, Mrs. John T (Ada Julia Bone)",female,34,0,1,231919,23,,S
100,0,2,"Kantor, Mr. Sinai",male,34,1,0,244367,26,,S
101,0,3,"Petranec, Miss. Matilda",female,28,0,0,349245,7.8958,,S
102,0,3,"Petroff, Mr. Pastcho (""Pentcho"")",male,,0,0,349215,7.8958,,S
103,0,1,"White, Mr. Richard Frasar",male,21,0,1,35281,77.2875,D26,S
104,0,3,"Johansson, Mr. Gustaf Joel",male,33,0,0,7540,8.6542,,S
105,0,3,"Gustafsson, Mr. Anders Vilhelm",male,37,2,0,3101276,7.925,,S
106,0,3,"Mionoff, Mr. Stoytcho",male,28,0,0,349207,7.8958,,S
107,1,3,"Salkjelsvik, Miss. Anna Kristine",female,21,0,0,343120,7.65,,S
108,1,3,"Moss, Mr. Albert Johan",male,,0,0,312991,7.775,,S
109,0,3,"Rekic, Mr. Tido",male,38,0,0,349249,7.8958,,S
110,1,3,"Moran, Miss. Bertha",female,,1,0,371110,24.15,,Q
111,0,1,"Porter, Mr. Walter Chamberlain",male,47,0,0,110465,52,C110,S
112,0,3,"Zabour, Miss. Hileni",female,14.5,1,0,2665,14.4542,,C
113,0,3,"Barton, Mr. David John",male,22,0,0,324669,8.05,,S
114,0,3,"Jussila, Miss. Katriina",female,20,1,0,4136,9.825,,S
115,0,3,"Attalah, Miss. Malake",female,17,0,0,2627,14.4583,,C
116,0,3,"Pekoniemi, Mr. Edvard",male,21,0,0,STON/O 2. 3101294,7.925,,S
117,0,3,"Connors, Mr. Patrick",male,70.5,0,0,370369,7.75,,Q
118,0,2,"Turpin, Mr. William John Robert",male,29,1,0,11668,21,,S
119,0,1,"Baxter, Mr. Quigg Edmond",male,24,0,1,PC 17558,247.5208,B58 B60,C
120,0,3,"Andersson, Miss. Ellis Anna Maria",female,2,4,2,347082,31.275,,S
121,0,2,"Hickman, Mr. Stanley George",male,21,2,0,S.O.C. 14879,73.5,,S
122,0,3,"Moore, Mr. Leonard Charles",male,,0,0,A4. 54510,8.05,,S
123,0,2,"Nasser, Mr. Nicholas",male,32.5,1,0,237736,30.0708,,C
124,1,2,"Webber, Miss. Susan",female,32.5,0,0,27267,13,E101,S
125,0,1,"White, Mr. Percival Wayland",male,54,0,1,35281,77.2875,D26,S
126,1,3,"Nicola-Yarred, Master. Elias",male,12,1,0,2651,11.2417,,C
127,0,3,"McMahon, Mr. Martin",male,,0,0,370372,7.75,,Q
128,1,3,"Madsen, Mr. Fridtjof Arne",male,24,0,0,C 17369,7.1417,,S
129,1,3,"Peter, Miss. Anna",female,,1,1,2668,22.3583,F E69,C
130,0,3,"Ekstrom, Mr. Johan",male,45,0,0,347061,6.975,,S
131,0,3,"Drazenoic, Mr. Jozef",male,33,0,0,349241,7.8958,,C
132,0,3,"Coelho, Mr. Domingos Fernandeo",male,20,0,0,SOTON/O.Q. 3101307,7.05,,S
133,0,3,"Robins, Mrs. Alexander A (Grace Charity Laury)",female,47,1,0,A/5. 3337,14.5,,S
134,1,2,"Weisz, Mrs. Leopold (Mathilde Francoise Pede)",female,29,1,0,228414,26,,S
135,0,2,"Sobey, Mr. Samuel James Hayden",male,25,0,0,C.A. 29178,13,,S
136,0,2,"Richard, Mr. Emile",male,23,0,0,SC/PARIS 2133,15.0458,,C
137,1,1,"Newsom, Miss. Helen Monypeny",female,19,0,2,11752,26.2833,D47,S
138,0,1,"Futrelle, Mr. Jacques Heath",male,37,1,0,113803,53.1,C123,S
139,0,3,"Osen, Mr. Olaf Elon",male,16,0,0,7534,9.2167,,S
140,0,1,"Giglio, Mr. Victor",male,24,0,0,PC 17593,79.2,B86,C
141,0,3,"Boulos, Mrs. Joseph (Sultana)",female,,0,2,2678,15.2458,,C
142,1,3,"Nysten, Miss. Anna Sofia",female,22,0,0,347081,7.75,,S
143,1,3,"Hakkarainen, Mrs. Pekka Pietari (Elin Matilda Dolck)",female,24,1,0,STON/O2. 3101279,15.85,,S
144,0,3,"Burke, Mr. Jeremiah",male,19,0,0,365222,6.75,,Q
145,0,2,"Andrew, Mr. Edgardo Samuel",male,18,0,0,231945,11.5,,S
146,0,2,"Nicholls, Mr. Joseph Charles",male,19,1,1,C.A. 33112,36.75,,S
147,1,3,"Andersson, Mr. August Edvard (""Wennerstrom"")",male,27,0,0,350043,7.7958,,S
148,0,3,"Ford, Miss. Robina Maggie ""Ruby""",female,9,2,2,W./C. 6608,34.375,,S
149,0,2,"Navratil, Mr. Michel (""Louis M Hoffman"")",male,36.5,0,2,230080,26,F2,S
150,0,2,"Byles, Rev. Thomas Roussel Davids",male,42,0,0,244310,13,,S
151,0,2,"Bateman, Rev. Robert James",male,51,0,0,S.O.P. 1166,12.525,,S
152,1,1,"Pears, Mrs. Thomas (Edith Wearne)",female,22,1,0,113776,66.6,C2,S
153,0,3,"Meo, Mr. Alfonzo",male,55.5,0,0,A.5. 11206,8.05,,S
154,0,3,"van Billiard, Mr. Austin Blyler",male,40.5,0,2,A/5. 851,14.5,,S
155,0,3,"Olsen, Mr. Ole Martin",male,,0,0,Fa 265302,7.3125,,S
156,0,1,"Williams, Mr. Charles Duane",male,51,0,1,PC 17597,61.3792,,C
157,1,3,"Gilnagh, Miss. Katherine ""Katie""",female,16,0,0,35851,7.7333,,Q
158,0,3,"Corn, Mr. Harry",male,30,0,0,SOTON/OQ 392090,8.05,,S
159,0,3,"Smiljanic, Mr. Mile",male,,0,0,315037,8.6625,,S
160,0,3,"Sage, Master. Thomas Henry",male,,8,2,CA. 2343,69.55,,S
161,0,3,"Cribb, Mr. John Hatfield",male,44,0,1,371362,16.1,,S
162,1,2,"Watt, Mrs. James (Elizabeth ""Bessie"" Inglis Milne)",female,40,0,0,C.A. 33595,15.75,,S
163,0,3,"Bengtsson, Mr. John Viktor",male,26,0,0,347068,7.775,,S
164,0,3,"Calic, Mr. Jovo",male,17,0,0,315093,8.6625,,S
165,0,3,"Panula, Master. Eino Viljami",male,1,4,1,3101295,39.6875,,S
166,1,3,"Goldsmith, Master. Frank John William ""Frankie""",male,9,0,2,363291,20.525,,S
167,1,1,"Chibnall, Mrs. (Edith Martha Bowerman)",female,,0,1,113505,55,E33,S
168,0,3,"Skoog, Mrs. William (Anna Bernhardina Karlsson)",female,45,1,4,347088,27.9,,S
169,0,1,"Baumann, Mr. John D",male,,0,0,PC 17318,25.925,,S
170,0,3,"Ling, Mr. Lee",male,28,0,0,1601,56.4958,,S
171,0,1,"Van der hoef, Mr. Wyckoff",male,61,0,0,111240,33.5,B19,S
172,0,3,"Rice, Master. Arthur",male,4,4,1,382652,29.125,,Q
173,1,3,"Johnson, Miss. Eleanor Ileen",female,1,1,1,347742,11.1333,,S
174,0,3,"Sivola, Mr. Antti Wilhelm",male,21,0,0,STON/O 2. 3101280,7.925,,S
175,0,1,"Smith, Mr. James Clinch",male,56,0,0,17764,30.6958,A7,C
176,0,3,"Klasen, Mr. Klas Albin",male,18,1,1,350404,7.8542,,S
177,0,3,"Lefebre, Master. Henry Forbes",male,,3,1,4133,25.4667,,S
178,0,1,"Isham, Miss. Ann Elizabeth",female,50,0,0,PC 17595,28.7125,C49,C
179,0,2,"Hale, Mr. Reginald",male,30,0,0,250653,13,,S
180,0,3,"Leonard, Mr. Lionel",male,36,0,0,LINE,0,,S
181,0,3,"Sage, Miss. Constance Gladys",female,,8,2,CA. 2343,69.55,,S
182,0,2,"Pernot, Mr. Rene",male,,0,0,SC/PARIS 2131,15.05,,C
183,0,3,"Asplund, Master. Clarence Gustaf Hugo",male,9,4,2,347077,31.3875,,S
184,1,2,"Becker, Master. Richard F",male,1,2,1,230136,39,F4,S
185,1,3,"Kink-Heilmann, Miss. Luise Gretchen",female,4,0,2,315153,22.025,,S
186,0,1,"Rood, Mr. Hugh Roscoe",male,,0,0,113767,50,A32,S
187,1,3,"O'Brien, Mrs. Thomas (Johanna ""Hannah"" Godfrey)",female,,1,0,370365,15.5,,Q
188,1,1,"Romaine, Mr. Charles Hallace (""Mr C Rolmane"")",male,45,0,0,111428,26.55,,S
189,0,3,"Bourke, Mr. John",male,40,1,1,364849,15.5,,Q
190,0,3,"Turcin, Mr. Stjepan",male,36,0,0,349247,7.8958,,S
191,1,2,"Pinsky, Mrs. (Rosa)",female,32,0,0,234604,13,,S
192,0,2,"Carbines, Mr. William",male,19,0,0,28424,13,,S
193,1,3,"Andersen-Jensen, Miss. Carla Christine Nielsine",female,19,1,0,350046,7.8542,,S
194,1,2,"Navratil, Master. Michel M",male,3,1,1,230080,26,F2,S
195,1,1,"Brown, Mrs. James Joseph (Margaret Tobin)",female,44,0,0,PC 17610,27.7208,B4,C
196,1,1,"Lurette, Miss. Elise",female,58,0,0,PC 17569,146.5208,B80,C
197,0,3,"Mernagh, Mr. Robert",male,,0,0,368703,7.75,,Q
198,0,3,"Olsen, Mr. Karl Siegwart Andreas",male,42,0,1,4579,8.4042,,S
199,1,3,"Madigan, Miss. Margaret ""Maggie""",female,,0,0,370370,7.75,,Q
200,0,2,"Yrois, Miss. Henriette (""Mrs Harbeck"")",female,24,0,0,248747,13,,S
201,0,3,"Vande Walle, Mr. Nestor Cyriel",male,28,0,0,345770,9.5,,S
202,0,3,"Sage, Mr. Frederick",male,,8,2,CA. 2343,69.55,,S
203,0,3,"Johanson, Mr. Jakob Alfred",male,34,0,0,3101264,6.4958,,S
204,0,3,"Youseff, Mr. Gerious",male,45.5,0,0,2628,7.225,,C
205,1,3,"Cohen, Mr. Gurshon ""Gus""",male,18,0,0,A/5 3540,8.05,,S
206,0,3,"Strom, Miss. Telma Matilda",female,2,0,1,347054,10.4625,G6,S
207,0,3,"Backstrom, Mr. Karl Alfred",male,32,1,0,3101278,15.85,,S
208,1,3,"Albimona, Mr. Nassef Cassem",male,26,0,0,2699,18.7875,,C
209,1,3,"Carr, Miss. Helen ""Ellen""",female,16,0,0,367231,7.75,,Q
210,1,1,"Blank, Mr. Henry",male,40,0,0,112277,31,A31,C
211,0,3,"Ali, Mr. Ahmed",male,24,0,0,SOTON/O.Q. 3101311,7.05,,S
212,1,2,"Cameron, Miss. Clear Annie",female,35,0,0,F.C.C. 13528,21,,S
213,0,3,"Perkin, Mr. John Henry",male,22,0,0,A/5 21174,7.25,,S
214,0,2,"Givard, Mr. Hans Kristensen",male,30,0,0,250646,13,,S
215,0,3,"Kiernan, Mr. Philip",male,,1,0,367229,7.75,,Q
216,1,1,"Newell, Miss. Madeleine",female,31,1,0,35273,113.275,D36,C
217,1,3,"Honkanen, Miss. Eliina",female,27,0,0,STON/O2. 3101283,7.925,,S
218,0,2,"Jacobsohn, Mr. Sidney Samuel",male,42,1,0,243847,27,,S
219,1,1,"Bazzani, Miss. Albina",female,32,0,0,11813,76.2917,D15,C
220,0,2,"Harris, Mr. Walter",male,30,0,0,W/C 14208,10.5,,S
221,1,3,"Sunderland, Mr. Victor Francis",male,16,0,0,SOTON/OQ 392089,8.05,,S
222,0,2,"Bracken, Mr. James H",male,27,0,0,220367,13,,S
223,0,3,"Green, Mr. George Henry",male,51,0,0,21440,8.05,,S
224,0,3,"Nenkoff, Mr. Christo",male,,0,0,349234,7.8958,,S
225,1,1,"Hoyt, Mr. Frederick Maxfield",male,38,1,0,19943,90,C93,S
226,0,3,"Berglund, Mr. Karl Ivar Sven",male,22,0,0,PP 4348,9.35,,S
227,1,2,"Mellors, Mr. William John",male,19,0,0,SW/PP 751,10.5,,S
228,0,3,"Lovell, Mr. John Hall (""Henry"")",male,20.5,0,0,A/5 21173,7.25,,S
229,0,2,"Fahlstrom, Mr. Arne Jonas",male,18,0,0,236171,13,,S
230,0,3,"Lefebre, Miss. Mathilde",female,,3,1,4133,25.4667,,S
231,1,1,"Harris, Mrs. Henry Birkhardt (Irene Wallach)",female,35,1,0,36973,83.475,C83,S
232,0,3,"Larsson, Mr. Bengt Edvin",male,29,0,0,347067,7.775,,S
233,0,2,"Sjostedt, Mr. Ernst Adolf",male,59,0,0,237442,13.5,,S
234,1,3,"Asplund, Miss. Lillian Gertrud",female,5,4,2,347077,31.3875,,S
235,0,2,"Leyson, Mr. Robert William Norman",male,24,0,0,C.A. 29566,10.5,,S
236,0,3,"Harknett, Miss. Alice Phoebe",female,,0,0,W./C. 6609,7.55,,S
237,0,2,"Hold, Mr. Stephen",male,44,1,0,26707,26,,S
238,1,2,"Collyer, Miss. Marjorie ""Lottie""",female,8,0,2,C.A. 31921,26.25,,S
239,0,2,"Pengelly, Mr. Frederick William",male,19,0,0,28665,10.5,,S
240,0,2,"Hunt, Mr. George Henry",male,33,0,0,SCO/W 1585,12.275,,S
241,0,3,"Zabour, Miss. Thamine",female,,1,0,2665,14.4542,,C
242,1,3,"Murphy, Miss. Katherine ""Kate""",female,,1,0,367230,15.5,,Q
243,0,2,"Coleridge, Mr. Reginald Charles",male,29,0,0,W./C. 14263,10.5,,S
244,0,3,"Maenpaa, Mr. Matti Alexanteri",male,22,0,0,STON/O 2. 3101275,7.125,,S
245,0,3,"Attalah, Mr. Sleiman",male,30,0,0,2694,7.225,,C
246,0,1,"Minahan, Dr. William Edward",male,44,2,0,19928,90,C78,Q
247,0,3,"Lindahl, Miss. Agda Thorilda Viktoria",female,25,0,0,347071,7.775,,S
248,1,2,"Hamalainen, Mrs. William (Anna)",female,24,0,2,250649,14.5,,S
249,1,1,"Beckwith, Mr. Richard Leonard",male,37,1,1,11751,52.5542,D35,S
250,0,2,"Carter, Rev. Ernest Courtenay",male,54,1,0,244252,26,,S
251,0,3,"Reed, Mr. James George",male,,0,0,362316,7.25,,S
252,0,3,"Strom, Mrs. Wilhelm (Elna Matilda Persson)",female,29,1,1,347054,10.4625,G6,S
253,0,1,"Stead, Mr. William Thomas",male,62,0,0,113514,26.55,C87,S
254,0,3,"Lobb, Mr. William Arthur",male,30,1,0,A/5. 3336,16.1,,S
255,0,3,"Rosblom, Mrs. Viktor (Helena Wilhelmina)",female,41,0,2,370129,20.2125,,S
256,1,3,"Touma, Mrs. Darwis (Hanne Youssef Razi)",female,29,0,2,2650,15.2458,,C
257,1,1,"Thorne, Mrs. Gertrude Maybelle",female,,0,0,PC 17585,79.2,,C
258,1,1,"Cherry, Miss. Gladys",female,30,0,0,110152,86.5,B77,S
259,1,1,"Ward, Miss. Anna",female,35,0,0,PC 17755,512.3292,,C
260,1,2,"Parrish, Mrs. (Lutie Davis)",female,50,0,1,230433,26,,S
261,0,3,"Smith, Mr. Thomas",male,,0,0,384461,7.75,,Q
262,1,3,"Asplund, Master. Edvin Rojj Felix",male,3,4,2,347077,31.3875,,S
263,0,1,"Taussig, Mr. Emil",male,52,1,1,110413,79.65,E67,S
264,0,1,"Harrison, Mr. William",male,40,0,0,112059,0,B94,S
265,0,3,"Henry, Miss. Delia",female,,0,0,382649,7.75,,Q
266,0,2,"Reeves, Mr. David",male,36,0,0,C.A. 17248,10.5,,S
267,0,3,"Panula, Mr. Ernesti Arvid",male,16,4,1,3101295,39.6875,,S
268,1,3,"Persson, Mr. Ernst Ulrik",male,25,1,0,347083,7.775,,S
269,1,1,"Graham, Mrs. William Thompson (Edith Junkins)",female,58,0,1,PC 17582,153.4625,C125,S
270,1,1,"Bissette, Miss. Amelia",female,35,0,0,PC 17760,135.6333,C99,S
271,0,1,"Cairns, Mr. Alexander",male,,0,0,113798,31,,S
272,1,3,"Tornquist, Mr. William Henry",male,25,0,0,LINE,0,,S
273,1,2,"Mellinger, Mrs. (Elizabeth Anne Maidment)",female,41,0,1,250644,19.5,,S
274,0,1,"Natsch, Mr. Charles H",male,37,0,1,PC 17596,29.7,C118,C
275,1,3,"Healy, Miss. Hanora ""Nora""",female,,0,0,370375,7.75,,Q
276,1,1,"Andrews, Miss. Kornelia Theodosia",female,63,1,0,13502,77.9583,D7,S
277,0,3,"Lindblom, Miss. Augusta Charlotta",female,45,0,0,347073,7.75,,S
278,0,2,"Parkes, Mr. Francis ""Frank""",male,,0,0,239853,0,,S
279,0,3,"Rice, Master. Eric",male,7,4,1,382652,29.125,,Q
280,1,3,"Abbott, Mrs. Stanton (Rosa Hunt)",female,35,1,1,C.A. 2673,20.25,,S
281,0,3,"Duane, Mr. Frank",male,65,0,0,336439,7.75,,Q
282,0,3,"Olsson, Mr. Nils Johan Goransson",male,28,0,0,347464,7.8542,,S
283,0,3,"de Pelsmaeker, Mr. Alfons",male,16,0,0,345778,9.5,,S
284,1,3,"Dorking, Mr. Edward Arthur",male,19,0,0,A/5. 10482,8.05,,S
285,0,1,"Smith, Mr. Richard William",male,,0,0,113056,26,A19,S
286,0,3,"Stankovic, Mr. Ivan",male,33,0,0,349239,8.6625,,C
287,1,3,"de Mulder, Mr. Theodore",male,30,0,0,345774,9.5,,S
288,0,3,"Naidenoff, Mr. Penko",male,22,0,0,349206,7.8958,,S
289,1,2,"Hosono, Mr. Masabumi",male,42,0,0,237798,13,,S
290,1,3,"Connolly, Miss. Kate",female,22,0,0,370373,7.75,,Q
291,1,1,"Barber, Miss. Ellen ""Nellie""",female,26,0,0,19877,78.85,,S
292,1,1,"Bishop, Mrs. Dickinson H (Helen Walton)",female,19,1,0,11967,91.0792,B49,C
293,0,2,"Levy, Mr. Rene Jacques",male,36,0,0,SC/Paris 2163,12.875,D,C
294,0,3,"Haas, Miss. Aloisia",female,24,0,0,349236,8.85,,S
295,0,3,"Mineff, Mr. Ivan",male,24,0,0,349233,7.8958,,S
296,0,1,"Lewy, Mr. Ervin G",male,,0,0,PC 17612,27.7208,,C
297,0,3,"Hanna, Mr. Mansour",male,23.5,0,0,2693,7.2292,,C
298,0,1,"Allison, Miss. Helen Loraine",female,2,1,2,113781,151.55,C22 C26,S
299,1,1,"Saalfeld, Mr. Adolphe",male,,0,0,19988,30.5,C106,S
300,1,1,"Baxter, Mrs. James (Helene DeLaudeniere Chaput)",female,50,0,1,PC 17558,247.5208,B58 B60,C
301,1,3,"Kelly, Miss. Anna Katherine ""Annie Kate""",female,,0,0,9234,7.75,,Q
302,1,3,"McCoy, Mr. Bernard",male,,2,0,367226,23.25,,Q
303,0,3,"Johnson, Mr. William Cahoone Jr",male,19,0,0,LINE,0,,S
304,1,2,"Keane, Miss. Nora A",female,,0,0,226593,12.35,E101,Q
305,0,3,"Williams, Mr. Howard Hugh ""Harry""",male,,0,0,A/5 2466,8.05,,S
306,1,1,"Allison, Master. Hudson Trevor",male,0.92,1,2,113781,151.55,C22 C26,S
307,1,1,"Fleming, Miss. Margaret",female,,0,0,17421,110.8833,,C
308,1,1,"Penasco y Castellana, Mrs. Victor de Satode (Maria Josefa Perez de Soto y Vallejo)",female,17,1,0,PC 17758,108.9,C65,C
309,0,2,"Abelson, Mr. Samuel",male,30,1,0,P/PP 3381,24,,C
310,1,1,"Francatelli, Miss. Laura Mabel",female,30,0,0,PC 17485,56.9292,E36,C
311,1,1,"Hays, Miss. Margaret Bechstein",female,24,0,0,11767,83.1583,C54,C
312,1,1,"Ryerson, Miss. Emily Borie",female,18,2,2,PC 17608,262.375,B57 B59 B63 B66,C
313,0,2,"Lahtinen, Mrs. William (Anna Sylfven)",female,26,1,1,250651,26,,S
314,0,3,"Hendekovic, Mr. Ignjac",male,28,0,0,349243,7.8958,,S
315,0,2,"Hart, Mr. Benjamin",male,43,1,1,F.C.C. 13529,26.25,,S
316,1,3,"Nilsson, Miss. Helmina Josefina",female,26,0,0,347470,7.8542,,S
317,1,2,"Kantor, Mrs. Sinai (Miriam Sternin)",female,24,1,0,244367,26,,S
318,0,2,"Moraweck, Dr. Ernest",male,54,0,0,29011,14,,S
319,1,1,"Wick, Miss. Mary Natalie",female,31,0,2,36928,164.8667,C7,S
320,1,1,"Spedden, Mrs. Frederic Oakley (Margaretta Corning Stone)",female,40,1,1,16966,134.5,E34,C
321,0,3,"Dennis, Mr. Samuel",male,22,0,0,A/5 21172,7.25,,S
322,0,3,"Danoff, Mr. Yoto",male,27,0,0,349219,7.8958,,S
323,1,2,"Slayter, Miss. Hilda Mary",female,30,0,0,234818,12.35,,Q
324,1,2,"Caldwell, Mrs. Albert Francis (Sylvia Mae Harbaugh)",female,22,1,1,248738,29,,S
325,0,3,"Sage, Mr. George John Jr",male,,8,2,CA. 2343,69.55,,S
326,1,1,"Young, Miss. Marie Grice",female,36,0,0,PC 17760,135.6333,C32,C
327,0,3,"Nysveen, Mr. Johan Hansen",male,61,0,0,345364,6.2375,,S
328,1,2,"Ball, Mrs. (Ada E Hall)",female,36,0,0,28551,13,D,S
329,1,3,"Goldsmith, Mrs. Frank John (Emily Alice Brown)",female,31,1,1,363291,20.525,,S
330,1,1,"Hippach, Miss. Jean Gertrude",female,16,0,1,111361,57.9792,B18,C
331,1,3,"McCoy, Miss. Agnes",female,,2,0,367226,23.25,,Q
332,0,1,"Partner, Mr. Austen",male,45.5,0,0,113043,28.5,C124,S
333,0,1,"Graham, Mr. George Edward",male,38,0,1,PC 17582,153.4625,C91,S
334,0,3,"Vander Planke, Mr. Leo Edmondus",male,16,2,0,345764,18,,S
335,1,1,"Frauenthal, Mrs. Henry William (Clara Heinsheimer)",female,,1,0,PC 17611,133.65,,S
336,0,3,"Denkoff, Mr. Mitto",male,,0,0,349225,7.8958,,S
337,0,1,"Pears, Mr. Thomas Clinton",male,29,1,0,113776,66.6,C2,S
338,1,1,"Burns, Miss. Elizabeth Margaret",female,41,0,0,16966,134.5,E40,C
339,1,3,"Dahl, Mr. Karl Edwart",male,45,0,0,7598,8.05,,S
340,0,1,"Blackwell, Mr. Stephen Weart",male,45,0,0,113784,35.5,T,S
341,1,2,"Navratil, Master. Edmond Roger",male,2,1,1,230080,26,F2,S
342,1,1,"Fortune, Miss. Alice Elizabeth",female,24,3,2,19950,263,C23 C25 C27,S
343,0,2,"Collander, Mr. Erik Gustaf",male,28,0,0,248740,13,,S
344,0,2,"Sedgwick, Mr. Charles Frederick Waddington",male,25,0,0,244361,13,,S
345,0,2,"Fox, Mr. Stanley Hubert",male,36,0,0,229236,13,,S
346,1,2,"Brown, Miss. Amelia ""Mildred""",female,24,0,0,248733,13,F33,S
347,1,2,"Smith, Miss. Marion Elsie",female,40,0,0,31418,13,,S
348,1,3,"Davison, Mrs. Thomas Henry (Mary E Finck)",female,,1,0,386525,16.1,,S
349,1,3,"Coutts, Master. William Loch ""William""",male,3,1,1,C.A. 37671,15.9,,S
350,0,3,"Dimic, Mr. Jovan",male,42,0,0,315088,8.6625,,S
351,0,3,"Odahl, Mr. Nils Martin",male,23,0,0,7267,9.225,,S
352,0,1,"Williams-Lambert, Mr. Fletcher Fellows",male,,0,0,113510,35,C128,S
353,0,3,"Elias, Mr. Tannous",male,15,1,1,2695,7.2292,,C
354,0,3,"Arnold-Franchi, Mr. Josef",male,25,1,0,349237,17.8,,S
355,0,3,"Yousif, Mr. Wazli",male,,0,0,2647,7.225,,C
356,0,3,"Vanden Steen, Mr. Leo Peter",male,28,0,0,345783,9.5,,S
357,1,1,"Bowerman, Miss. Elsie Edith",female,22,0,1,113505,55,E33,S
358,0,2,"Funk, Miss. Annie Clemmer",female,38,0,0,237671,13,,S
359,1,3,"McGovern, Miss. Mary",female,,0,0,330931,7.8792,,Q
360,1,3,"Mockler, Miss. Helen Mary ""Ellie""",female,,0,0,330980,7.8792,,Q
361,0,3,"Skoog, Mr. Wilhelm",male,40,1,4,347088,27.9,,S
362,0,2,"del Carlo, Mr. Sebastiano",male,29,1,0,SC/PARIS 2167,27.7208,,C
363,0,3,"Barbara, Mrs. (Catherine David)",female,45,0,1,2691,14.4542,,C
364,0,3,"Asim, Mr. Adola",male,35,0,0,SOTON/O.Q. 3101310,7.05,,S
365,0,3,"O'Brien, Mr. Thomas",male,,1,0,370365,15.5,,Q
366,0,3,"Adahl, Mr. Mauritz Nils Martin",male,30,0,0,C 7076,7.25,,S
367,1,1,"Warren, Mrs. Frank Manley (Anna Sophia Atkinson)",female,60,1,0,110813,75.25,D37,C
368,1,3,"Moussa, Mrs. (Mantoura Boulos)",female,,0,0,2626,7.2292,,C
369,1,3,"Jermyn, Miss. Annie",female,,0,0,14313,7.75,,Q
370,1,1,"Aubart, Mme. Leontine Pauline",female,24,0,0,PC 17477,69.3,B35,C
371,1,1,"Harder, Mr. George Achilles",male,25,1,0,11765,55.4417,E50,C
372,0,3,"Wiklund, Mr. Jakob Alfred",male,18,1,0,3101267,6.4958,,S
373,0,3,"Beavan, Mr. William Thomas",male,19,0,0,323951,8.05,,S
374,0,1,"Ringhini, Mr. Sante",male,22,0,0,PC 17760,135.6333,,C
375,0,3,"Palsson, Miss. Stina Viola",female,3,3,1,349909,21.075,,S
376,1,1,"Meyer, Mrs. Edgar Joseph (Leila Saks)",female,,1,0,PC 17604,82.1708,,C
377,1,3,"Landergren, Miss. Aurora Adelia",female,22,0,0,C 7077,7.25,,S
378,0,1,"Widener, Mr. Harry Elkins",male,27,0,2,113503,211.5,C82,C
379,0,3,"Betros, Mr. Tannous",male,20,0,0,2648,4.0125,,C
380,0,3,"Gustafsson, Mr. Karl Gideon",male,19,0,0,347069,7.775,,S
381,1,1,"Bidois, Miss. Rosalie",female,42,0,0,PC 17757,227.525,,C
382,1,3,"Nakid, Miss. Maria (""Mary"")",female,1,0,2,2653,15.7417,,C
383,0,3,"Tikkanen, Mr. Juho",male,32,0,0,STON/O 2. 3101293,7.925,,S
384,1,1,"Holverson, Mrs. Alexander Oskar (Mary Aline Towner)",female,35,1,0,113789,52,,S
385,0,3,"Plotcharsky, Mr. Vasil",male,,0,0,349227,7.8958,,S
386,0,2,"Davies, Mr. Charles Henry",male,18,0,0,S.O.C. 14879,73.5,,S
387,0,3,"Goodwin, Master. Sidney Leonard",male,1,5,2,CA 2144,46.9,,S
388,1,2,"Buss, Miss. Kate",female,36,0,0,27849,13,,S
389,0,3,"Sadlier, Mr. Matthew",male,,0,0,367655,7.7292,,Q
390,1,2,"Lehmann, Miss. Bertha",female,17,0,0,SC 1748,12,,C
391,1,1,"Carter, Mr. William Ernest",male,36,1,2,113760,120,B96 B98,S
392,1,3,"Jansson, Mr. Carl Olof",male,21,0,0,350034,7.7958,,S
393,0,3,"Gustafsson, Mr. Johan Birger",male,28,2,0,3101277,7.925,,S
394,1,1,"Newell, Miss. Marjorie",female,23,1,0,35273,113.275,D36,C
395,1,3,"Sandstrom, Mrs. Hjalmar (Agnes Charlotta Bengtsson)",female,24,0,2,PP 9549,16.7,G6,S
396,0,3,"Johansson, Mr. Erik",male,22,0,0,350052,7.7958,,S
397,0,3,"Olsson, Miss. Elina",female,31,0,0,350407,7.8542,,S
398,0,2,"McKane, Mr. Peter David",male,46,0,0,28403,26,,S
399,0,2,"Pain, Dr. Alfred",male,23,0,0,244278,10.5,,S
400,1,2,"Trout, Mrs. William H (Jessie L)",female,28,0,0,240929,12.65,,S
401,1,3,"Niskanen, Mr. Juha",male,39,0,0,STON/O 2. 3101289,7.925,,S
402,0,3,"Adams, Mr. John",male,26,0,0,341826,8.05,,S
403,0,3,"Jussila, Miss. Mari Aina",female,21,1,0,4137,9.825,,S
404,0,3,"Hakkarainen, Mr. Pekka Pietari",male,28,1,0,STON/O2. 3101279,15.85,,S
405,0,3,"Oreskovic, Miss. Marija",female,20,0,0,315096,8.6625,,S
406,0,2,"Gale, Mr. Shadrach",male,34,1,0,28664,21,,S
407,0,3,"Widegren, Mr. Carl/Charles Peter",male,51,0,0,347064,7.75,,S
408,1,2,"Richards, Master. William Rowe",male,3,1,1,29106,18.75,,S
409,0,3,"Birkeland, Mr. Hans Martin Monsen",male,21,0,0,312992,7.775,,S
410,0,3,"Lefebre, Miss. Ida",female,,3,1,4133,25.4667,,S
411,0,3,"Sdycoff, Mr. Todor",male,,0,0,349222,7.8958,,S
412,0,3,"Hart, Mr. Henry",male,,0,0,394140,6.8583,,Q
413,1,1,"Minahan, Miss. Daisy E",female,33,1,0,19928,90,C78,Q
414,0,2,"Cunningham, Mr. Alfred Fleming",male,,0,0,239853,0,,S
415,1,3,"Sundman, Mr. Johan Julian",male,44,0,0,STON/O 2. 3101269,7.925,,S
416,0,3,"Meek, Mrs. Thomas (Annie Louise Rowley)",female,,0,0,343095,8.05,,S
417,1,2,"Drew, Mrs. James Vivian (Lulu Thorne Christian)",female,34,1,1,28220,32.5,,S
418,1,2,"Silven, Miss. Lyyli Karoliina",female,18,0,2,250652,13,,S
419,0,2,"Matthews, Mr. William John",male,30,0,0,28228,13,,S
420,0,3,"Van Impe, Miss. Catharina",female,10,0,2,345773,24.15,,S
421,0,3,"Gheorgheff, Mr. Stanio",male,,0,0,349254,7.8958,,C
422,0,3,"Charters, Mr. David",male,21,0,0,A/5. 13032,7.7333,,Q
423,0,3,"Zimmerman, Mr. Leo",male,29,0,0,315082,7.875,,S
424,0,3,"Danbom, Mrs. Ernst Gilbert (Anna Sigrid Maria Brogren)",female,28,1,1,347080,14.4,,S
425,0,3,"Rosblom, Mr. Viktor Richard",male,18,1,1,370129,20.2125,,S
426,0,3,"Wiseman, Mr. Phillippe",male,,0,0,A/4. 34244,7.25,,S
427,1,2,"Clarke, Mrs. Charles V (Ada Maria Winfield)",female,28,1,0,2003,26,,S
428,1,2,"Phillips, Miss. Kate Florence (""Mrs Kate Louise Phillips Marshall"")",female,19,0,0,250655,26,,S
429,0,3,"Flynn, Mr. James",male,,0,0,364851,7.75,,Q
430,1,3,"Pickard, Mr. Berk (Berk Trembisky)",male,32,0,0,SOTON/O.Q. 392078,8.05,E10,S
431,1,1,"Bjornstrom-Steffansson, Mr. Mauritz Hakan",male,28,0,0,110564,26.55,C52,S
432,1,3,"Thorneycroft, Mrs. Percival (Florence Kate White)",female,,1,0,376564,16.1,,S
433,1,2,"Louch, Mrs. Charles Alexander (Alice Adelaide Slow)",female,42,1,0,SC/AH 3085,26,,S
434,0,3,"Kallio, Mr. Nikolai Erland",male,17,0,0,STON/O 2. 3101274,7.125,,S
435,0,1,"Silvey, Mr. William Baird",male,50,1,0,13507,55.9,E44,S
436,1,1,"Carter, Miss. Lucile Polk",female,14,1,2,113760,120,B96 B98,S
437,0,3,"Ford, Miss. Doolina Margaret ""Daisy""",female,21,2,2,W./C. 6608,34.375,,S
438,1,2,"Richards, Mrs. Sidney (Emily Hocking)",female,24,2,3,29106,18.75,,S
439,0,1,"Fortune, Mr. Mark",male,64,1,4,19950,263,C23 C25 C27,S
440,0,2,"Kvillner, Mr. Johan Henrik Johannesson",male,31,0,0,C.A. 18723,10.5,,S
441,1,2,"Hart, Mrs. Benjamin (Esther Ada Bloomfield)",female,45,1,1,F.C.C. 13529,26.25,,S
442,0,3,"Hampe, Mr. Leon",male,20,0,0,345769,9.5,,S
443,0,3,"Petterson, Mr. Johan Emil",male,25,1,0,347076,7.775,,S
444,1,2,"Reynaldo, Ms. Encarnacion",female,28,0,0,230434,13,,S
445,1,3,"Johannesen-Bratthammer, Mr. Bernt",male,,0,0,65306,8.1125,,S
446,1,1,"Dodge, Master. Washington",male,4,0,2,33638,81.8583,A34,S
447,1,2,"Mellinger, Miss. Madeleine Violet",female,13,0,1,250644,19.5,,S
448,1,1,"Seward, Mr. Frederic Kimber",male,34,0,0,113794,26.55,,S
449,1,3,"Baclini, Miss. Marie Catherine",female,5,2,1,2666,19.2583,,C
450,1,1,"Peuchen, Major. Arthur Godfrey",male,52,0,0,113786,30.5,C104,S
451,0,2,"West, Mr. Edwy Arthur",male,36,1,2,C.A. 34651,27.75,,S
452,0,3,"Hagland, Mr. Ingvald Olai Olsen",male,,1,0,65303,19.9667,,S
453,0,1,"Foreman, Mr. Benjamin Laventall",male,30,0,0,113051,27.75,C111,C
454,1,1,"Goldenberg, Mr. Samuel L",male,49,1,0,17453,89.1042,C92,C
455,0,3,"Peduzzi, Mr. Joseph",male,,0,0,A/5 2817,8.05,,S
456,1,3,"Jalsevac, Mr. Ivan",male,29,0,0,349240,7.8958,,C
457,0,1,"Millet, Mr. Francis Davis",male,65,0,0,13509,26.55,E38,S
458,1,1,"Kenyon, Mrs. Frederick R (Marion)",female,,1,0,17464,51.8625,D21,S
459,1,2,"Toomey, Miss. Ellen",female,50,0,0,F.C.C. 13531,10.5,,S
460,0,3,"O'Connor, Mr. Maurice",male,,0,0,371060,7.75,,Q
461,1,1,"Anderson, Mr. Harry",male,48,0,0,19952,26.55,E12,S
462,0,3,"Morley, Mr. William",male,34,0,0,364506,8.05,,S
463,0,1,"Gee, Mr. Arthur H",male,47,0,0,111320,38.5,E63,S
464,0,2,"Milling, Mr. Jacob Christian",male,48,0,0,234360,13,,S
465,0,3,"Maisner, Mr. Simon",male,,0,0,A/S 2816,8.05,,S
466,0,3,"Goncalves, Mr. Manuel Estanslas",male,38,0,0,SOTON/O.Q. 3101306,7.05,,S
467,0,2,"Campbell, Mr. William",male,,0,0,239853,0,,S
468,0,1,"Smart, Mr. John Montgomery",male,56,0,0,113792,26.55,,S
469,0,3,"Scanlan, Mr. James",male,,0,0,36209,7.725,,Q
470,1,3,"Baclini, Miss. Helene Barbara",female,0.75,2,1,2666,19.2583,,C
471,0,3,"Keefe, Mr. Arthur",male,,0,0,323592,7.25,,S
472,0,3,"Cacic, Mr. Luka",male,38,0,0,315089,8.6625,,S
473,1,2,"West, Mrs. Edwy Arthur (Ada Mary Worth)",female,33,1,2,C.A. 34651,27.75,,S
474,1,2,"Jerwan, Mrs. Amin S (Marie Marthe Thuillard)",female,23,0,0,SC/AH Basle 541,13.7917,D,C
475,0,3,"Strandberg, Miss. Ida Sofia",female,22,0,0,7553,9.8375,,S
476,0,1,"Clifford, Mr. George Quincy",male,,0,0,110465,52,A14,S
477,0,2,"Renouf, Mr. Peter Henry",male,34,1,0,31027,21,,S
478,0,3,"Braund, Mr. Lewis Richard",male,29,1,0,3460,7.0458,,S
479,0,3,"Karlsson, Mr. Nils August",male,22,0,0,350060,7.5208,,S
480,1,3,"Hirvonen, Miss. Hildur E",female,2,0,1,3101298,12.2875,,S
481,0,3,"Goodwin, Master. Harold Victor",male,9,5,2,CA 2144,46.9,,S
482,0,2,"Frost, Mr. Anthony Wood ""Archie""",male,,0,0,239854,0,,S
483,0,3,"Rouse, Mr. Richard Henry",male,50,0,0,A/5 3594,8.05,,S
484,1,3,"Turkula, Mrs. (Hedwig)",female,63,0,0,4134,9.5875,,S
485,1,1,"Bishop, Mr. Dickinson H",male,25,1,0,11967,91.0792,B49,C
486,0,3,"Lefebre, Miss. Jeannie",female,,3,1,4133,25.4667,,S
487,1,1,"Hoyt, Mrs. Frederick Maxfield (Jane Anne Forby)",female,35,1,0,19943,90,C93,S
488,0,1,"Kent, Mr. Edward Austin",male,58,0,0,11771,29.7,B37,C
489,0,3,"Somerton, Mr. Francis William",male,30,0,0,A.5. 18509,8.05,,S
490,1,3,"Coutts, Master. Eden Leslie ""Neville""",male,9,1,1,C.A. 37671,15.9,,S
491,0,3,"Hagland, Mr. Konrad Mathias Reiersen",male,,1,0,65304,19.9667,,S
492,0,3,"Windelov, Mr. Einar",male,21,0,0,SOTON/OQ 3101317,7.25,,S
493,0,1,"Molson, Mr. Harry Markland",male,55,0,0,113787,30.5,C30,S
494,0,1,"Artagaveytia, Mr. Ramon",male,71,0,0,PC 17609,49.5042,,C
495,0,3,"Stanley, Mr. Edward Roland",male,21,0,0,A/4 45380,8.05,,S
496,0,3,"Yousseff, Mr. Gerious",male,,0,0,2627,14.4583,,C
497,1,1,"Eustis, Miss. Elizabeth Mussey",female,54,1,0,36947,78.2667,D20,C
498,0,3,"Shellard, Mr. Frederick William",male,,0,0,C.A. 6212,15.1,,S
499,0,1,"Allison, Mrs. Hudson J C (Bessie Waldo Daniels)",female,25,1,2,113781,151.55,C22 C26,S
500,0,3,"Svensson, Mr. Olof",male,24,0,0,350035,7.7958,,S
501,0,3,"Calic, Mr. Petar",male,17,0,0,315086,8.6625,,S
502,0,3,"Canavan, Miss. Mary",female,21,0,0,364846,7.75,,Q
503,0,3,"O'Sullivan, Miss. Bridget Mary",female,,0,0,330909,7.6292,,Q
504,0,3,"Laitinen, Miss. Kristina Sofia",female,37,0,0,4135,9.5875,,S
505,1,1,"Maioni, Miss. Roberta",female,16,0,0,110152,86.5,B79,S
506,0,1,"Penasco y Castellana, Mr. Victor de Satode",male,18,1,0,PC 17758,108.9,C65,C
507,1,2,"Quick, Mrs. Frederick Charles (Jane Richards)",female,33,0,2,26360,26,,S
508,1,1,"Bradley, Mr. George (""George Arthur Brayton"")",male,,0,0,111427,26.55,,S
509,0,3,"Olsen, Mr. Henry Margido",male,28,0,0,C 4001,22.525,,S
510,1,3,"Lang, Mr. Fang",male,26,0,0,1601,56.4958,,S
511,1,3,"Daly, Mr. Eugene Patrick",male,29,0,0,382651,7.75,,Q
512,0,3,"Webber, Mr. James",male,,0,0,SOTON/OQ 3101316,8.05,,S
513,1,1,"McGough, Mr. James Robert",male,36,0,0,PC 17473,26.2875,E25,S
514,1,1,"Rothschild, Mrs. Martin (Elizabeth L. Barrett)",female,54,1,0,PC 17603,59.4,,C
515,0,3,"Coleff, Mr. Satio",male,24,0,0,349209,7.4958,,S
516,0,1,"Walker, Mr. William Anderson",male,47,0,0,36967,34.0208,D46,S
517,1,2,"Lemore, Mrs. (Amelia Milley)",female,34,0,0,C.A. 34260,10.5,F33,S
518,0,3,"Ryan, Mr. Patrick",male,,0,0,371110,24.15,,Q
519,1,2,"Angle, Mrs. William A (Florence ""Mary"" Agnes Hughes)",female,36,1,0,226875,26,,S
520,0,3,"Pavlovic, Mr. Stefo",male,32,0,0,349242,7.8958,,S
521,1,1,"Perreault, Miss. Anne",female,30,0,0,12749,93.5,B73,S
522,0,3,"Vovk, Mr. Janko",male,22,0,0,349252,7.8958,,S
523,0,3,"Lahoud, Mr. Sarkis",male,,0,0,2624,7.225,,C
524,1,1,"Hippach, Mrs. Louis Albert (Ida Sophia Fischer)",female,44,0,1,111361,57.9792,B18,C
525,0,3,"Kassem, Mr. Fared",male,,0,0,2700,7.2292,,C
526,0,3,"Farrell, Mr. James",male,40.5,0,0,367232,7.75,,Q
527,1,2,"Ridsdale, Miss. Lucy",female,50,0,0,W./C. 14258,10.5,,S
528,0,1,"Farthing, Mr. John",male,,0,0,PC 17483,221.7792,C95,S
529,0,3,"Salonen, Mr. Johan Werner",male,39,0,0,3101296,7.925,,S
530,0,2,"Hocking, Mr. Richard George",male,23,2,1,29104,11.5,,S
531,1,2,"Quick, Miss. Phyllis May",female,2,1,1,26360,26,,S
532,0,3,"Toufik, Mr. Nakli",male,,0,0,2641,7.2292,,C
533,0,3,"Elias, Mr. Joseph Jr",male,17,1,1,2690,7.2292,,C
534,1,3,"Peter, Mrs. Catherine (Catherine Rizk)",female,,0,2,2668,22.3583,,C
535,0,3,"Cacic, Miss. Marija",female,30,0,0,315084,8.6625,,S
536,1,2,"Hart, Miss. Eva Miriam",female,7,0,2,F.C.C. 13529,26.25,,S
537,0,1,"Butt, Major. Archibald Willingham",male,45,0,0,113050,26.55,B38,S
538,1,1,"LeRoy, Miss. Bertha",female,30,0,0,PC 17761,106.425,,C
539,0,3,"Risien, Mr. Samuel Beard",male,,0,0,364498,14.5,,S
540,1,1,"Frolicher, Miss. Hedwig Margaritha",female,22,0,2,13568,49.5,B39,C
541,1,1,"Crosby, Miss. Harriet R",female,36,0,2,WE/P 5735,71,B22,S
542,0,3,"Andersson, Miss. Ingeborg Constanzia",female,9,4,2,347082,31.275,,S
543,0,3,"Andersson, Miss. Sigrid Elisabeth",female,11,4,2,347082,31.275,,S
544,1,2,"Beane, Mr. Edward",male,32,1,0,2908,26,,S
545,0,1,"Douglas, Mr. Walter Donald",male,50,1,0,PC 17761,106.425,C86,C
546,0,1,"Nicholson, Mr. Arthur Ernest",male,64,0,0,693,26,,S
547,1,2,"Beane, Mrs. Edward (Ethel Clarke)",female,19,1,0,2908,26,,S
548,1,2,"Padro y Manent, Mr. Julian",male,,0,0,SC/PARIS 2146,13.8625,,C
549,0,3,"Goldsmith, Mr. Frank John",male,33,1,1,363291,20.525,,S
550,1,2,"Davies, Master. John Morgan Jr",male,8,1,1,C.A. 33112,36.75,,S
551,1,1,"Thayer, Mr. John Borland Jr",male,17,0,2,17421,110.8833,C70,C
552,0,2,"Sharp, Mr. Percival James R",male,27,0,0,244358,26,,S
553,0,3,"O'Brien, Mr. Timothy",male,,0,0,330979,7.8292,,Q
554,1,3,"Leeni, Mr. Fahim (""Philip Zenni"")",male,22,0,0,2620,7.225,,C
555,1,3,"Ohman, Miss. Velin",female,22,0,0,347085,7.775,,S
556,0,1,"Wright, Mr. George",male,62,0,0,113807,26.55,,S
557,1,1,"Duff Gordon, Lady. (Lucille Christiana Sutherland) (""Mrs Morgan"")",female,48,1,0,11755,39.6,A16,C
558,0,1,"Robbins, Mr. Victor",male,,0,0,PC 17757,227.525,,C
559,1,1,"Taussig, Mrs. Emil (Tillie Mandelbaum)",female,39,1,1,110413,79.65,E67,S
560,1,3,"de Messemaeker, Mrs. Guillaume Joseph (Emma)",female,36,1,0,345572,17.4,,S
561,0,3,"Morrow, Mr. Thomas Rowan",male,,0,0,372622,7.75,,Q
562,0,3,"Sivic, Mr. Husein",male,40,0,0,349251,7.8958,,S
563,0,2,"Norman, Mr. Robert Douglas",male,28,0,0,218629,13.5,,S
564,0,3,"Simmons, Mr. John",male,,0,0,SOTON/OQ 392082,8.05,,S
565,0,3,"Meanwell, Miss. (Marion Ogden)",female,,0,0,SOTON/O.Q. 392087,8.05,,S
566,0,3,"Davies, Mr. Alfred J",male,24,2,0,A/4 48871,24.15,,S
567,0,3,"Stoytcheff, Mr. Ilia",male,19,0,0,349205,7.8958,,S
568,0,3,"Palsson, Mrs. Nils (Alma Cornelia Berglund)",female,29,0,4,349909,21.075,,S
569,0,3,"Doharr, Mr. Tannous",male,,0,0,2686,7.2292,,C
570,1,3,"Jonsson, Mr. Carl",male,32,0,0,350417,7.8542,,S
571,1,2,"Harris, Mr. George",male,62,0,0,S.W./PP 752,10.5,,S
572,1,1,"Appleton, Mrs. Edward Dale (Charlotte Lamson)",female,53,2,0,11769,51.4792,C101,S
573,1,1,"Flynn, Mr. John Irwin (""Irving"")",male,36,0,0,PC 17474,26.3875,E25,S
574,1,3,"Kelly, Miss. Mary",female,,0,0,14312,7.75,,Q
575,0,3,"Rush, Mr. Alfred George John",male,16,0,0,A/4. 20589,8.05,,S
576,0,3,"Patchett, Mr. George",male,19,0,0,358585,14.5,,S
577,1,2,"Garside, Miss. Ethel",female,34,0,0,243880,13,,S
578,1,1,"Silvey, Mrs. William Baird (Alice Munger)",female,39,1,0,13507,55.9,E44,S
579,0,3,"Caram, Mrs. Joseph (Maria Elias)",female,,1,0,2689,14.4583,,C
580,1,3,"Jussila, Mr. Eiriik",male,32,0,0,STON/O 2. 3101286,7.925,,S
581,1,2,"Christy, Miss. Julie Rachel",female,25,1,1,237789,30,,S
582,1,1,"Thayer, Mrs. John Borland (Marian Longstreth Morris)",female,39,1,1,17421,110.8833,C68,C
583,0,2,"Downton, Mr. William James",male,54,0,0,28403,26,,S
584,0,1,"Ross, Mr. John Hugo",male,36,0,0,13049,40.125,A10,C
585,0,3,"Paulner, Mr. Uscher",male,,0,0,3411,8.7125,,C
586,1,1,"Taussig, Miss. Ruth",female,18,0,2,110413,79.65,E68,S
587,0,2,"Jarvis, Mr. John Denzil",male,47,0,0,237565,15,,S
588,1,1,"Frolicher-Stehli, Mr. Maxmillian",male,60,1,1,13567,79.2,B41,C
589,0,3,"Gilinski, Mr. Eliezer",male,22,0,0,14973,8.05,,S
590,0,3,"Murdlin, Mr. Joseph",male,,0,0,A./5. 3235,8.05,,S
591,0,3,"Rintamaki, Mr. Matti",male,35,0,0,STON/O 2. 3101273,7.125,,S
592,1,1,"Stephenson, Mrs. Walter Bertram (Martha Eustis)",female,52,1,0,36947,78.2667,D20,C
593,0,3,"Elsbury, Mr. William James",male,47,0,0,A/5 3902,7.25,,S
594,0,3,"Bourke, Miss. Mary",female,,0,2,364848,7.75,,Q
595,0,2,"Chapman, Mr. John Henry",male,37,1,0,SC/AH 29037,26,,S
596,0,3,"Van Impe, Mr. Jean Baptiste",male,36,1,1,345773,24.15,,S
597,1,2,"Leitch, Miss. Jessie Wills",female,,0,0,248727,33,,S
598,0,3,"Johnson, Mr. Alfred",male,49,0,0,LINE,0,,S
599,0,3,"Boulos, Mr. Hanna",male,,0,0,2664,7.225,,C
600,1,1,"Duff Gordon, Sir. Cosmo Edmund (""Mr Morgan"")",male,49,1,0,PC 17485,56.9292,A20,C
601,1,2,"Jacobsohn, Mrs. Sidney Samuel (Amy Frances Christy)",female,24,2,1,243847,27,,S
602,0,3,"Slabenoff, Mr. Petco",male,,0,0,349214,7.8958,,S
603,0,1,"Harrington, Mr. Charles H",male,,0,0,113796,42.4,,S
604,0,3,"Torber, Mr. Ernst William",male,44,0,0,364511,8.05,,S
605,1,1,"Homer, Mr. Harry (""Mr E Haven"")",male,35,0,0,111426,26.55,,C
606,0,3,"Lindell, Mr. Edvard Bengtsson",male,36,1,0,349910,15.55,,S
607,0,3,"Karaic, Mr. Milan",male,30,0,0,349246,7.8958,,S
608,1,1,"Daniel, Mr. Robert Williams",male,27,0,0,113804,30.5,,S
609,1,2,"Laroche, Mrs. Joseph (Juliette Marie Louise Lafargue)",female,22,1,2,SC/Paris 2123,41.5792,,C
610,1,1,"Shutes, Miss. Elizabeth W",female,40,0,0,PC 17582,153.4625,C125,S
611,0,3,"Andersson, Mrs. Anders Johan (Alfrida Konstantia Brogren)",female,39,1,5,347082,31.275,,S
612,0,3,"Jardin, Mr. Jose Neto",male,,0,0,SOTON/O.Q. 3101305,7.05,,S
613,1,3,"Murphy, Miss. Margaret Jane",female,,1,0,367230,15.5,,Q
614,0,3,"Horgan, Mr. John",male,,0,0,370377,7.75,,Q
615,0,3,"Brocklebank, Mr. William Alfred",male,35,0,0,364512,8.05,,S
616,1,2,"Herman, Miss. Alice",female,24,1,2,220845,65,,S
617,0,3,"Danbom, Mr. Ernst Gilbert",male,34,1,1,347080,14.4,,S
618,0,3,"Lobb, Mrs. William Arthur (Cordelia K Stanlick)",female,26,1,0,A/5. 3336,16.1,,S
619,1,2,"Becker, Miss. Marion Louise",female,4,2,1,230136,39,F4,S
620,0,2,"Gavey, Mr. Lawrence",male,26,0,0,31028,10.5,,S
621,0,3,"Yasbeck, Mr. Antoni",male,27,1,0,2659,14.4542,,C
622,1,1,"Kimball, Mr. Edwin Nelson Jr",male,42,1,0,11753,52.5542,D19,S
623,1,3,"Nakid, Mr. Sahid",male,20,1,1,2653,15.7417,,C
624,0,3,"Hansen, Mr. Henry Damsgaard",male,21,0,0,350029,7.8542,,S
625,0,3,"Bowen, Mr. David John ""Dai""",male,21,0,0,54636,16.1,,S
626,0,1,"Sutton, Mr. Frederick",male,61,0,0,36963,32.3208,D50,S
627,0,2,"Kirkland, Rev. Charles Leonard",male,57,0,0,219533,12.35,,Q
628,1,1,"Longley, Miss. Gretchen Fiske",female,21,0,0,13502,77.9583,D9,S
629,0,3,"Bostandyeff, Mr. Guentcho",male,26,0,0,349224,7.8958,,S
630,0,3,"O'Connell, Mr. Patrick D",male,,0,0,334912,7.7333,,Q
631,1,1,"Barkworth, Mr. Algernon Henry Wilson",male,80,0,0,27042,30,A23,S
632,0,3,"Lundahl, Mr. Johan Svensson",male,51,0,0,347743,7.0542,,S
633,1,1,"Stahelin-Maeglin, Dr. Max",male,32,0,0,13214,30.5,B50,C
634,0,1,"Parr, Mr. William Henry Marsh",male,,0,0,112052,0,,S
635,0,3,"Skoog, Miss. Mabel",female,9,3,2,347088,27.9,,S
636,1,2,"Davis, Miss. Mary",female,28,0,0,237668,13,,S
637,0,3,"Leinonen, Mr. Antti Gustaf",male,32,0,0,STON/O 2. 3101292,7.925,,S
638,0,2,"Collyer, Mr. Harvey",male,31,1,1,C.A. 31921,26.25,,S
639,0,3,"Panula, Mrs. Juha (Maria Emilia Ojala)",female,41,0,5,3101295,39.6875,,S
640,0,3,"Thorneycroft, Mr. Percival",male,,1,0,376564,16.1,,S
641,0,3,"Jensen, Mr. Hans Peder",male,20,0,0,350050,7.8542,,S
642,1,1,"Sagesser, Mlle. Emma",female,24,0,0,PC 17477,69.3,B35,C
643,0,3,"Skoog, Miss. Margit Elizabeth",female,2,3,2,347088,27.9,,S
644,1,3,"Foo, Mr. Choong",male,,0,0,1601,56.4958,,S
645,1,3,"Baclini, Miss. Eugenie",female,0.75,2,1,2666,19.2583,,C
646,1,1,"Harper, Mr. Henry Sleeper",male,48,1,0,PC 17572,76.7292,D33,C
647,0,3,"Cor, Mr. Liudevit",male,19,0,0,349231,7.8958,,S
648,1,1,"Simonius-Blumer, Col. Oberst Alfons",male,56,0,0,13213,35.5,A26,C
649,0,3,"Willey, Mr. Edward",male,,0,0,S.O./P.P. 751,7.55,,S
650,1,3,"Stanley, Miss. Amy Zillah Elsie",female,23,0,0,CA. 2314,7.55,,S
651,0,3,"Mitkoff, Mr. Mito",male,,0,0,349221,7.8958,,S
652,1,2,"Doling, Miss. Elsie",female,18,0,1,231919,23,,S
653,0,3,"Kalvik, Mr. Johannes Halvorsen",male,21,0,0,8475,8.4333,,S
654,1,3,"O'Leary, Miss. Hanora ""Norah""",female,,0,0,330919,7.8292,,Q
655,0,3,"Hegarty, Miss. Hanora ""Nora""",female,18,0,0,365226,6.75,,Q
656,0,2,"Hickman, Mr. Leonard Mark",male,24,2,0,S.O.C. 14879,73.5,,S
657,0,3,"Radeff, Mr. Alexander",male,,0,0,349223,7.8958,,S
658,0,3,"Bourke, Mrs. John (Catherine)",female,32,1,1,364849,15.5,,Q
659,0,2,"Eitemiller, Mr. George Floyd",male,23,0,0,29751,13,,S
660,0,1,"Newell, Mr. Arthur Webster",male,58,0,2,35273,113.275,D48,C
661,1,1,"Frauenthal, Dr. Henry William",male,50,2,0,PC 17611,133.65,,S
662,0,3,"Badt, Mr. Mohamed",male,40,0,0,2623,7.225,,C
663,0,1,"Colley, Mr. Edward Pomeroy",male,47,0,0,5727,25.5875,E58,S
664,0,3,"Coleff, Mr. Peju",male,36,0,0,349210,7.4958,,S
665,1,3,"Lindqvist, Mr. Eino William",male,20,1,0,STON/O 2. 3101285,7.925,,S
666,0,2,"Hickman, Mr. Lewis",male,32,2,0,S.O.C. 14879,73.5,,S
667,0,2,"Butler, Mr. Reginald Fenton",male,25,0,0,234686,13,,S
668,0,3,"Rommetvedt, Mr. Knud Paust",male,,0,0,312993,7.775,,S
669,0,3,"Cook, Mr. Jacob",male,43,0,0,A/5 3536,8.05,,S
670,1,1,"Taylor, Mrs. Elmer Zebley (Juliet Cummins Wright)",female,,1,0,19996,52,C126,S
671,1,2,"Brown, Mrs. Thomas William Solomon (Elizabeth Catherine Ford)",female,40,1,1,29750,39,,S
672,0,1,"Davidson, Mr. Thornton",male,31,1,0,F.C. 12750,52,B71,S
673,0,2,"Mitchell, Mr. Henry Michael",male,70,0,0,C.A. 24580,10.5,,S
674,1,2,"Wilhelms, Mr. Charles",male,31,0,0,244270,13,,S
675,0,2,"Watson, Mr. Ennis Hastings",male,,0,0,239856,0,,S
676,0,3,"Edvardsson, Mr. Gustaf Hjalmar",male,18,0,0,349912,7.775,,S
677,0,3,"Sawyer, Mr. Frederick Charles",male,24.5,0,0,342826,8.05,,S
678,1,3,"Turja, Miss. Anna Sofia",female,18,0,0,4138,9.8417,,S
679,0,3,"Goodwin, Mrs. Frederick (Augusta Tyler)",female,43,1,6,CA 2144,46.9,,S
680,1,1,"Cardeza, Mr. Thomas Drake Martinez",male,36,0,1,PC 17755,512.3292,B51 B53 B55,C
681,0,3,"Peters, Miss. Katie",female,,0,0,330935,8.1375,,Q
682,1,1,"Hassab, Mr. Hammad",male,27,0,0,PC 17572,76.7292,D49,C
683,0,3,"Olsvigen, Mr. Thor Anderson",male,20,0,0,6563,9.225,,S
684,0,3,"Goodwin, Mr. Charles Edward",male,14,5,2,CA 2144,46.9,,S
685,0,2,"Brown, Mr. Thomas William Solomon",male,60,1,1,29750,39,,S
686,0,2,"Laroche, Mr. Joseph Philippe Lemercier",male,25,1,2,SC/Paris 2123,41.5792,,C
687,0,3,"Panula, Mr. Jaako Arnold",male,14,4,1,3101295,39.6875,,S
688,0,3,"Dakic, Mr. Branko",male,19,0,0,349228,10.1708,,S
689,0,3,"Fischer, Mr. Eberhard Thelander",male,18,0,0,350036,7.7958,,S
690,1,1,"Madill, Miss. Georgette Alexandra",female,15,0,1,24160,211.3375,B5,S
691,1,1,"Dick, Mr. Albert Adrian",male,31,1,0,17474,57,B20,S
692,1,3,"Karun, Miss. Manca",female,4,0,1,349256,13.4167,,C
693,1,3,"Lam, Mr. Ali",male,,0,0,1601,56.4958,,S
694,0,3,"Saad, Mr. Khalil",male,25,0,0,2672,7.225,,C
695,0,1,"Weir, Col. John",male,60,0,0,113800,26.55,,S
696,0,2,"Chapman, Mr. Charles Henry",male,52,0,0,248731,13.5,,S
697,0,3,"Kelly, Mr. James",male,44,0,0,363592,8.05,,S
698,1,3,"Mullens, Miss. Katherine ""Katie""",female,,0,0,35852,7.7333,,Q
699,0,1,"Thayer, Mr. John Borland",male,49,1,1,17421,110.8833,C68,C
700,0,3,"Humblen, Mr. Adolf Mathias Nicolai Olsen",male,42,0,0,348121,7.65,F G63,S
701,1,1,"Astor, Mrs. John Jacob (Madeleine Talmadge Force)",female,18,1,0,PC 17757,227.525,C62 C64,C
702,1,1,"Silverthorne, Mr. Spencer Victor",male,35,0,0,PC 17475,26.2875,E24,S
703,0,3,"Barbara, Miss. Saiide",female,18,0,1,2691,14.4542,,C
704,0,3,"Gallagher, Mr. Martin",male,25,0,0,36864,7.7417,,Q
705,0,3,"Hansen, Mr. Henrik Juul",male,26,1,0,350025,7.8542,,S
706,0,2,"Morley, Mr. Henry Samuel (""Mr Henry Marshall"")",male,39,0,0,250655,26,,S
707,1,2,"Kelly, Mrs. Florence ""Fannie""",female,45,0,0,223596,13.5,,S
708,1,1,"Calderhead, Mr. Edward Pennington",male,42,0,0,PC 17476,26.2875,E24,S
709,1,1,"Cleaver, Miss. Alice",female,22,0,0,113781,151.55,,S
710,1,3,"Moubarek, Master. Halim Gonios (""William George"")",male,,1,1,2661,15.2458,,C
711,1,1,"Mayne, Mlle. Berthe Antonine (""Mrs de Villiers"")",female,24,0,0,PC 17482,49.5042,C90,C
712,0,1,"Klaber, Mr. Herman",male,,0,0,113028,26.55,C124,S
713,1,1,"Taylor, Mr. Elmer Zebley",male,48,1,0,19996,52,C126,S
714,0,3,"Larsson, Mr. August Viktor",male,29,0,0,7545,9.4833,,S
715,0,2,"Greenberg, Mr. Samuel",male,52,0,0,250647,13,,S
716,0,3,"Soholt, Mr. Peter Andreas Lauritz Andersen",male,19,0,0,348124,7.65,F G73,S
717,1,1,"Endres, Miss. Caroline Louise",female,38,0,0,PC 17757,227.525,C45,C
718,1,2,"Troutt, Miss. Edwina Celia ""Winnie""",female,27,0,0,34218,10.5,E101,S
719,0,3,"McEvoy, Mr. Michael",male,,0,0,36568,15.5,,Q
720,0,3,"Johnson, Mr. Malkolm Joackim",male,33,0,0,347062,7.775,,S
721,1,2,"Harper, Miss. Annie Jessie ""Nina""",female,6,0,1,248727,33,,S
722,0,3,"Jensen, Mr. Svend Lauritz",male,17,1,0,350048,7.0542,,S
723,0,2,"Gillespie, Mr. William Henry",male,34,0,0,12233,13,,S
724,0,2,"Hodges, Mr. Henry Price",male,50,0,0,250643,13,,S
725,1,1,"Chambers, Mr. Norman Campbell",male,27,1,0,113806,53.1,E8,S
726,0,3,"Oreskovic, Mr. Luka",male,20,0,0,315094,8.6625,,S
727,1,2,"Renouf, Mrs. Peter Henry (Lillian Jefferys)",female,30,3,0,31027,21,,S
728,1,3,"Mannion, Miss. Margareth",female,,0,0,36866,7.7375,,Q
729,0,2,"Bryhl, Mr. Kurt Arnold Gottfrid",male,25,1,0,236853,26,,S
730,0,3,"Ilmakangas, Miss. Pieta Sofia",female,25,1,0,STON/O2. 3101271,7.925,,S
731,1,1,"Allen, Miss. Elisabeth Walton",female,29,0,0,24160,211.3375,B5,S
732,0,3,"Hassan, Mr. Houssein G N",male,11,0,0,2699,18.7875,,C
733,0,2,"Knight, Mr. Robert J",male,,0,0,239855,0,,S
734,0,2,"Berriman, Mr. William John",male,23,0,0,28425,13,,S
735,0,2,"Troupiansky, Mr. Moses Aaron",male,23,0,0,233639,13,,S
736,0,3,"Williams, Mr. Leslie",male,28.5,0,0,54636,16.1,,S
737,0,3,"Ford, Mrs. Edward (Margaret Ann Watson)",female,48,1,3,W./C. 6608,34.375,,S
738,1,1,"Lesurer, Mr. Gustave J",male,35,0,0,PC 17755,512.3292,B101,C
739,0,3,"Ivanoff, Mr. Kanio",male,,0,0,349201,7.8958,,S
740,0,3,"Nankoff, Mr. Minko",male,,0,0,349218,7.8958,,S
741,1,1,"Hawksford, Mr. Walter James",male,,0,0,16988,30,D45,S
742,0,1,"Cavendish, Mr. Tyrell William",male,36,1,0,19877,78.85,C46,S
743,1,1,"Ryerson, Miss. Susan Parker ""Suzette""",female,21,2,2,PC 17608,262.375,B57 B59 B63 B66,C
744,0,3,"McNamee, Mr. Neal",male,24,1,0,376566,16.1,,S
745,1,3,"Stranden, Mr. Juho",male,31,0,0,STON/O 2. 3101288,7.925,,S
746,0,1,"Crosby, Capt. Edward Gifford",male,70,1,1,WE/P 5735,71,B22,S
747,0,3,"Abbott, Mr. Rossmore Edward",male,16,1,1,C.A. 2673,20.25,,S
748,1,2,"Sinkkonen, Miss. Anna",female,30,0,0,250648,13,,S
749,0,1,"Marvin, Mr. Daniel Warner",male,19,1,0,113773,53.1,D30,S
750,0,3,"Connaghton, Mr. Michael",male,31,0,0,335097,7.75,,Q
751,1,2,"Wells, Miss. Joan",female,4,1,1,29103,23,,S
752,1,3,"Moor, Master. Meier",male,6,0,1,392096,12.475,E121,S
753,0,3,"Vande Velde, Mr. Johannes Joseph",male,33,0,0,345780,9.5,,S
754,0,3,"Jonkoff, Mr. Lalio",male,23,0,0,349204,7.8958,,S
755,1,2,"Herman, Mrs. Samuel (Jane Laver)",female,48,1,2,220845,65,,S
756,1,2,"Hamalainen, Master. Viljo",male,0.67,1,1,250649,14.5,,S
757,0,3,"Carlsson, Mr. August Sigfrid",male,28,0,0,350042,7.7958,,S
758,0,2,"Bailey, Mr. Percy Andrew",male,18,0,0,29108,11.5,,S
759,0,3,"Theobald, Mr. Thomas Leonard",male,34,0,0,363294,8.05,,S
760,1,1,"Rothes, the Countess. of (Lucy Noel Martha Dyer-Edwards)",female,33,0,0,110152,86.5,B77,S
761,0,3,"Garfirth, Mr. John",male,,0,0,358585,14.5,,S
762,0,3,"Nirva, Mr. Iisakki Antino Aijo",male,41,0,0,SOTON/O2 3101272,7.125,,S
763,1,3,"Barah, Mr. Hanna Assi",male,20,0,0,2663,7.2292,,C
764,1,1,"Carter, Mrs. William Ernest (Lucile Polk)",female,36,1,2,113760,120,B96 B98,S
765,0,3,"Eklund, Mr. Hans Linus",male,16,0,0,347074,7.775,,S
766,1,1,"Hogeboom, Mrs. John C (Anna Andrews)",female,51,1,0,13502,77.9583,D11,S
767,0,1,"Brewe, Dr. Arthur Jackson",male,,0,0,112379,39.6,,C
768,0,3,"Mangan, Miss. Mary",female,30.5,0,0,364850,7.75,,Q
769,0,3,"Moran, Mr. Daniel J",male,,1,0,371110,24.15,,Q
770,0,3,"Gronnestad, Mr. Daniel Danielsen",male,32,0,0,8471,8.3625,,S
771,0,3,"Lievens, Mr. Rene Aime",male,24,0,0,345781,9.5,,S
772,0,3,"Jensen, Mr. Niels Peder",male,48,0,0,350047,7.8542,,S
773,0,2,"Mack, Mrs. (Mary)",female,57,0,0,S.O./P.P. 3,10.5,E77,S
774,0,3,"Elias, Mr. Dibo",male,,0,0,2674,7.225,,C
775,1,2,"Hocking, Mrs. Elizabeth (Eliza Needs)",female,54,1,3,29105,23,,S
776,0,3,"Myhrman, Mr. Pehr Fabian Oliver Malkolm",male,18,0,0,347078,7.75,,S
777,0,3,"Tobin, Mr. Roger",male,,0,0,383121,7.75,F38,Q
778,1,3,"Emanuel, Miss. Virginia Ethel",female,5,0,0,364516,12.475,,S
779,0,3,"Kilgannon, Mr. Thomas J",male,,0,0,36865,7.7375,,Q
780,1,1,"Robert, Mrs. Edward Scott (Elisabeth Walton McMillan)",female,43,0,1,24160,211.3375,B3,S
781,1,3,"Ayoub, Miss. Banoura",female,13,0,0,2687,7.2292,,C
782,1,1,"Dick, Mrs. Albert Adrian (Vera Gillespie)",female,17,1,0,17474,57,B20,S
783,0,1,"Long, Mr. Milton Clyde",male,29,0,0,113501,30,D6,S
784,0,3,"Johnston, Mr. Andrew G",male,,1,2,W./C. 6607,23.45,,S
785,0,3,"Ali, Mr. William",male,25,0,0,SOTON/O.Q. 3101312,7.05,,S
786,0,3,"Harmer, Mr. Abraham (David Lishin)",male,25,0,0,374887,7.25,,S
787,1,3,"Sjoblom, Miss. Anna Sofia",female,18,0,0,3101265,7.4958,,S
788,0,3,"Rice, Master. George Hugh",male,8,4,1,382652,29.125,,Q
789,1,3,"Dean, Master. Bertram Vere",male,1,1,2,C.A. 2315,20.575,,S
790,0,1,"Guggenheim, Mr. Benjamin",male,46,0,0,PC 17593,79.2,B82 B84,C
791,0,3,"Keane, Mr. Andrew ""Andy""",male,,0,0,12460,7.75,,Q
792,0,2,"Gaskell, Mr. Alfred",male,16,0,0,239865,26,,S
793,0,3,"Sage, Miss. Stella Anna",female,,8,2,CA. 2343,69.55,,S
794,0,1,"Hoyt, Mr. William Fisher",male,,0,0,PC 17600,30.6958,,C
795,0,3,"Dantcheff, Mr. Ristiu",male,25,0,0,349203,7.8958,,S
796,0,2,"Otter, Mr. Richard",male,39,0,0,28213,13,,S
797,1,1,"Leader, Dr. Alice (Farnham)",female,49,0,0,17465,25.9292,D17,S
798,1,3,"Osman, Mrs. Mara",female,31,0,0,349244,8.6833,,S
799,0,3,"Ibrahim Shawah, Mr. Yousseff",male,30,0,0,2685,7.2292,,C
800,0,3,"Van Impe, Mrs. Jean Baptiste (Rosalie Paula Govaert)",female,30,1,1,345773,24.15,,S
801,0,2,"Ponesell, Mr. Martin",male,34,0,0,250647,13,,S
802,1,2,"Collyer, Mrs. Harvey (Charlotte Annie Tate)",female,31,1,1,C.A. 31921,26.25,,S
803,1,1,"Carter, Master. William Thornton II",male,11,1,2,113760,120,B96 B98,S
804,1,3,"Thomas, Master. Assad Alexander",male,0.42,0,1,2625,8.5167,,C
805,1,3,"Hedman, Mr. Oskar Arvid",male,27,0,0,347089,6.975,,S
806,0,3,"Johansson, Mr. Karl Johan",male,31,0,0,347063,7.775,,S
807,0,1,"Andrews, Mr. Thomas Jr",male,39,0,0,112050,0,A36,S
808,0,3,"Pettersson, Miss. Ellen Natalia",female,18,0,0,347087,7.775,,S
809,0,2,"Meyer, Mr. August",male,39,0,0,248723,13,,S
810,1,1,"Chambers, Mrs. Norman Campbell (Bertha Griggs)",female,33,1,0,113806,53.1,E8,S
811,0,3,"Alexander, Mr. William",male,26,0,0,3474,7.8875,,S
812,0,3,"Lester, Mr. James",male,39,0,0,A/4 48871,24.15,,S
813,0,2,"Slemen, Mr. Richard James",male,35,0,0,28206,10.5,,S
814,0,3,"Andersson, Miss. Ebba Iris Alfrida",female,6,4,2,347082,31.275,,S
815,0,3,"Tomlin, Mr. Ernest Portage",male,30.5,0,0,364499,8.05,,S
816,0,1,"Fry, Mr. Richard",male,,0,0,112058,0,B102,S
817,0,3,"Heininen, Miss. Wendla Maria",female,23,0,0,STON/O2. 3101290,7.925,,S
818,0,2,"Mallet, Mr. Albert",male,31,1,1,S.C./PARIS 2079,37.0042,,C
819,0,3,"Holm, Mr. John Fredrik Alexander",male,43,0,0,C 7075,6.45,,S
820,0,3,"Skoog, Master. Karl Thorsten",male,10,3,2,347088,27.9,,S
821,1,1,"Hays, Mrs. Charles Melville (Clara Jennings Gregg)",female,52,1,1,12749,93.5,B69,S
822,1,3,"Lulic, Mr. Nikola",male,27,0,0,315098,8.6625,,S
823,0,1,"Reuchlin, Jonkheer. John George",male,38,0,0,19972,0,,S
824,1,3,"Moor, Mrs. (Beila)",female,27,0,1,392096,12.475,E121,S
825,0,3,"Panula, Master. Urho Abraham",male,2,4,1,3101295,39.6875,,S
826,0,3,"Flynn, Mr. John",male,,0,0,368323,6.95,,Q
827,0,3,"Lam, Mr. Len",male,,0,0,1601,56.4958,,S
828,1,2,"Mallet, Master. Andre",male,1,0,2,S.C./PARIS 2079,37.0042,,C
829,1,3,"McCormack, Mr. Thomas Joseph",male,,0,0,367228,7.75,,Q
830,1,1,"Stone, Mrs. George Nelson (Martha Evelyn)",female,62,0,0,113572,80,B28,
831,1,3,"Yasbeck, Mrs. Antoni (Selini Alexander)",female,15,1,0,2659,14.4542,,C
832,1,2,"Richards, Master. George Sibley",male,0.83,1,1,29106,18.75,,S
833,0,3,"Saad, Mr. Amin",male,,0,0,2671,7.2292,,C
834,0,3,"Augustsson, Mr. Albert",male,23,0,0,347468,7.8542,,S
835,0,3,"Allum, Mr. Owen George",male,18,0,0,2223,8.3,,S
836,1,1,"Compton, Miss. Sara Rebecca",female,39,1,1,PC 17756,83.1583,E49,C
837,0,3,"Pasic, Mr. Jakob",male,21,0,0,315097,8.6625,,S
838,0,3,"Sirota, Mr. Maurice",male,,0,0,392092,8.05,,S
839,1,3,"Chip, Mr. Chang",male,32,0,0,1601,56.4958,,S
840,1,1,"Marechal, Mr. Pierre",male,,0,0,11774,29.7,C47,C
841,0,3,"Alhomaki, Mr. Ilmari Rudolf",male,20,0,0,SOTON/O2 3101287,7.925,,S
842,0,2,"Mudd, Mr. Thomas Charles",male,16,0,0,S.O./P.P. 3,10.5,,S
843,1,1,"Serepeca, Miss. Augusta",female,30,0,0,113798,31,,C
844,0,3,"Lemberopolous, Mr. Peter L",male,34.5,0,0,2683,6.4375,,C
845,0,3,"Culumovic, Mr. Jeso",male,17,0,0,315090,8.6625,,S
846,0,3,"Abbing, Mr. Anthony",male,42,0,0,C.A. 5547,7.55,,S
847,0,3,"Sage, Mr. Douglas Bullen",male,,8,2,CA. 2343,69.55,,S
848,0,3,"Markoff, Mr. Marin",male,35,0,0,349213,7.8958,,C
849,0,2,"Harper, Rev. John",male,28,0,1,248727,33,,S
850,1,1,"Goldenberg, Mrs. Samuel L (Edwiga Grabowska)",female,,1,0,17453,89.1042,C92,C
851,0,3,"Andersson, Master. Sigvard Harald Elias",male,4,4,2,347082,31.275,,S
852,0,3,"Svensson, Mr. Johan",male,74,0,0,347060,7.775,,S
853,0,3,"Boulos, Miss. Nourelain",female,9,1,1,2678,15.2458,,C
854,1,1,"Lines, Miss. Mary Conover",female,16,0,1,PC 17592,39.4,D28,S
855,0,2,"Carter, Mrs. Ernest Courtenay (Lilian Hughes)",female,44,1,0,244252,26,,S
856,1,3,"Aks, Mrs. Sam (Leah Rosen)",female,18,0,1,392091,9.35,,S
857,1,1,"Wick, Mrs. George Dennick (Mary Hitchcock)",female,45,1,1,36928,164.8667,,S
858,1,1,"Daly, Mr. Peter Denis ",male,51,0,0,113055,26.55,E17,S
859,1,3,"Baclini, Mrs. Solomon (Latifa Qurban)",female,24,0,3,2666,19.2583,,C
860,0,3,"Razi, Mr. Raihed",male,,0,0,2629,7.2292,,C
861,0,3,"Hansen, Mr. Claus Peter",male,41,2,0,350026,14.1083,,S
862,0,2,"Giles, Mr. Frederick Edward",male,21,1,0,28134,11.5,,S
863,1,1,"Swift, Mrs. Frederick Joel (Margaret Welles Barron)",female,48,0,0,17466,25.9292,D17,S
864,0,3,"Sage, Miss. Dorothy Edith ""Dolly""",female,,8,2,CA. 2343,69.55,,S
865,0,2,"Gill, Mr. John William",male,24,0,0,233866,13,,S
866,1,2,"Bystrom, Mrs. (Karolina)",female,42,0,0,236852,13,,S
867,1,2,"Duran y More, Miss. Asuncion",female,27,1,0,SC/PARIS 2149,13.8583,,C
868,0,1,"Roebling, Mr. Washington Augustus II",male,31,0,0,PC 17590,50.4958,A24,S
869,0,3,"van Melkebeke, Mr. Philemon",male,,0,0,345777,9.5,,S
870,1,3,"Johnson, Master. Harold Theodor",male,4,1,1,347742,11.1333,,S
871,0,3,"Balkic, Mr. Cerin",male,26,0,0,349248,7.8958,,S
872,1,1,"Beckwith, Mrs. Richard Leonard (Sallie Monypeny)",female,47,1,1,11751,52.5542,D35,S
873,0,1,"Carlsson, Mr. Frans Olof",male,33,0,0,695,5,B51 B53 B55,S
874,0,3,"Vander Cruyssen, Mr. Victor",male,47,0,0,345765,9,,S
875,1,2,"Abelson, Mrs. Samuel (Hannah Wizosky)",female,28,1,0,P/PP 3381,24,,C
876,1,3,"Najib, Miss. Adele Kiamie ""Jane""",female,15,0,0,2667,7.225,,C
877,0,3,"Gustafsson, Mr. Alfred Ossian",male,20,0,0,7534,9.8458,,S
878,0,3,"Petroff, Mr. Nedelio",male,19,0,0,349212,7.8958,,S
879,0,3,"Laleff, Mr. Kristo",male,,0,0,349217,7.8958,,S
880,1,1,"Potter, Mrs. Thomas Jr (Lily Alexenia Wilson)",female,56,0,1,11767,83.1583,C50,C
881,1,2,"Shelley, Mrs. William (Imanita Parrish Hall)",female,25,0,1,230433,26,,S
882,0,3,"Markun, Mr. Johann",male,33,0,0,349257,7.8958,,S
883,0,3,"Dahlberg, Miss. Gerda Ulrika",female,22,0,0,7552,10.5167,,S
884,0,2,"Banfield, Mr. Frederick James",male,28,0,0,C.A./SOTON 34068,10.5,,S
885,0,3,"Sutehall, Mr. Henry Jr",male,25,0,0,SOTON/OQ 392076,7.05,,S
886,0,3,"Rice, Mrs. William (Margaret Norton)",female,39,0,5,382652,29.125,,Q
887,0,2,"Montvila, Rev. Juozas",male,27,0,0,211536,13,,S
888,1,1,"Graham, Miss. Margaret Edith",female,19,0,0,112053,30,B42,S
889,0,3,"Johnston, Miss. Catherine Helen ""Carrie""",female,,1,2,W./C. 6607,23.45,,S
890,1,1,"Behr, Mr. Karl Howell",male,26,0,0,111369,30,C148,C
891,0,3,"Dooley, Mr. Patrick",male,32,0,0,370376,7.75,,Q
</script>
</body>
</html>
